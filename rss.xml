<?xml version="1.0" encoding="UTF-8"?><rss xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:content="http://purl.org/rss/1.0/modules/content/" xmlns:atom="http://www.w3.org/2005/Atom" version="2.0"><channel><title><![CDATA[Spatial Paralysis]]></title><description><![CDATA[Spatial Paralysis]]></description><link>https://spatialparalysis.xyz/</link><generator>RSS for Node</generator><lastBuildDate>Mon, 10 Dec 2018 09:41:20 GMT</lastBuildDate><item><title><![CDATA[GIS StackExchange Improvement Tip #1]]></title><description><![CDATA[A quick tip to improve your experience with  GIS StackExchange , or any StackExchange site for that matter. “Watched Tags” and “Ignored Tags…]]></description><link>https://spatialparalysis.xyz//gis-se-improvement-tip-1/</link><guid isPermaLink="false">https://spatialparalysis.xyz//gis-se-improvement-tip-1/</guid><pubDate>Mon, 10 Dec 2018 18:04:00 GMT</pubDate><content:encoded>&lt;p&gt;A quick tip to improve your experience with &lt;a href=&quot;https://gis.stackexchange.com/&quot;&gt;GIS StackExchange&lt;/a&gt;, or any StackExchange site for that matter.&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://meta.stackexchange.com/questions/32919/ignore-tags-using-wild-card&quot;&gt;&lt;strong&gt;“Watched Tags” and “Ignored Tags” accept wildcards&lt;/strong&gt;&lt;/a&gt;. I like GIS.SE, but unless you tweak it, there’s a lot of noise and not enough signal. One way to improve that is to add things you’re interested in to your &lt;em&gt;Watched Tags&lt;/em&gt;, and conversely those things you are disinterested in to your &lt;em&gt;Ignored Tags&lt;/em&gt;.&lt;/p&gt;
&lt;p&gt;I personally don’t use ArcGIS, or related Esri- or Microsoft-ecosystem tools. So for me, I can’t offer any advice on how to do anything with them. Yet there’s a lot of people in the spatial community who do use Esri products. I had set up my filters with a very long list of exclusion rules using specific tags, e.g. &lt;code class=&quot;language-text&quot;&gt;arcgis-10.4&lt;/code&gt;, &lt;code class=&quot;language-text&quot;&gt;arcgis-10.5&lt;/code&gt;, &lt;code class=&quot;language-text&quot;&gt;esri&lt;/code&gt;, &lt;code class=&quot;language-text&quot;&gt;esri-company&lt;/code&gt;, &lt;code class=&quot;language-text&quot;&gt;arcgis-online&lt;/code&gt;, &lt;code class=&quot;language-text&quot;&gt;arcpy&lt;/code&gt;, etc. This filtered out a lot of questions I was not interested in reading, however it’s very verbose since there are a lot of &lt;code class=&quot;language-text&quot;&gt;arc*&lt;/code&gt; questions. It is also unwieldy because everytime there’s a new ArcGIS major or minor version release, there are a series of new tags created.&lt;/p&gt;
&lt;p&gt;To get around this, you can simply use wildcards in your tags. Now my Ignored Tags are simply &lt;code class=&quot;language-text&quot;&gt;.net&lt;/code&gt;, &lt;code class=&quot;language-text&quot;&gt;arc*&lt;/code&gt;, &lt;code class=&quot;language-text&quot;&gt;esri*&lt;/code&gt;, &lt;code class=&quot;language-text&quot;&gt;modelbuilder&lt;/code&gt;, &lt;code class=&quot;language-text&quot;&gt;oracle&lt;/code&gt;, &lt;code class=&quot;language-text&quot;&gt;sql-server*&lt;/code&gt;. I gave my Watched Tags a similar treatment (e.g. &lt;code class=&quot;language-text&quot;&gt;qgis*&lt;/code&gt;). Now I have a nice looking set of questions and should not need to revisit my tags as often.&lt;/p&gt;
&lt;p&gt;
  &lt;figure class=&quot;gatsby-resp-image-figure&quot; style=&quot;&quot;&gt;
  
  &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/95c261579c9f5e480262a01b7756d6bf/dd270/Screenshot from 2018-12-10 18-14-26.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
  
  &lt;span
    class=&quot;gatsby-resp-image-wrapper&quot;
    style=&quot;position: relative; display: block;  max-width: 590px; margin-left: auto; margin-right: auto;&quot;
  &gt;
    &lt;span
      class=&quot;gatsby-resp-image-background-image&quot;
      style=&quot;padding-bottom: 67.41140215716487%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAsSAAALEgHS3X78AAACR0lEQVQ4y1WT604bMRCF87AQCjRAepHgJfpEfYP+BiohiiqhZLO79vpu7yZwesaBqPz4NHuxzxnPjGfni8+YL5ZYLL/g+80Nvl1f4yuReHF1iaPjIxzNhWMcn5xg/onw/fR0jsXlGc7Oz3GxXHLtFa4YZ655hNENOtWg7ddou1WNxrTIQROFsThMUyAJMXtobxA8v2eDcXQojC9TBDBhprl5oJhWLbpug/XqGapvKZKQU+DiiBQ9jKMon++fV/jx8xceV38xugd480DTPyjhkQYas+g0kteIRATeSTXGKmjMgKdVD2sNGdDrges3UPoWvbpjvIMzd9hmhVlJFikMzMIcMpIYgifuLfpqIP+EsWSMsYVStxS7R3K/Ufw9toUZYpcxFW4IFp4CjtFayyw0BkbjPXzci0UKCz7wBJHrTAPvexoYviuU5DB73SZsR25IhnSkZcHpPjQU3DDbngXX2I2aNeTmN1J0GAwNjSQgJ5HM415QOjQVWzdsizgpOitu4vu4F3t5Eyw0EJMYDPq+q2jd18ZN74LCbvR0Hvhx4PGkpiw8yYnkfSz1v6GJ1NvzyAbOsVQk5/8ylDq+TjJPq0rwa1i3ZiOaD8SwpummkpihHDmwnqUUmrNhbNxB8EUE05qCFAobGNvAEUsy6/o6dhwLqekemQrvXc1ORimxcR8y3LGOURbxdnjeBG00G6M50PwWpds8nje1k4m3JTtF0wGWou+zO30QHFN1lNmzdN30qiI1kgHPOR1m0nKUymEuU71VEidq/ANjLcasCRzX0QAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
    &gt;
      &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        style=&quot;width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;&quot;
        alt=&quot;Yes, I am intensely interested in people fighting with the antimeridian in spatial software.&quot;
        title=&quot;Yes, I am intensely interested in people fighting with the antimeridian in spatial software.&quot;
        src=&quot;/static/95c261579c9f5e480262a01b7756d6bf/b6638/Screenshot from 2018-12-10 18-14-26.png&quot;
        srcset=&quot;/static/95c261579c9f5e480262a01b7756d6bf/60f18/Screenshot from 2018-12-10 18-14-26.png 148w,
/static/95c261579c9f5e480262a01b7756d6bf/9d7cc/Screenshot from 2018-12-10 18-14-26.png 295w,
/static/95c261579c9f5e480262a01b7756d6bf/b6638/Screenshot from 2018-12-10 18-14-26.png 590w,
/static/95c261579c9f5e480262a01b7756d6bf/deb91/Screenshot from 2018-12-10 18-14-26.png 885w,
/static/95c261579c9f5e480262a01b7756d6bf/990fb/Screenshot from 2018-12-10 18-14-26.png 1180w,
/static/95c261579c9f5e480262a01b7756d6bf/dd270/Screenshot from 2018-12-10 18-14-26.png 1298w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
      /&gt;
    &lt;/span&gt;
  &lt;/span&gt;
  
  &lt;/a&gt;
    
  &lt;figcaption class=&quot;gatsby-resp-image-figcaption&quot;&gt;Yes, I am intensely interested in people fighting with the antimeridian in spatial software.&lt;/figcaption&gt;
  &lt;/figure&gt;
      &lt;/p&gt;</content:encoded></item><item><title><![CDATA[Gatsby Blog]]></title><description><![CDATA[I’ve just obtained the  spatialparalysis.xyz  domain. I’m going to move my blog here from my old blog/portfolio website (nearimprov.com). I…]]></description><link>https://spatialparalysis.xyz//gatsby-blog/</link><guid isPermaLink="false">https://spatialparalysis.xyz//gatsby-blog/</guid><pubDate>Sat, 08 Dec 2018 21:39:00 GMT</pubDate><content:encoded>&lt;p&gt;I’ve just obtained the &lt;a href=&quot;https://spatialparalysis.xyz&quot;&gt;spatialparalysis.xyz&lt;/a&gt; domain. I’m going to move my blog here from my old blog/portfolio website (nearimprov.com). I wanted to try out Gatsby JS, so that I could build some little React components and include them in various places. I’ve used React a lot over the last two years, and since I’ve accepted a new job with much less web development, I might have the desire to make some components for fun rather than for profit.&lt;/p&gt;
&lt;p&gt;I haven’t written anything this year, but I hope to get back into the swing of things next year when I’m more in my element.&lt;/p&gt;
&lt;h3&gt;Why “Spatial Paralysis”?&lt;/h3&gt;
&lt;p&gt;Well, I really just wanted:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;strong&gt;A domain that is better than “nearimprov.com”.&lt;/strong&gt; This was easy, since the old domain communicated exactly nothing. I think I picked it with a random generator of word pairs until I arrived at a pair of words that sounded like more than nothing, but less than anything. I’m not going to renew that domain.&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;A domain that communicates “spatial”.&lt;/strong&gt; My Masters degree is in geographic information systems. I will talk about it a lot. I will use my knowledge of the area to feed my family. Although I have general reservations about the field, for better or for worse my hat is in the ring. Spatial systems are my speciality, and—momentarily putting aside all forms of imposter syndrome—I’m an expert in the field.&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;A silly-therefore-memorable name.&lt;/strong&gt; Eventually I settled on a rather crude rhyming pun on “facial paralysis”. I was thinking about other blogs that follow a similar kind of naming strategy, such as the &lt;a href=&quot;https://www.saltycrane.com/about/&quot;&gt;SaltyCrane Blog&lt;/a&gt;.&lt;/li&gt;
&lt;/ol&gt;
&lt;h3&gt;What’s left to do?&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;I need to migrate all my old content to this blog, which will be a little bit of a manual process than I’d like, because I didn’t entirely stick to simple Markdown content.&lt;/li&gt;
&lt;li&gt;I also want to implement tags. (Note: &lt;a href=&quot;/tags&quot;&gt;done&lt;/a&gt;!)&lt;/li&gt;
&lt;li&gt;I need to get the Disqus comments working again, hopefully without losing comments. I’ve been through this once before, and it was a bit of a pain.&lt;/li&gt;
&lt;li&gt;I’d also like to be able to post privately, perhaps behind a password, or even a full authentication system with Auth0. Then I could write updates for IRL friends and family using their social logins, without sharing things with the wider world. This would be doubly nice since I’ve stopped using social media.&lt;/li&gt;
&lt;li&gt;I still haven’t worked out timezones in my post metadata. We have a rule of thumb at work: when implmenting a feature that involves time, the complexity of the feature is +2 effort points harder than you think. Every time.&lt;/li&gt;
&lt;/ul&gt;</content:encoded></item><item><title><![CDATA[NZ Traffic Dashboard]]></title><description><![CDATA[This is an old post, that I’m using to iron out any issues I have importing old content. Looking back at my ambitions for 2017 in early…]]></description><link>https://spatialparalysis.xyz//traffic-dashboard/</link><guid isPermaLink="false">https://spatialparalysis.xyz//traffic-dashboard/</guid><pubDate>Sun, 31 Dec 2017 14:25:00 GMT</pubDate><content:encoded>&lt;p&gt;This is an old post, that I’m using to iron out any issues I have importing old content.&lt;/p&gt;
&lt;p&gt;Looking back at my ambitions for 2017 in early December, I’ve done OK. Getting married was obviously a huge personal milestone for me. There was one outstanding item that I’d intended to do early in the year that instead I decided to devote December to: an interactive traffic dashboard for New Zealand. In my mind’s eye this would be something like a traffic control centre, &lt;a href=&quot;https://www.stuff.co.nz/national/99897853/curious-city-the-team-that-keep-new-zealands-traffic-moving&quot;&gt;like the one in Wellington&lt;/a&gt;, which manages about two thirds of the nation’s roads.&lt;/p&gt;
&lt;p&gt;I like to pick at least one new piece of technology when I work on a personal project of this nature. This time it was &lt;a href=&quot;https://electronjs.org/&quot;&gt;Electron&lt;/a&gt;: a way to make cross platform desktop apps using familiar tools for web development. I ended up using &lt;a href=&quot;https://electronforge.io/&quot;&gt;Electron Forge&lt;/a&gt; to make the process even easier, because I’d rather spend time on the actual project than on build configuration.&lt;/p&gt;
&lt;p&gt;The goal for this project was quite a low bar initially: a map that could show the available traffic cameras exposed by the &lt;a href=&quot;https://www.nzta.govt.nz/traffic-and-travel-information/infoconnect-section-page/about-the-apis/traffic-cameras/&quot;&gt;NZTA traffic camera API&lt;/a&gt;. When zooming and panning that map, I wanted the cameras that were displayed in the application to filter according to the &lt;a href=&quot;https://en.wikipedia.org/wiki/Minimum_bounding_box&quot;&gt;minimum bounding box&lt;/a&gt; defined by the user’s current map extent. I wanted this simply because when browsing the NZTA’s website for traffic cameras, I found it frustrating to have to click through menus (text) to access spatial information. To build such an application that could respond the way I wanted, I decided to use &lt;a href=&quot;https://reactjs.org/&quot;&gt;React&lt;/a&gt;, and in particular Google’s Material UI and &lt;a href=&quot;https://github.com/alex3165/react-mapbox-gl&quot;&gt;this React binding of Mapbox GL JS&lt;/a&gt; that I’ve been using for most of this year at work.&lt;/p&gt;
&lt;p&gt;I found that my decision to use Electron (and therefore a local desktop application) eventually led to some other decisions that I hadn’t originally intended: images from cameras could be cached locally on disk, so I store them in a sensible structure and then I can list the contents of each camera’s cache, sort by &lt;a href=&quot;https://www.unixtutorial.org/2008/04/atime-ctime-mtime-in-unix-filesystems/&quot;&gt;mtime&lt;/a&gt;, and create a looping animation for each camera. Anticipating that this would not always be a desktop application, it’s just a configuration change away from using an S3 bucket to cache images and to use that to drive the animation (e.g. using &lt;code class=&quot;language-text&quot;&gt;listObjectsV2&lt;/code&gt; in the AWS JavaScript SDK to order images by modification time).&lt;/p&gt;
&lt;blockquote class=&quot;twitter-tweet&quot; data-lang=&quot;en&quot;&gt;&lt;p lang=&quot;en&quot; dir=&quot;ltr&quot;&gt;The NZTA traffic camera API only gives you instantaneous results. So I&amp;#39;ma address that: &lt;a href=&quot;https://t.co/4B0aoe3Lby&quot;&gt;pic.twitter.com/4B0aoe3Lby&lt;/a&gt;&lt;/p&gt;&amp;mdash; ∆ Richard Law (@abetasoup) &lt;a href=&quot;https://twitter.com/abetasoup/status/936165994837327872?ref_src=twsrc%5Etfw&quot;&gt;November 30, 2017&lt;/a&gt;&lt;/blockquote&gt;
&lt;script async src=&quot;https://platform.twitter.com/widgets.js&quot; charset=&quot;utf-8&quot;&gt;&lt;/script&gt;
&lt;h2&gt;The NZTA APIs&lt;/h2&gt;
&lt;p&gt;In addition to the NZTA traffic camera API, I also used their Variable Message Signs API, the OpenWeatherMap API, the Mapbox vector tile API (with their traffic tiles), and trivial parts of the AWS JS SDK. There’s a handful of pain points about the NZTA APIs that would be nice to see addressed in 2018.&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;You can’t manage your own API keys.&lt;/strong&gt; You have to send an email to a human to request access, and give a reason for wanting access (although my reason was literally just “Curiosity”). Every request must also include a username and password in the request headers. However your username and password are determined &lt;em&gt;for&lt;/em&gt; you, and &lt;em&gt;you cannot change them yourself&lt;/em&gt;. This all smells a little bit of an immature API and API culture. As the terms of use include a requirement that you keep this information secure, I’d argue that if someone else has control of my password, then I already have no control over the security of it.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;From doing a bit of digging into how our traffic control centres operate in New Zealand, I realised that &lt;strong&gt;the API only exposes a small fraction of the cameras that are on our roads&lt;/strong&gt;. On Twitter &lt;a href=&quot;https://twitter.com/NZTAWgtn/status/943889798405771264&quot;&gt;the NZTA posted a short video of SH2&lt;/a&gt; in Wellington. This camera is video, as opposed to 30/60/240 second stills that the API exposes. It’s also in a particularly useful position. It was argued that this is done to protect privacy (e.g. in the case of a serious accident), but I’m not sure I buy this reasoning. Cameras can already be marked “unavailable” and no images retrieved for as long as that status remains. I’d hope that this feature gets used appropriately. What worries me is whether the NZTA actually has multiple camera systems operating with different APIs. I’m a firm believer in &lt;a href=&quot;https://en.wikipedia.org/wiki/Eating_your_own_dog_food&quot;&gt;eating your own dog food&lt;/a&gt;, so I &lt;strong&gt;hope&lt;/strong&gt; that this API doesn’t just exist for external consumption, but rather is used internally.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;The cameras in Hamilton are almost always “under maintenance”.&lt;/strong&gt; This I don’t really understand, unless there’s some network connectivity issue, because it only seems to affect Hamilton. A few of the cameras in Hamilton were reliable, the rest were almost always off.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;The API responses could be a bit more useful.&lt;/strong&gt; For instance the direction that a camera is facing would be a very useful attribute to have. Almost all of the cameras are described as being, for example, ”&lt;em&gt;Northbound&lt;/em&gt; on State Highway 1 at Pokeno”. However the cameras are not all fixed, and indeed I watched a few being rotated and zoomed, in 30 second snapshots, as the traffic controllers monitored holiday traffic north of Wellington. They can be panned 360°, tilted, and zoomed. However the only physical camera attribute that is exposed is the location. I parsed the descriptions looking for an indication of direction, and then used that to rotate symbols in the map—but it just made it more confusing (an upside-down camera icon?). The camera facing direction would be great given the ability to tilt and rotate in Mapbox GL.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;The Variable Message Signs API doesn’t use standard characters for newlines and tabs&lt;/strong&gt;, which is a minor annoyance, but irritating nonetheless.&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;h2&gt;Wrapping up&lt;/h2&gt;
&lt;p&gt;All in all, this was a fun little distraction for the past month. I think it was a good idea to “time box” myself to avoid some bad habits, but also because it means I can now move on to something else for the month of January without feeling guilty. I don’t consider the project “finished”, although nothing ever really is, so I will probably revisit it later in the year. The code is on Github &lt;a href=&quot;https://github.com/alpha-beta-soup/traffic-dash&quot;&gt;here&lt;/a&gt; and there is also a loose Kanban-stype project board for it &lt;a href=&quot;https://github.com/alpha-beta-soup/traffic-dash/projects/1&quot;&gt;here&lt;/a&gt; where I’ve recorded the ideas I have for it.&lt;/p&gt;
&lt;h2&gt;Demo&lt;/h2&gt;
&lt;p&gt;&lt;figure class=&quot;blog-figure&quot;&gt;&lt;img src=&quot;/Peek%202017-12-31%2015-35-6d1559632146b56c21c079c98b40c88a.gif&quot; title=&quot;A brief snapshot of &amp;#x22;Traffic Dash&amp;#x22; in action.&quot; class=&quot;blog-img&quot;&gt;&lt;figcaption class=&quot;blog-figcaption&quot;&gt;A brief snapshot of “Traffic Dash” in action.&lt;/figcaption&gt;&lt;/figure&gt;&lt;/p&gt;</content:encoded></item><item><title><![CDATA[The things you see on a journey]]></title><description><![CDATA[Some moons ago, I met Dr Pierre Roudier, who works at  Landcare Research New Zealand , at a workshop on PostGIS being held at the National…]]></description><link>https://spatialparalysis.xyz//things-you-see-on-a-journey/</link><guid isPermaLink="false">https://spatialparalysis.xyz//things-you-see-on-a-journey/</guid><pubDate>Mon, 01 Jun 2015 11:07:10 GMT</pubDate><content:encoded>&lt;p&gt;
  &lt;figure class=&quot;gatsby-resp-image-figure&quot; style=&quot;&quot;&gt;
  
  &lt;span
    class=&quot;gatsby-resp-image-wrapper&quot;
    style=&quot;position: relative; display: block;  max-width: 590px; margin-left: auto; margin-right: auto;&quot;
  &gt;
    &lt;span
      class=&quot;gatsby-resp-image-background-image&quot;
      style=&quot;padding-bottom: 34.786117836965296%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAIAAACHqfpvAAAACXBIWXMAAAsSAAALEgHS3X78AAABtklEQVQY0wGrAVT+AGRxVk1eS1xrUmBtUmFtUWRvU3WEaV5tXYaSe9jFs8h7ZqE9K4oqIG9DNphIM5RdRWpmTWJiSFRcRmlzWwBYZExodVlQW0NgalJyf2FpdVtkcV1YaFWMkHnRlHq/dV+ZOyyBMSeFTjySTzlaXUdrcVpbYUtLVD9hbFcAX2xRYnBUS1Q+U2FOYnFZWGRNVF9IcH1mlZuFm4dwoGRQkEAzjDYsj0MybFM9eWpQe31lWGBLTFZAYWxXAF1qUFhkS05YQlViTWFtU1pnT3mCasvItNWymbaJcahbSpo+NIxHOIFMOHZlTYR+ZWBlUFBaRWdyXmp0YABfa1JQWUJZZUxZZExNV0FOWD+/xbf/7eXpknPXiG++Xk2cNSyLPC6EX0iRjXJ8hm5fZ1BWYk9kb1xqc18AZHFWUVxEWmVMWWRLUVtFTVg/s7mt+tbE45Fw1nNayFhHskI4hEc4hHxjgolymp2Ho6aOg4t2XmpZaXNfAHWCY298Xl1nTlplTVVfSE9bRYiBZeOtjeCNcMxnUL5NQK5GO6dmVI5xWoeCa7Kznbu7pJebhXyEcqmqlLD3s7JSGX+XAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
    &gt;
      &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        style=&quot;width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;&quot;
        alt=&quot;&quot;What you&apos;ll be making: identifying the land that you can feasibly see from the train in the central plateau of New Zealand.&quot;
        title=&quot;What you&apos;ll be making: identifying the land that you can feasibly see from the train in the central plateau of New Zealand.&quot;
        src=&quot;/static/569127bd8942fb4dd987e15b79be95ef/b6638/example.png&quot;
        srcset=&quot;/static/569127bd8942fb4dd987e15b79be95ef/60f18/example.png 148w,
/static/569127bd8942fb4dd987e15b79be95ef/9d7cc/example.png 295w,
/static/569127bd8942fb4dd987e15b79be95ef/b6638/example.png 590w,
/static/569127bd8942fb4dd987e15b79be95ef/deb91/example.png 885w,
/static/569127bd8942fb4dd987e15b79be95ef/990fb/example.png 1180w,
/static/569127bd8942fb4dd987e15b79be95ef/7cd8e/example.png 1239w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
      /&gt;
    &lt;/span&gt;
  &lt;/span&gt;
  
  &lt;figcaption class=&quot;gatsby-resp-image-figcaption&quot;&gt;What you&apos;ll be making: identifying the land that you can feasibly see from the train in the central plateau of New Zealand.&lt;/figcaption&gt;
  &lt;/figure&gt;
      &lt;/p&gt;
&lt;p&gt;Some moons ago, I met Dr Pierre Roudier, who works at &lt;a href=&quot;http://www.landcareresearch.co.nz/home&quot;&gt;Landcare Research New Zealand&lt;/a&gt;, at a workshop on PostGIS being held at the National Institute for Water and Atmospheric Research (&lt;a href=&quot;https://www.niwa.co.nz/&quot;&gt;NIWA&lt;/a&gt;). I was just getting started on PostGIS at the time, having identified that I was probably going to need it for my masters thesis. The two-day session, led by Digital Mapping Solutions New Zealand (&lt;a href=&quot;http://www.mapsolutions.co.nz/&quot;&gt;DMS&lt;/a&gt;), was brilliant. It gave me just enough of an introduction to PostGIS to realise its capability, and a leg-up to explore the rest on my own. I ended up relying entirely on PostGIS for my masters thesis, and now I swear by PostGIS and PL/pgsql as the solution to most issues calling for a spatial database.&lt;/p&gt;
&lt;p&gt;What has this got to do with anything? A few things:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;For the love of all things holy, attend events like these if you can. You meet interesting people, get pizza (I ate kangaroo), and get a kick up the bum to learn new things that, honestly, you wouldn’t have bothered learning on your own. (In my case, the only reason I was able to attend was that I’d won a small cash prize for talking about my thesis—so you if you’re studying, try jump on small opportunities like that, too.)&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Pierre ran a tutorial at the end of the first day on GRASS GIS. It really piqued my interest in GRASS. At the time, I was struggling with a batch viewshed calculation for work using ArcGIS. It was falling over due to the size of the computation. I described the problem to Pierre, and he said that it sounded like something GRASS could do no problem. Problem was, I’d never used GRASS. It looked hard and scary: it barely has a GUI. Pierre gave me a headstart on the computation, and I adapted his example to my need. It wasn’t actually that bad, once I’d seen a complete, straightforward example.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;I realised the value of a gentle introduction to a new technique, that actually fulfils some goal you have in mind.&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;This last point is now really important to me. If I’m trying to learn something new, it has never truly helped me to open a book or the documentation and work through silly, disconnected examples one by one. I actually have to make something useful for myself. &lt;strong&gt;Solve your own, tangible problem.&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;Doing this gives you enough motivation to finish, to finish well, and to know when you have finished. It also means you run into a wide variety of problems that your textbooks examples never mention; like, how do you write an iterator in bash?&lt;/p&gt;
&lt;h2&gt;What are you going to learn?&lt;/h2&gt;
&lt;p&gt;This is a tutorial on using GRASS, Git, Leaflet, bash, JavaScript, CSS, HTML, and hosting map tiles on Amazon AWS. Yes, all of those. No, not to exhaustion. Rather, I’ve written the tutorial that I would like to have found a few months ago. A tutorial that takes a tangible (albeit frivolous) problem to completion, and uses a realistic combination of tools to solve it. You’ll see how these separate tools come together, and how you could then take pieces here and there and work on something completely different. That’s an effective way to learn, if you invest into the idea of the project, and are willing to use this tutorial as a springboard for your own idea.&lt;/p&gt;
&lt;p&gt;The end result is this &lt;a href=&quot;/train-landscapes&quot;&gt;interactive map&lt;/a&gt;.&lt;/p&gt;
&lt;p class=&quot;sidenote&quot;&gt;The map tiles are now broken, as I was not willing to pay to host the tiles for long.&lt;/p&gt;
&lt;h2&gt;What I can’t cover&lt;/h2&gt;
&lt;p&gt;I will not cover &lt;a href=&quot;http://readwrite.com/2013/09/30/understanding-github-a-journey-for-beginners-part-1&quot;&gt;beginning with Git&lt;/a&gt;, or fundamental Git concepts. But you’ll learn some commands and how to host an interactive map on the Internet for free with Github pages.&lt;/p&gt;
&lt;p&gt;I will not cover getting started with GRASS. Although this won’t be a terrible introduction, I’m not detailing introductory concepts or using the GUI.&lt;/p&gt;
&lt;div class=&quot;sidenote&quot;&gt;
  &lt;p&gt;
    Try
    &lt;a href=&quot;http://grass.osgeo.org/documentation/first-time-users/&quot;&gt;[1]&lt;/a&gt;,
    &lt;a href=&quot;http://grass.osgeo.org/grass70/manuals/helptext.html&quot;&gt;[2]&lt;/a&gt; or
    &lt;a href=&quot;http://grasswiki.osgeo.org/wiki/Quick_wxGUI_tutorial&quot;&gt;[3]&lt;/a&gt; instead,
    and then come back.
  &lt;/p&gt;
&lt;/div&gt;
&lt;p&gt;I had the benefit of a hands-on GRASS introduction at the DMS/NIWA workshop.&lt;/p&gt;
&lt;p&gt;I won’t be discussion web hosting of maps in much depth. I’m not yet much of a web developer, and I’ve only tinkered with Amazon AWS to get this to work. I’m not an authority.&lt;/p&gt;
&lt;h2&gt;What do you need?&lt;/h2&gt;
&lt;p&gt;If you want to code along, you’ll need to install GRASS GIS (6.4 or 7.0). Git is optional; if you’re not familiar with it, I’d like to just show you how can use it in a little project like this.&lt;/p&gt;
&lt;p&gt;I use Ubuntu for my desktop operating system. I don’t know how easy GRASS is to install on Windows or Mac, but I like to use the &lt;a href=&quot;https://launchpad.net/~ubuntugis/+archive/ubuntu/ubuntugis-unstable&quot;&gt;ubuntugis-unstable PPA&lt;/a&gt;. This has GRASS 6.4 bundled up. GRASS 7.0 is faster due to the addition of new functions, so use that if you’re comfortable. If you’re not using a flavour of Linux, look into getting a virtual machine set up---it’s surprisingly easy and you’ll not regret it.&lt;/p&gt;
&lt;p&gt;I’m also going to have to assume a modicum of familiarity with GIS, and some programming concepts (variables, iteration, functions, etc.). Yet you also need a willingness to learn! I’m still learning more about programming every day, even though I now get paid to do it, so if there’s anything that I seem to have brushed over, don’t feel too shy to ask me to explain it further.&lt;/p&gt;
&lt;h1&gt;The problem&lt;/h1&gt;
&lt;p&gt;I talked to Pierre about a train trip across the North Island of New Zealand, known as the &lt;em&gt;Overlander&lt;/em&gt;. He often takes the train to get to Wellington, and I’ve taken the Overlander several times to get between Auckland and Wellington. It is a lot slower than flying (by around 11+ hours), but personally I find it more enjoyable. In addition to your ability to get some solid solo productive time, it is very scenic. Being Spatial Scientists™, Pierre and I discussed how one could go about quantifying the &lt;em&gt;scenic-ness&lt;/em&gt;… &lt;em&gt;scenicity&lt;/em&gt;… the &lt;em&gt;je ne sais quoi&lt;/em&gt; of the trip.&lt;/p&gt;
&lt;p&gt;To solve this problem, you need to think abstractly about it, and then apply that back to the real problem, phrased in reduced, but practical terms:&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Given a line feature, and an elevation model, how can you determine the subset of the elevation model that is visible from the line?&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;Translated into the vernacular: if you’re sitting on the train, what can you see out of the window?&lt;/p&gt;
&lt;p&gt;What could be taken into consideration in this case, from a spatial perspective? The most straightforward ideas include: what is the terrain like? (Hills block views of what is behind them.) How far can you see out the window? (&lt;a href=&quot;http://en.wikipedia.org/wiki/Horizon#Distance_to_the_horizon&quot;&gt;Distance to the horizon&lt;/a&gt;, coupled with personal eyesight, and atmospheric refraction.)&lt;/p&gt;
&lt;p&gt;The not-so-straightforward, or even unresolvable issues include: are you on the left or right side of the train? Is the train going north or south? What speed is the train travelling at? Can you actually see out of the window? Is it dark? Are you asleep? Are there trees in the way? Are there tunnels?&lt;/p&gt;
&lt;p&gt;Like all good spatial problems, the difficult issues outnumber the tractable ones. &lt;strong&gt;We’re just going to be thinking about visibility as determined by the bare terrain, using a constant distance to the horizon, ignoring tunnels.&lt;/strong&gt; This (arguably) gives us some measurement of the &lt;em&gt;maximum extent&lt;/em&gt; of space that is visible, which could be reduced further.&lt;/p&gt;
&lt;p&gt;The two most influential decisions are the resolution of our terrain model, which determines blocking, and the distance to the horizon, which in an ideal world considers the curvature of the earth and an observer’s elevation.&lt;/p&gt;
&lt;h3&gt;Setting up with Git&lt;/h3&gt;
&lt;p&gt;Launch your terminal, and navigate to somewhere where we can place a folder of interesting stuff (our project code and input data).&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;git clone&lt;/code&gt; my GitHub repository with the following command:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token function&quot;&gt;git&lt;/span&gt; clone https://github.com/alpha-beta-soup/train-landscapes&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;This creates a folder called &lt;code class=&quot;language-text&quot;&gt;train-landscapes&lt;/code&gt; in your current directory, within which the project is “cloned”: duplicated for your local consumption.&lt;/p&gt;
&lt;p&gt;If you browse my Github repository in your web browser via the &lt;a href=&quot;https://github.com/alpha-beta-soup/train-landscapes&quot;&gt;link&lt;/a&gt; in the &lt;code class=&quot;language-text&quot;&gt;git clone&lt;/code&gt; command, you’ll see that I originally “forked” this project from Pierre. That is, he started it, and I carried it on with my own changes. Pierre wrote the initial version of the GRASS procedure, targeting GRASS version 7. I adjusted this script, to make it work a bit faster with a larger input and higher resolution raster terrain model. I also made a second version that would work with GRASS 6.4, which is what I was using at the time. That’s what’s great about Git and open source code generally: being able to take someone else’s idea, and adapt it to fit your needs and circumstances.&lt;/p&gt;
&lt;p&gt;After cloning, you’ll see that there are a few files and folders, if you enter the &lt;code class=&quot;language-text&quot;&gt;train-landscapes&lt;/code&gt; directory. &lt;code class=&quot;language-text&quot;&gt;.gitignore&lt;/code&gt; is a text file with the following contents:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;data/&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;This tells Git to not track files (or changes to files) in the directory &lt;code class=&quot;language-text&quot;&gt;data/&lt;/code&gt; (which contains the source and output data, like the terrain DEM/hillshade model that I used as input).&lt;/p&gt;
&lt;p&gt;The hillshade and digital elevation model (DEM) I used for this project are several gigabytes in size; I haven’t included them in the project to save you the bandwidth. Likewise, the tiles that actually constitute what you see on the map aren’t on Github either (they’re hosted by Amazon, more on that later). The &lt;code class=&quot;language-text&quot;&gt;.gitignore&lt;/code&gt; file is a handy way to manage issues like this one on excluding large datasets from source control when they don’t need it. For following along with this tutorial, you can download any DEM of New Zealand (projected to NZTM NZGD2000) that you have the rights to use. (You can of course pick a region anywhere else in the world.)&lt;/p&gt;
&lt;p&gt;We also have &lt;code class=&quot;language-text&quot;&gt;README.md&lt;/code&gt;, which is the Markdown file that provides the documentation you can see on the front page of the GitHub repository for this project.&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;index.html&lt;/code&gt; is where we have a simple webpage displaying a Leaflet map. We’ll get to this later.&lt;/p&gt;
&lt;p&gt;The directory &lt;code class=&quot;language-text&quot;&gt;data&lt;/code&gt; contains the input vector features I used for this project: the train and road features that we determine visibility from. However, you can’t actually download this directory, as I’ve added it to the &lt;code class=&quot;language-text&quot;&gt;.gitignore&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;The directory &lt;code class=&quot;language-text&quot;&gt;source&lt;/code&gt; contains the real work: our project code. We can list its contents from the terminal with the &lt;code class=&quot;language-text&quot;&gt;ls&lt;/code&gt; command:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token function&quot;&gt;ls&lt;/span&gt; source/*

  generate_los.sh
  generate_los_70.sh
  make_map.js
  obtain_corners.py
  style.css&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;The &lt;code class=&quot;language-text&quot;&gt;generate_los&lt;/code&gt; shell scripts (&lt;code class=&quot;language-text&quot;&gt;.sh&lt;/code&gt;) are files that contain a series of commands that will be understood by GRASS GIS, versions 6.4 and 7. Let’s consider them now.&lt;/p&gt;
&lt;h3&gt;GRASS and shell scripts&lt;/h3&gt;
&lt;p&gt;If you have installed GRASS, you can start it up at the command line by running the appropriate command for your version of GRASS: &lt;code class=&quot;language-text&quot;&gt;grass64&lt;/code&gt; or &lt;code class=&quot;language-text&quot;&gt;grass70&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;After a short moment, a two-window GUI will open up. GRASS uses some concepts and terminology that are pretty hard to get your head around becausr they are different to other GIS programs, particularly the idea of a “mapset”. You should be able to use the default, “PERMANENT” mapset for this tutorial, but I encourage you to look for some other GRASS tutorials that consider making your own mapsets. For now, you can just close or ignore the GUI windows as we will not be using them.&lt;/p&gt;
&lt;p&gt;Let’s consider the GRASS 6.4 code (a shell script written in bash). Open &lt;code class=&quot;language-text&quot;&gt;generate_los.sh&lt;/code&gt; in a text editor. To do this with Gedit from the command line:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;gedit source/generate_los.sh&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Browse through the file for a bit.&lt;/p&gt;
&lt;p&gt;The very first line is a “shebang” that just tells the program loader what kind of interpreter to use. Here, we are using bash, as opposed to an alternative UNIX shell, like dash.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token shebang important&quot;&gt;#!/bin/bash&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;After that, we define a function called &lt;code class=&quot;language-text&quot;&gt;usage&lt;/code&gt;. Usage is called upon when checking inputs to the terminal when the code is executed. The function &lt;code class=&quot;language-text&quot;&gt;usage&lt;/code&gt; prints out a small bit of documentation for our code, telling a user that one of two possible arguments can be used: &lt;code class=&quot;language-text&quot;&gt;-train&lt;/code&gt; or &lt;code class=&quot;language-text&quot;&gt;-road&lt;/code&gt;. Choosing train will make sure the script uses some parameters that apply to travelling by train, and similarly for travelling by road.&lt;/p&gt;
&lt;p class=&quot;sidenote&quot;&gt;Disclaimer: I don&apos;t actually know if this is proper practice for writing what is essentially help documentation. I can&apos;t imagine it&apos;s too far from this.&lt;/p&gt;
&lt;p&gt;The &lt;code class=&quot;language-text&quot;&gt;usage&lt;/code&gt; function and argument parsing:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;usage&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
   &lt;span class=&quot;token function&quot;&gt;cat&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;EOF
Usage: generate_los.sh [-train | -road]

-train    perform the viewshed analysis for the train journey
-road     perform the viewshed analysis for the road journey
EOF&lt;/span&gt;
   &lt;span class=&quot;token keyword&quot;&gt;exit&lt;/span&gt; 1
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt; $&lt;span class=&quot;token comment&quot;&gt;# -ne 1 ]; then&lt;/span&gt;
   &lt;span class=&quot;token comment&quot;&gt;# Number of arguments&lt;/span&gt;
   &lt;span class=&quot;token comment&quot;&gt;# If there is more or less than one, do usage()&lt;/span&gt;
   usage&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;fi&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;&lt;span class=&quot;token variable&quot;&gt;$1&lt;/span&gt;&quot;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;-train&quot;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;&lt;span class=&quot;token variable&quot;&gt;$1&lt;/span&gt;&quot;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;-road&quot;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;then&lt;/span&gt;
  usage&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;fi&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;if [ $# -ne 1 ]; then&lt;/code&gt; considers all of the arguments that a user enters alongside the command to execute the GRASS shell script. If the number of arguments is not equal to one (&lt;code class=&quot;language-text&quot;&gt;-ne 1&lt;/code&gt;), then the condition is reached: run the &lt;code class=&quot;language-text&quot;&gt;usage&lt;/code&gt; function.&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;usage&lt;/code&gt; tells our naïve user that they have to run either (and only one of) these commands at the terminal to get things going:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;sh execute_los.sh -train
sh execute_los.sh -road&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Failure to do so simply prints an instruction to the terminal, and causes the script to stop with exit code 1 (&lt;code class=&quot;language-text&quot;&gt;exit 1&lt;/code&gt;), a catch-all for general errors.&lt;/p&gt;
&lt;p&gt;If the number of provided arguments is equal to one, we then check if this argument is in the realms of expectation (argument &lt;code class=&quot;language-text&quot;&gt;&amp;quot;$1&amp;quot;&lt;/code&gt; is &lt;code class=&quot;language-text&quot;&gt;-train&lt;/code&gt; or &lt;code class=&quot;language-text&quot;&gt;-road&lt;/code&gt;). If the first argument is not equal to &lt;code class=&quot;language-text&quot;&gt;train&lt;/code&gt; (&lt;code class=&quot;language-text&quot;&gt;&amp;quot;$1&amp;quot; != &amp;quot;-train&amp;quot;&lt;/code&gt;) or &lt;code class=&quot;language-text&quot;&gt;-road&lt;/code&gt;, then &lt;code class=&quot;language-text&quot;&gt;usage&lt;/code&gt; is triggered again. Otherwise we go on our merry way: setting up some variables according to &lt;code class=&quot;language-text&quot;&gt;train&lt;/code&gt; or &lt;code class=&quot;language-text&quot;&gt;road&lt;/code&gt;:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;token variable&quot;&gt;$1&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;-road&quot;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;then&lt;/span&gt;
    LINE_SHP&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;../data/road/roads.shp&apos;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;# Roads shapefile&lt;/span&gt;
    PTS_FILE&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;../data/road/road_points_coords.csv&quot;&lt;/span&gt;
    &lt;span class=&quot;token comment&quot;&gt;# ^ An intermediate output of this script; coordinates of LINE_SHP&lt;/span&gt;
    ELEV&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;1.2 &lt;span class=&quot;token comment&quot;&gt;# Metres above the ground that the observer stands&lt;/span&gt;
    &lt;span class=&quot;token comment&quot;&gt;# ^ just a guess (note, try include the vehicle, too)&lt;/span&gt;
    OUTFILE&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;dist_los_car&quot;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;# Name of final output raster&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;elif&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;token variable&quot;&gt;$1&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;-train&quot;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;then&lt;/span&gt;
    &lt;span class=&quot;token comment&quot;&gt;# We live in a post-shapefile world, baby!&lt;/span&gt;
    LINE_SHP&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;../data/train/nz-railway-centrelines-topo-150k.gpkg&apos;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;# Rail geopackage&lt;/span&gt;
    PTS_FILE&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;../data/train/rail_points_coords.csv&quot;&lt;/span&gt;
    &lt;span class=&quot;token comment&quot;&gt;# ^ An intermediate output of this script; coordinates of LINE_SHP&lt;/span&gt;
    ELEV&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;2.5 &lt;span class=&quot;token comment&quot;&gt;# Metres above the ground that the observer stands&lt;/span&gt;
    &lt;span class=&quot;token comment&quot;&gt;# ^ just a guess (note, try include the vehicle, too)&lt;/span&gt;
    OUTFILE&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;dist_los_rail&quot;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;# Name of final output raster&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;else&lt;/span&gt;
    usage&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;# shouldn&apos;t need this&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;fi&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;We define a number of variables that have global scope for the remainder of the script:&lt;/p&gt;
&lt;div class=&quot;newthought&quot;&gt;
  &lt;h5&gt;&lt;code&gt;LINE_SHP&lt;/code&gt;&lt;/h5&gt;
  &lt;p&gt;A line &quot;shape&quot;, or vector feature. GRASS is happy accepting a wide variety of vector formats, and we don&apos;t even have to specify what they are. In my case, I downloaded both an Esri Shapefile (for the road following State Highway 1 between Auckland and Wellington) and a &lt;a href=&quot;https://github.com/opengeospatial/geopackage&quot;&gt;GeoPackage&lt;/a&gt; (for the main trunk railroad of the North Island).&lt;/p&gt;
  &lt;p&gt;Before running this script, I used QGIS to remove all features from my original dataset that I wasn&apos;t interested in. I could have also performed this filtering in GRASS, which would have had the advantage of making it easier to change my region of interest another time.&lt;p&gt;
&lt;/div&gt;
&lt;div class=&quot;newthought&quot;&gt;
  &lt;h5&gt;&lt;code&gt;PTS_FILE&lt;/code&gt;&lt;/h5&gt;
  &lt;p&gt;The &quot;points file&quot;: a dataset that will be created in the course of the script&apos;s execution, and represents points spaced along our original line features. These points represent all of the viewing opportunities we are going to calculate viewsheds for.&lt;p&gt;
&lt;/div&gt;
&lt;div class=&quot;newthought&quot;&gt;
  &lt;h5&gt;&lt;code&gt;ELEV&lt;/code&gt;&lt;/h5&gt;
  &lt;p&gt;GRASS&apos; viewshed tools allow us to set observer heights. That is, if you&apos;re trying to determine what you can see from your house, ideally you&apos;d account for the fact that your eyes are not at ground level. Importantly, &lt;strong&gt;a train is higher up than a car&lt;/strong&gt;, and defining the value of this variable &lt;i&gt;conditionally&lt;/i&gt; allows us to be slightly more germane when coming up with the answer to our problem.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;newthought&quot;&gt;
  &lt;h5&gt;&lt;code&gt;OUTFILE&lt;/code&gt;&lt;/h5&gt;
  &lt;p&gt;The name of the final output raster that we&apos;ll collect up at the end and open to see the result. As we will see, the final output is actually just a GeoTiff (image with a spatial projection). We need to have a different name depending on whether we are calculating train or road visibility, as we wouldn&apos;t want one to overwrite the other.&lt;/p&gt;
&lt;/div&gt;
&lt;p&gt;Following the conditional variables, there are some variables that are considered constant regardless of our mode of transport:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;R_DEM&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;../data/hillshade/nidemreproj&apos;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;# Elevation DEM&lt;/span&gt;
R_RES&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;25 &lt;span class=&quot;token comment&quot;&gt;# The resolution of the DEM (metres)&lt;/span&gt;
DIST_PTS&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;25 &lt;span class=&quot;token comment&quot;&gt;# Ideally the resolution of the DEM&lt;/span&gt;
MAX_VIS_DIST&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;30000 &lt;span class=&quot;token comment&quot;&gt;# Maximum distance visible&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;div class=&quot;newthought&quot;&gt;
  &lt;h5&gt;&lt;code&gt;DIST_PTS&lt;/code&gt;&lt;/h5&gt;
  &lt;p&gt;&lt;code&gt;DIST_PTS&lt;/code&gt; is a really important parameter. It will be used to determine how far our source viewing locations may be from one another. There is no point in this value being smaller than &lt;code&gt;R_RES&lt;/code&gt;, because two different points that lie within the same cell of our terrain model will have the same viewable cells.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;newthought&quot;&gt;
  &lt;h5&gt;&lt;code&gt;MAX_VIS_DIST&lt;/code&gt;&lt;/h5&gt;
  &lt;p&gt;&lt;code&gt;MAX_VIS_DIST&lt;/code&gt; is also very important. It defines the maximum distance from one of our viewing spots that can be considered visible to an observer. It is stated in the same units as the projection system uses; which in my case is metres.&lt;/p&gt;
&lt;/div&gt;
&lt;p&gt;Together, these global variables determine the precision of our output, and therefore how much of a computational challenge this can be. Taking this to the extreme, you could look at a sub-metre terrain model, and consider a near-continuous movement of a passenger who can see for miles and miles… but you’d need a supercomputer or a very long time to get your output. And when your output is ready, it would still be subject to many of our original limitations (lack of trees is probably the biggest one). Your output would actually be subject to &lt;a href=&quot;http://en.wikipedia.org/wiki/False_precision&quot;&gt;&lt;strong&gt;false precision&lt;/strong&gt;&lt;/a&gt;: a very important concept in GIScience.&lt;/p&gt;
&lt;p&gt;While testing, I used a &lt;code class=&quot;language-text&quot;&gt;MAX_VIS_DIST&lt;/code&gt; of only 100 metres, and a &lt;code class=&quot;language-text&quot;&gt;DIST_POINTS&lt;/code&gt; of thousands of kilometres. This did not give me the actual output I was after, but tested the logic of the code and calculated very quickly even on the real datasets. The parameter values above are the ones that I used when making the real output, which took several days to calculate. This is still a very expensive calculation!&lt;/p&gt;
&lt;h3&gt;Preparation for GRASS 6.4&lt;/h3&gt;
&lt;p&gt;Next up, we are preparing to actually use the command &lt;code class=&quot;language-text&quot;&gt;r.los&lt;/code&gt; (“raster”.“line of sight”). Here GRASS 7.0 has a strong advantage over GRASS 6.4. &lt;a href=&quot;http://grass.osgeo.org/grass64/manuals/r.los.html&quot;&gt;The documentation for &lt;code class=&quot;language-text&quot;&gt;r.los&lt;/code&gt;&lt;/a&gt; states the following:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;The time to complete the calculation increases dramatically with the region size. Try to keep the columns and rows under 1000.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;The equivalent GRASS 7.0 command, not available in GRASS 6.4 is &lt;code class=&quot;language-text&quot;&gt;r.viewshed&lt;/code&gt;, and it does not suffer so.&lt;/p&gt;
&lt;p&gt;In order to keep the number of rows and columns in our calculation under 1000, we actually need to adjust the variable &lt;code class=&quot;language-text&quot;&gt;MAX_VIS_DIST&lt;/code&gt; while considering &lt;code class=&quot;language-text&quot;&gt;R_RES&lt;/code&gt;, as the two are actually tightly linked. The following commands create a new intermediate variable, &lt;code class=&quot;language-text&quot;&gt;POS_VIS_DIST&lt;/code&gt; (possible visibility distance), which determines the maximum distance we can possibly define as “visible” without exceeding the limit of 1000 rows or 1000 columns in our visibility calculation. If &lt;code class=&quot;language-text&quot;&gt;POS_VIS_DIST&lt;/code&gt; ends up exceeding &lt;code class=&quot;language-text&quot;&gt;MAX_VIS_DIST&lt;/code&gt;, then we opt for &lt;code class=&quot;language-text&quot;&gt;POS_VIS_DIST&lt;/code&gt; by setting &lt;code class=&quot;language-text&quot;&gt;MAX_VIS_DIST&lt;/code&gt; equal to &lt;code class=&quot;language-text&quot;&gt;POS_VIS_DIST&lt;/code&gt;; otherwise we keep on with our original value of &lt;code class=&quot;language-text&quot;&gt;MAX_VIS_DIST&lt;/code&gt;.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;# r.los takes a long time, and the manual says to keep&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;# the number of rows and columns &quot;under 1000&quot;. Here we&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;# adjust MAX_VIS_DIST by considering the resolution of&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;# the raster (R_RES), so that there is a maximum of&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;# 1000 rows and columns&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;# The maximum possible vis dist to use and still have&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;# 1000 rows and cols&lt;/span&gt;
POS_VIS_DIST&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token variable&quot;&gt;&lt;span class=&quot;token variable&quot;&gt;$(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;&lt;span class=&quot;token variable&quot;&gt;$R_RES&lt;/span&gt; * 1000 / 2&quot;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;bc&lt;/span&gt; -l&lt;span class=&quot;token variable&quot;&gt;)&lt;/span&gt;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt; 1 -eq &lt;span class=&quot;token variable&quot;&gt;&lt;span class=&quot;token variable&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;&lt;span class=&quot;token variable&quot;&gt;$POS_VIS_DIST&lt;/span&gt; &amp;lt; &lt;span class=&quot;token variable&quot;&gt;$MAX_VIS_DIST&lt;/span&gt;&quot;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;bc&lt;/span&gt;&lt;span class=&quot;token variable&quot;&gt;`&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;then&lt;/span&gt;
  &lt;span class=&quot;token comment&quot;&gt;# If the maximum distance r.los can sustain exceeds the&lt;/span&gt;
  &lt;span class=&quot;token comment&quot;&gt;# user-selected value, override it&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;The MAX_VIS_DIST parameter has been changed \n
  from &lt;span class=&quot;token variable&quot;&gt;$MAX_VIS_DIST&lt;/span&gt; to &lt;span class=&quot;token variable&quot;&gt;$POS_VIS_DIST&lt;/span&gt; for performance \n
  reasons.&quot;&lt;/span&gt;
  MAX_VIS_DIST&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token variable&quot;&gt;$POS_VIS_DIST&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;fi&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;To understand this, we should consider what each line is actually doing.&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;POS_VIS_DIST=$(echo &amp;quot;$R_RES * 1000 / 2&amp;quot; | bc -l)&lt;/code&gt; instantiates a variable that is equal to the resolution of the raster, multiplied by 500. This represents how many cells in any direction an observer can “look” without the number of rows or columns exceeding 1000. &lt;code class=&quot;language-text&quot;&gt;bc&lt;/code&gt; is a command to access “an arbitrary precision calculator language” (it calculates numbers). The pipe (&lt;code class=&quot;language-text&quot;&gt;|&lt;/code&gt;) is a way to connect the output of the left command to the input of the right command.&lt;/p&gt;
&lt;p&gt;In the shell you could write:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;POS_VIS_DIST&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token variable&quot;&gt;&lt;span class=&quot;token variable&quot;&gt;$(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;25 * 1000 /2&quot;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;bc&lt;/span&gt; -l&lt;span class=&quot;token variable&quot;&gt;)&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;token variable&quot;&gt;$POS_VIS_DIST&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;And it would spit out the value of your calculation: 12500&lt;/p&gt;
&lt;p&gt;The next piece of logic is to compare this number to our &lt;code class=&quot;language-text&quot;&gt;MAX_VIS_DIST&lt;/code&gt; to see if it is larger:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;if [ 1 -eq `echo &amp;quot;$POS_VIS_DIST &amp;lt; $MAX_VIS_DIST&amp;quot; | bc` ]&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Consider the following commands:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;v1=$(echo &amp;quot;10 &amp;lt; 20&amp;quot; | bc -l)
v2=$(echo &amp;quot;20 &amp;lt; 10&amp;quot; | bc -l)&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Can you see that we’re doing inequality checks? The value of &lt;code class=&quot;language-text&quot;&gt;v1&lt;/code&gt; is 1, true (10 is less than 20); the value of &lt;code class=&quot;language-text&quot;&gt;v2&lt;/code&gt; is 0, false (20 is not less than 10). &lt;code class=&quot;language-text&quot;&gt;if [ 1 -eq result ]&lt;/code&gt; then asks “if 1 is equal to result”, or more fluidly, “if result is true”. If it is, then you can see above that we reset &lt;code class=&quot;language-text&quot;&gt;MAX_VIS_DIST&lt;/code&gt; as it violates our 1000 rows and columns constraint.&lt;/p&gt;
&lt;h3&gt;Distance to the horizon&lt;/h3&gt;
&lt;p&gt;Now at this point it is a good idea to point out that I have actually picked arbitrary values for &lt;code class=&quot;language-text&quot;&gt;MAX_VIS_DIST&lt;/code&gt; in this example. There are more robust methods to determine the distance to the visible horizon that depend on the elevation of your position, and the curvature of the earth. The value can actually vary quite markedly. The GRASS documentation offers a nice approximation, but &lt;code class=&quot;language-text&quot;&gt;r.los&lt;/code&gt; itself does not take into account the curvature of the earth:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;The curvature of the Earth is not taken into account for these calculations. However, for interest’s sake, a handy calculation for distance to the true horizon is approximated by &lt;span class=&quot;katex&quot;&gt;&lt;span class=&quot;katex-mathml&quot;&gt;&lt;math&gt;&lt;semantics&gt;&lt;mrow&gt;&lt;mi&gt;d&lt;/mi&gt;&lt;mo&gt;=&lt;/mo&gt;&lt;msqrt&gt;&lt;mrow&gt;&lt;mn&gt;13&lt;/mn&gt;&lt;mi&gt;h&lt;/mi&gt;&lt;/mrow&gt;&lt;/msqrt&gt;&lt;/mrow&gt;&lt;annotation encoding=&quot;application/x-tex&quot;&gt;d = \sqrt{13h}&lt;/annotation&gt;&lt;/semantics&gt;&lt;/math&gt;&lt;/span&gt;&lt;span class=&quot;katex-html&quot; aria-hidden=&quot;true&quot;&gt;&lt;span class=&quot;base&quot;&gt;&lt;span class=&quot;strut&quot; style=&quot;height:0.69444em;vertical-align:0em;&quot;&gt;&lt;/span&gt;&lt;span class=&quot;mord mathdefault&quot;&gt;d&lt;/span&gt;&lt;span class=&quot;mspace&quot; style=&quot;margin-right:0.2777777777777778em;&quot;&gt;&lt;/span&gt;&lt;span class=&quot;mrel&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;mspace&quot; style=&quot;margin-right:0.2777777777777778em;&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;base&quot;&gt;&lt;span class=&quot;strut&quot; style=&quot;height:1.04em;vertical-align:-0.10777999999999999em;&quot;&gt;&lt;/span&gt;&lt;span class=&quot;mord sqrt&quot;&gt;&lt;span class=&quot;vlist-t vlist-t2&quot;&gt;&lt;span class=&quot;vlist-r&quot;&gt;&lt;span class=&quot;vlist&quot; style=&quot;height:0.93222em;&quot;&gt;&lt;span class=&quot;svg-align&quot; style=&quot;top:-3em;&quot;&gt;&lt;span class=&quot;pstrut&quot; style=&quot;height:3em;&quot;&gt;&lt;/span&gt;&lt;span class=&quot;mord&quot; style=&quot;padding-left:0.833em;&quot;&gt;&lt;span class=&quot;mord&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;mord&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;mord mathdefault&quot;&gt;h&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&quot;top:-2.89222em;&quot;&gt;&lt;span class=&quot;pstrut&quot; style=&quot;height:3em;&quot;&gt;&lt;/span&gt;&lt;span class=&quot;hide-tail&quot; style=&quot;min-width:0.853em;height:1.08em;&quot;&gt;&lt;svg width=&apos;400em&apos; height=&apos;1.08em&apos; viewBox=&apos;0 0 400000 1080&apos; preserveAspectRatio=&apos;xMinYMin slice&apos;&gt;&lt;path d=&apos;M95,702c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,
-10,-9.5,-14c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54c44.2,-33.3,65.8,
-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10s173,378,173,378c0.7,0,
35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429c69,-144,104.5,-217.7,106.5,
-221c5.3,-9.3,12,-14,20,-14H400000v40H845.2724s-225.272,467,-225.272,467
s-235,486,-235,486c-2.7,4.7,-9,7,-19,7c-6,0,-10,-1,-12,-3s-194,-422,-194,-422
s-65,47,-65,47z M834 80H400000v40H845z&apos;/&gt;&lt;/svg&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;vlist-s&quot;&gt;​&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;vlist-r&quot;&gt;&lt;span class=&quot;vlist&quot; style=&quot;height:0.10777999999999999em;&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt; where &lt;span class=&quot;katex&quot;&gt;&lt;span class=&quot;katex-mathml&quot;&gt;&lt;math&gt;&lt;semantics&gt;&lt;mrow&gt;&lt;mi&gt;h&lt;/mi&gt;&lt;/mrow&gt;&lt;annotation encoding=&quot;application/x-tex&quot;&gt;h&lt;/annotation&gt;&lt;/semantics&gt;&lt;/math&gt;&lt;/span&gt;&lt;span class=&quot;katex-html&quot; aria-hidden=&quot;true&quot;&gt;&lt;span class=&quot;base&quot;&gt;&lt;span class=&quot;strut&quot; style=&quot;height:0.69444em;vertical-align:0em;&quot;&gt;&lt;/span&gt;&lt;span class=&quot;mord mathdefault&quot;&gt;h&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt; is the height of the observer in meters (above sea level) and &lt;span class=&quot;katex&quot;&gt;&lt;span class=&quot;katex-mathml&quot;&gt;&lt;math&gt;&lt;semantics&gt;&lt;mrow&gt;&lt;mi&gt;d&lt;/mi&gt;&lt;/mrow&gt;&lt;annotation encoding=&quot;application/x-tex&quot;&gt;d&lt;/annotation&gt;&lt;/semantics&gt;&lt;/math&gt;&lt;/span&gt;&lt;span class=&quot;katex-html&quot; aria-hidden=&quot;true&quot;&gt;&lt;span class=&quot;base&quot;&gt;&lt;span class=&quot;strut&quot; style=&quot;height:0.69444em;vertical-align:0em;&quot;&gt;&lt;/span&gt;&lt;span class=&quot;mord mathdefault&quot;&gt;d&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt; is the distance to the horizon in km. This may be useful for setting the &lt;code class=&quot;language-text&quot;&gt;max_dist&lt;/code&gt; value.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;You could implement this in GRASS with a bit of &lt;code class=&quot;language-text&quot;&gt;bc&lt;/code&gt; and considering the elevation value of each cell beneath each observer point, but I’ll leave that as an exercise for the reader (God I hate that). Consider this a reminder that any proposed solution to a geographic problem can almost always be improved.&lt;/p&gt;
&lt;p&gt;A partial solution is to switch to GRASS 7.0: &lt;a href=&quot;http://grass.osgeo.org/grass70/manuals/r.viewshed.html&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;r.viewshed&lt;/code&gt;&lt;/a&gt; allows a &lt;code class=&quot;language-text&quot;&gt;-c&lt;/code&gt; flag that considers the curvature of the earth better than you could—with reference to the current ellipsoid:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;By default the elevations are not adjusted for the curvature of the earth. The user can turn this on with flag &lt;code class=&quot;language-text&quot;&gt;-c&lt;/code&gt;.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;However this &lt;strong&gt;still&lt;/strong&gt; doesn’t resolve the problem of determining the actual distance to the horizon. In part, this is because that also depends on atmospheric conditions. For example, on an exceptionally clear day, when the atmospheric pressure is just right, you can actually make out Mt. Taranaki when standing on the Kāpiti Coast!&lt;/p&gt;
&lt;h3&gt;Further preparation for the line of sight calculation&lt;/h3&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;# Load shapefile into GRASS&lt;/span&gt;
v.in.ogr dsn&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token variable&quot;&gt;$LINE_SHP&lt;/span&gt; output&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;line_feature --o --v

&lt;span class=&quot;token comment&quot;&gt;# Load elevation raster into GRASS and set it as the computational region&lt;/span&gt;
r.in.gdal --o input&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token variable&quot;&gt;$R_DEM&lt;/span&gt; output&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;dem --verbose

&lt;span class=&quot;token comment&quot;&gt;# Sample points along line&lt;/span&gt;
v.to.points -ivt in&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;line_feature out&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;line_feature_points dmax&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token variable&quot;&gt;$DIST_PTS&lt;/span&gt; --o --q

&lt;span class=&quot;token comment&quot;&gt;# Put point coordinates in text file&lt;/span&gt;
v.out.ascii -r in&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;line_feature_points fs&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;, --quiet &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;awk&lt;/span&gt; -F &lt;span class=&quot;token string&quot;&gt;&quot;\&quot;*,\&quot;*&quot;&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;{print &lt;span class=&quot;token variable&quot;&gt;$1&lt;/span&gt;&quot;,&quot;&lt;span class=&quot;token variable&quot;&gt;$2&lt;/span&gt;}&apos;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token variable&quot;&gt;$PTS_FILE&lt;/span&gt;

NPTS&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token variable&quot;&gt;&lt;span class=&quot;token variable&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;cat&lt;/span&gt; $PTS_FILE &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;wc&lt;/span&gt; -l&lt;span class=&quot;token variable&quot;&gt;`&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Try and see if you can work out what this section of code does. If you have GRASS running in your terminal, you can find out what any given GRASS command does with the following pattern: &lt;code class=&quot;language-text&quot;&gt;r.command --help&lt;/code&gt;, which is the same pattern for most commands at a UNIX terminal. You can also consult the online help.&lt;/p&gt;
&lt;p&gt;To summarise the help documents for the GRASS commands used here:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;v.in.ogr&lt;/code&gt;: Convert OGR vector layers to GRASS vector map.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;r.in.gdal&lt;/code&gt;: Import GDAL supported raster file into a binary raster map layer.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;v.to.points&lt;/code&gt;: Create points along input lines in new vector with 2 layers.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;v.out.ascii&lt;/code&gt;: Converts a GRASS binary vector map to a GRASS ASCII vector map.&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;In conjunction with the &lt;code class=&quot;language-text&quot;&gt;--help&lt;/code&gt; option and my comments, try and work out what exactly these comments are doing. They represent a stage of data preparation for the next processing step. Remember that the syntax &lt;code class=&quot;language-text&quot;&gt;$VARIABLE&lt;/code&gt; is a way to access the value of the variable called &lt;code class=&quot;language-text&quot;&gt;VARIABLE&lt;/code&gt;, we defined several of these near the beginning of the script. If you have any questions, leave a comment.&lt;/p&gt;
&lt;h2&gt;Computing viewsheds iteratively&lt;/h2&gt;
&lt;p&gt;The general logic of the viewshed calculation is to take a series of points sampled along a line feature, find all places on the terrain model that a person standing on each point can see, and then mosaic each of these together into a final visibility surface. There are ways to make this smarter, such as using the fact that once a cell has been identified as visible from any point, to never bother querying whether it is visible again. I don’t explore these, although I might if I ever need to re-use this code.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;echo&lt;/span&gt; -n &lt;span class=&quot;token string&quot;&gt;&quot;\nComputing viewsheds\n&quot;&lt;/span&gt;

COUNTER&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;0
&lt;span class=&quot;token keyword&quot;&gt;while&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;read&lt;/span&gt; -r line
  &lt;span class=&quot;token keyword&quot;&gt;do&lt;/span&gt;

  PCT_FLOAT&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token variable&quot;&gt;&lt;span class=&quot;token variable&quot;&gt;$(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;echo&lt;/span&gt; &quot;100*&lt;span class=&quot;token punctuation&quot;&gt;$((&lt;/span&gt;COUNTER+1&lt;span class=&quot;token variable&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;/&lt;span class=&quot;token variable&quot;&gt;$NPTS&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot; | bc -l)
  PCT=&lt;span class=&quot;token variable&quot;&gt;&lt;span class=&quot;token variable&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;printf&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;%0.1f\n&quot;&lt;/span&gt; $PCT_FLOAT&lt;span class=&quot;token variable&quot;&gt;`&lt;/span&gt;&lt;/span&gt;

  echo -ne &quot;&lt;/span&gt;Processing &lt;span class=&quot;token variable&quot;&gt;$NPTS&lt;/span&gt; viewshed instances: \t &lt;span class=&quot;token variable&quot;&gt;$PCT&lt;/span&gt; % &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token variable&quot;&gt;$COUNTER&lt;/span&gt;/&lt;span class=&quot;token variable&quot;&gt;$NPTS&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; \r&quot;

  &lt;span class=&quot;token comment&quot;&gt;# Set the region to a smaller subset around the current observer point&lt;/span&gt;
  &lt;span class=&quot;token comment&quot;&gt;#   to speed processing&lt;/span&gt;
  x&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token variable&quot;&gt;&lt;span class=&quot;token variable&quot;&gt;$(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;echo&lt;/span&gt; $line &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;cut&lt;/span&gt; -f1 -d,&lt;span class=&quot;token variable&quot;&gt;)&lt;/span&gt;&lt;/span&gt;
  y&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token variable&quot;&gt;&lt;span class=&quot;token variable&quot;&gt;$(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;echo&lt;/span&gt; $line &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;cut&lt;/span&gt; -f2 -d,&lt;span class=&quot;token variable&quot;&gt;)&lt;/span&gt;&lt;/span&gt;
  W&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token variable&quot;&gt;&lt;span class=&quot;token variable&quot;&gt;$(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;&lt;span class=&quot;token variable&quot;&gt;$x&lt;/span&gt;-&lt;span class=&quot;token variable&quot;&gt;$MAX_VIS_DIST&lt;/span&gt;&quot;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;bc&lt;/span&gt; -l&lt;span class=&quot;token variable&quot;&gt;)&lt;/span&gt;&lt;/span&gt;
  E&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token variable&quot;&gt;&lt;span class=&quot;token variable&quot;&gt;$(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;&lt;span class=&quot;token variable&quot;&gt;$x&lt;/span&gt;+&lt;span class=&quot;token variable&quot;&gt;$MAX_VIS_DIST&lt;/span&gt;&quot;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;bc&lt;/span&gt; -l&lt;span class=&quot;token variable&quot;&gt;)&lt;/span&gt;&lt;/span&gt;
  N&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token variable&quot;&gt;&lt;span class=&quot;token variable&quot;&gt;$(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;&lt;span class=&quot;token variable&quot;&gt;$y&lt;/span&gt;+&lt;span class=&quot;token variable&quot;&gt;$MAX_VIS_DIST&lt;/span&gt;&quot;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;bc&lt;/span&gt; -l&lt;span class=&quot;token variable&quot;&gt;)&lt;/span&gt;&lt;/span&gt;
  S&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token variable&quot;&gt;&lt;span class=&quot;token variable&quot;&gt;$(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;&lt;span class=&quot;token variable&quot;&gt;$y&lt;/span&gt;-&lt;span class=&quot;token variable&quot;&gt;$MAX_VIS_DIST&lt;/span&gt;&quot;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;bc&lt;/span&gt; -l&lt;span class=&quot;token variable&quot;&gt;)&lt;/span&gt;&lt;/span&gt;
  g.region n&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token variable&quot;&gt;$N&lt;/span&gt; s&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token variable&quot;&gt;$S&lt;/span&gt; e&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token variable&quot;&gt;$E&lt;/span&gt; w&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token variable&quot;&gt;$W&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;# Does not overwrite, so SIGINT (Ctrl+C) can be used to interrupt a&lt;/span&gt;
  &lt;span class=&quot;token comment&quot;&gt;#  long-running process, to be resumed later&lt;/span&gt;
  &lt;span class=&quot;token comment&quot;&gt;#  (keep parameters constant between runs)&lt;/span&gt;
  r.los input&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;dem output&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;tmp_los_&lt;span class=&quot;token variable&quot;&gt;${COUNTER}&lt;/span&gt; coordinate&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token variable&quot;&gt;$line&lt;/span&gt; obs_elev&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token variable&quot;&gt;$ELEV&lt;/span&gt; max_dist&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token variable&quot;&gt;$MAX_VIS_DIST&lt;/span&gt; --v
  COUNTER&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token variable&quot;&gt;&lt;span class=&quot;token variable&quot;&gt;$((&lt;/span&gt;COUNTER&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token variable&quot;&gt;))&lt;/span&gt;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;done&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token variable&quot;&gt;$PTS_FILE&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;We begin by creating a variable, &lt;code class=&quot;language-text&quot;&gt;COUNTER&lt;/code&gt;, to store our progress through an iteration. Then we start looping. That’s actually a bit hard to comprehend, so I’ll explain it closely:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;while&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;read&lt;/span&gt; -r line
  &lt;span class=&quot;token keyword&quot;&gt;do&lt;/span&gt;
  &lt;span class=&quot;token comment&quot;&gt;# do something&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;done&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token variable&quot;&gt;$PTS_FILE&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Notice that before this point, &lt;code class=&quot;language-text&quot;&gt;line&lt;/code&gt; didn’t exist. &lt;code class=&quot;language-text&quot;&gt;line&lt;/code&gt; is actually being defined on the last line of the loop syntax: &lt;code class=&quot;language-text&quot;&gt;done &amp;lt; $PTS_FILE&lt;/code&gt; pipes the text file &lt;code class=&quot;language-text&quot;&gt;$PTS_FILE&lt;/code&gt;, representing a sequence of points along a line, into the for loop; each line of the file is then put into a variable called &lt;code class=&quot;language-text&quot;&gt;$line&lt;/code&gt; that we access during the execution of each loop.&lt;/p&gt;
&lt;p&gt;The first thing that gets done in the body of the loop is to return some information to the terminal, reporting on the progress of the loop. See if you now understand enough about &lt;code class=&quot;language-text&quot;&gt;bc&lt;/code&gt; to see how &lt;code class=&quot;language-text&quot;&gt;PCT_FLOAT&lt;/code&gt; is the progress of the loop expressed as a percentage value of floating point precision. &lt;code class=&quot;language-text&quot;&gt;PCT&lt;/code&gt; stores the result rounded to one decimal place.&lt;/p&gt;
&lt;h3&gt;GRASS regions&lt;/h3&gt;
&lt;p&gt;Next up, we use a bit of black magic to speed up the processing. GRASS uses the concept of “regions” when running calculations. Every command will consider the current region, and nothing will be done outside of that region. So if you’re calculating a viewshed (a very expensive procedure), and you know the maximum distance that you consider viewable from any point, you can tell GRASS that its region can be as small as that area. Annotated code:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;# Set the region to a smaller subset around the current observer point to speed processing&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;# Note that this assumes the source line feature is projected in metres&lt;/span&gt;
x&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token variable&quot;&gt;&lt;span class=&quot;token variable&quot;&gt;$(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;echo&lt;/span&gt; $line &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;cut&lt;/span&gt; -f1 -d,&lt;span class=&quot;token variable&quot;&gt;)&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;# Get the x coordinate value from line, the current observer point&lt;/span&gt;
y&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token variable&quot;&gt;&lt;span class=&quot;token variable&quot;&gt;$(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;echo&lt;/span&gt; $line &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;cut&lt;/span&gt; -f2 -d,&lt;span class=&quot;token variable&quot;&gt;)&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;# The corresponding y value&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Try &lt;code class=&quot;language-text&quot;&gt;cut --help&lt;/code&gt; coupled with the clue that &lt;code class=&quot;language-text&quot;&gt;$line&lt;/code&gt; is comma-delimited, if you don’t understand this.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;W&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token variable&quot;&gt;&lt;span class=&quot;token variable&quot;&gt;$(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;&lt;span class=&quot;token variable&quot;&gt;$x&lt;/span&gt;-&lt;span class=&quot;token variable&quot;&gt;$MAX_VIS_DIST&lt;/span&gt;&quot;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;bc&lt;/span&gt; -l&lt;span class=&quot;token variable&quot;&gt;)&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;# x minus the maximum visible distance: the western reach of the region&lt;/span&gt;
E&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token variable&quot;&gt;&lt;span class=&quot;token variable&quot;&gt;$(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;&lt;span class=&quot;token variable&quot;&gt;$x&lt;/span&gt;+&lt;span class=&quot;token variable&quot;&gt;$MAX_VIS_DIST&lt;/span&gt;&quot;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;bc&lt;/span&gt; -l&lt;span class=&quot;token variable&quot;&gt;)&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;# x + MAX_VIS_DIST: eastern reach&lt;/span&gt;
N&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token variable&quot;&gt;&lt;span class=&quot;token variable&quot;&gt;$(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;&lt;span class=&quot;token variable&quot;&gt;$y&lt;/span&gt;+&lt;span class=&quot;token variable&quot;&gt;$MAX_VIS_DIST&lt;/span&gt;&quot;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;bc&lt;/span&gt; -l&lt;span class=&quot;token variable&quot;&gt;)&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;# y + MAX_VIS_DIST: northern reach&lt;/span&gt;
S&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token variable&quot;&gt;&lt;span class=&quot;token variable&quot;&gt;$(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;&lt;span class=&quot;token variable&quot;&gt;$y&lt;/span&gt;-&lt;span class=&quot;token variable&quot;&gt;$MAX_VIS_DIST&lt;/span&gt;&quot;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;bc&lt;/span&gt; -l&lt;span class=&quot;token variable&quot;&gt;)&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;# y - MAX_VIS_DIST: southern reach&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Finally, we use this command to actually set the region in each iteration: &lt;code class=&quot;language-text&quot;&gt;g.region n=$N s=$S e=$E w=$W&lt;/code&gt;. I found that resetting the region each loop was remarkably faster than leaving the region equal to the union of all inputs.&lt;/p&gt;
&lt;p&gt;&lt;figure class=&quot;blog-figure&quot;&gt;&lt;img src=&quot;/grass70_rviewshed-80811a1ed5d6145d2008f23b8ee5d9d7.gif&quot; class=&quot;blog-img&quot;&gt;&lt;figcaption class=&quot;blog-figcaption&quot;&gt;rviewshed is fast in Grass 7.0&lt;/figcaption&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;The final section of the loop performs the following:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;r.los input&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;dem output&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;tmp_los_&lt;span class=&quot;token variable&quot;&gt;${COUNTER}&lt;/span&gt; coordinate&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token variable&quot;&gt;$line&lt;/span&gt; obs_elev&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token variable&quot;&gt;$ELEV&lt;/span&gt; max_dist&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token variable&quot;&gt;$MAX_VIS_DIST&lt;/span&gt; --v
COUNTER&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token variable&quot;&gt;&lt;span class=&quot;token variable&quot;&gt;$((&lt;/span&gt;COUNTER&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token variable&quot;&gt;))&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;r.los&lt;/code&gt; is the command that we’re really here for. It takes an input DEM, outputs a raster named &lt;code class=&quot;language-text&quot;&gt;tmp_los_&lt;/code&gt; plus whatever the counter is up to, a point value (our &lt;code class=&quot;language-text&quot;&gt;$line&lt;/code&gt; variable), and the observer elevation… and it goes away and tells us what that observer can see. Well, not really &lt;em&gt;what&lt;/em&gt; they can see, more &lt;em&gt;where&lt;/em&gt; they can see. The “what” can come later with some more Spatial Science™. For now, we close the loop and give it its input to set it in motion: &lt;code class=&quot;language-text&quot;&gt;done &amp;lt; $PTS_FILE&lt;/code&gt;.&lt;/p&gt;
&lt;h3&gt;One Viewshed To Rule Them All&lt;/h3&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;# Set computational region to full extent&lt;/span&gt;
g.region -pm rast&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;dem --verbose

&lt;span class=&quot;token comment&quot;&gt;# Combine results in a single map&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;#   (aggregation method doesn&apos;t matter as we use&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;#   this as a boolean mask)&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;\nCombining component viewsheds\n&quot;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;# Loops because otherwise can easily exceed default hard limit of number of&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;#   rasters that can be open at once (1024)&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; i &lt;span class=&quot;token keyword&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;token variable&quot;&gt;&lt;span class=&quot;token variable&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;seq&lt;/span&gt; 0 99&lt;span class=&quot;token variable&quot;&gt;`&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;do&lt;/span&gt;
  &lt;span class=&quot;token comment&quot;&gt;# Combine a subset of all the viewsheds&lt;/span&gt;
  &lt;span class=&quot;token comment&quot;&gt;# * is a wildcard for zero or more characters&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;token variable&quot;&gt;$i&lt;/span&gt; -le 9 &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;# If i &amp;lt;= 9&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;then&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;# append a 0 to the start of $i&lt;/span&gt;
    PATT&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;tmp_los_*0&lt;span class=&quot;token variable&quot;&gt;$i&lt;/span&gt;
    OUT&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;total_los_0&lt;span class=&quot;token variable&quot;&gt;$i&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;# don&apos;t modify the pattern of $i&lt;/span&gt;
    PATT&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;tmp_los_*&lt;span class=&quot;token variable&quot;&gt;$i&lt;/span&gt;
    OUT&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;total_los_&lt;span class=&quot;token variable&quot;&gt;$i&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;fi&lt;/span&gt;
  r.series in&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token variable&quot;&gt;&lt;span class=&quot;token variable&quot;&gt;`&lt;/span&gt;g.mlist --q type&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;rast pattern&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;$PATT sep&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;,&lt;span class=&quot;token variable&quot;&gt;`&lt;/span&gt;&lt;/span&gt; out&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token variable&quot;&gt;$OUT&lt;/span&gt; method&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;sum --o --q
&lt;span class=&quot;token keyword&quot;&gt;done&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Now that we have created each of the viewsheds for each of the points we sampled along the road or train line, we want to combine these individual raster layers into a single raster layer.&lt;/p&gt;
&lt;p&gt;There is considerable scope for interesting complexity here. For instance, you could combine the results additively, thereby building a surface where each cell has a value from 0 (never seen) to a potentially very large number (seen from many of the points along the route). If you assume that the train travels at a constant speed, this surface would tell you how long you spend looking at any given 25x25 metre grid cell. You could then use this to determine what type of forest you spend more time looking at: native or exotic.&lt;/p&gt;
&lt;p&gt;I’m going for an easy option: not worrying about how the layers are combined. I want a simple Boolean surface: can a cell be seen at any point in the trip, or can it never be seen? There’s no room for ambiguity, and the result is not as useful as the rest of the code allows it to be. But, I don’t have a “real” application for this to matter. If you want to fork the repository again on Github and explore this for yourself, go right ahead!&lt;/p&gt;
&lt;p&gt;First, we use &lt;code class=&quot;language-text&quot;&gt;g.region&lt;/code&gt; to reset the region to the full extent of our input raster layer. Recall that without this command, the region would be stuck at whatever it was in the last iteration of the preceding loop!&lt;/p&gt;
&lt;p&gt;Then (after some comments and printing information to stdout) we enter a loop that seems a little unnecessary. If we’re combining a bunch of raster layers together all at once, why do we need a loop? The answer is because GRASS 6.4 does not like it if you try and open more than 1024 rasters at any one time. As we would have made thousands of new rasters by this point, we cannot actually combine them all at once; rather we have to do it gingerly, in stages.&lt;/p&gt;
&lt;p&gt;Therefore the pseudo-code is to:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;Start a loop from 0 to 99&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Get the value of the iterator in the style of 00, 01, 02, …, 98, 99 (i.e. a leading zero for numbers less than 10).&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Create a pattern variable (&lt;code class=&quot;language-text&quot;&gt;PATT&lt;/code&gt;) to store the pattern that our input point-specific viewshed rasters follow if their filename ends with 01, or 02, or whatever the iterator is at. (This will allow us to process roughly 1% of the input rasters in each step.)&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Perform the actual combination for a subset of the layers matching &lt;code class=&quot;language-text&quot;&gt;PATT&lt;/code&gt;.&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;r.series&lt;/code&gt; is the key command of the above codeblock. It takes as its &lt;code class=&quot;language-text&quot;&gt;in&lt;/code&gt; parameter a list of layers that is constructed by a second command, &lt;code class=&quot;language-text&quot;&gt;g.mlist&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;.g.mlist&lt;/code&gt; is a &lt;strong&gt;very&lt;/strong&gt; handy GRASS command. Take a look at its description in its help:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Lists available GRASS data base files of the user-specified data type optionally using the search pattern.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;So when we want to combine only a fraction of our intermediate viewshed rasters at one time, we tell &lt;code class=&quot;language-text&quot;&gt;g.mlist&lt;/code&gt; to go away and find all layers that match a particular pattern (e.g. all rasters called &lt;code class=&quot;language-text&quot;&gt;&amp;quot;name_\*00&amp;quot;&lt;/code&gt;, where &lt;code class=&quot;language-text&quot;&gt;*&lt;/code&gt; is a wildcard—that is, all of our intermediate layers ending in “00”). &lt;code class=&quot;language-text&quot;&gt;r.series&lt;/code&gt; then takes this list of layers and combines them with the &lt;code class=&quot;language-text&quot;&gt;method&lt;/code&gt; we have specified. (I used &lt;code class=&quot;language-text&quot;&gt;sum&lt;/code&gt;, although as I said I actually ignore this.)&lt;/p&gt;
&lt;p&gt;What we’re then left with is a series of 99 raster layers, each representing a small part of what will become our finished product.&lt;/p&gt;
&lt;div class=&quot;sidenote&quot;&gt;
  &lt;p&gt;
  I realise now that it would be smarter to combine the intermediate layer with the pattern-match layers as part of the above loop... but at the price of one additional &lt;code&gt;r.series&lt;/code&gt; it ain&apos;t the end of the world.
  &lt;p&gt;
&lt;/div&gt;
&lt;p&gt;So, combine these up into our finished product with another pattern matching exercise:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;r.series in&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token variable&quot;&gt;&lt;span class=&quot;token variable&quot;&gt;`&lt;/span&gt;g.mlist --q type&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;rast pattern&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;total_los_* sep&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;,&lt;span class=&quot;token variable&quot;&gt;`&lt;/span&gt;&lt;/span&gt; out&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;total_los method&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;sum --o --q&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;You could display the result now if you wanted the map to represent the number of times each cell has been determined as being “viewable”. I actually like the idea of a binary (viewable/not viewable) surface, where shading can be used to indicate distance from the line feature. So that’s what I’ll do. However it may be a little misleading, as distance from the line feature used in the exercise is not technically synonymous with the minimum distance from which it can be seen!&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;# Create distance to line_feature map&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;\nDetermining distance from features\n&quot;&lt;/span&gt;
v.to.rast in&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;line_feature out&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;line_feature use&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;val val&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;1 --o --q
r.grow.distance -m input&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;line_feature distance&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;dist_from_line_feature --o --q&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;This takes our line feature input and turns it into a raster; it then “grows” (raster buffers) this line… how far? To the same size as the entire GRASS region. There is no need to tell GRASS that; and it stores the output surface as a dataset specified by the rather misleading title of &lt;code class=&quot;language-text&quot;&gt;distance&lt;/code&gt;.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;# Use distance to line_feature instead of sum of times seen in the result map&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;\nSubstituting number of times seen for distance to cell from line\n&quot;&lt;/span&gt;
r.mapcalc &lt;span class=&quot;token string&quot;&gt;&quot;&lt;span class=&quot;token variable&quot;&gt;$OUTFILE&lt;/span&gt; = if(total_los, dist_from_line_feature, null())&quot;&lt;/span&gt; --o --v&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Here we use a bit of raster calculation (otherwise known as image manipulation) to make a new layer. To put the if statement into human terms: “if there is a  non-null value of &lt;code class=&quot;language-text&quot;&gt;total_los&lt;/code&gt; (i.e. a cell has been identified as visible), substitute its value with the value of the equivalent cell from the layer &lt;code class=&quot;language-text&quot;&gt;dist_from_line_feature&lt;/code&gt; (a raster surface where each cell knows its minimum distance from the line feature), otherwise make its value null.&lt;/p&gt;
&lt;p&gt;The rest should be self-explanatory:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;# Write output (as geotiff)&lt;/span&gt;
r.out.gdal input&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token variable&quot;&gt;$OUTFILE&lt;/span&gt; output&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;..&lt;/span&gt;/data/output/&lt;span class=&quot;token variable&quot;&gt;$OUTFILE&lt;/span&gt;.tif format&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;GTiff --o --v

&lt;span class=&quot;token comment&quot;&gt;# Clean up, removing the component visibility rasters, only after outputs have been written&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;\nDeleting temporary files\n&quot;&lt;/span&gt;
g.mremove -f &lt;span class=&quot;token string&quot;&gt;&quot;tmp_los_*&quot;&lt;/span&gt; --q
g.mremove -f &lt;span class=&quot;token string&quot;&gt;&quot;total_los_*&quot;&lt;/span&gt; --q

&lt;span class=&quot;token keyword&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;\ngenerate_los.sh complete\n&quot;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;The final output is simply a GeoTiff. Try opening it in QGIS if you have been playing along at home. If you’re just reading, then in the &lt;a href=&quot;http://www.nearimprov.com/train-landscapes&quot;&gt;interactive map&lt;/a&gt;, the output GeoTiff is the special coloured layer you see on top of the basemap.&lt;/p&gt;
&lt;p&gt;So how do we get to this next stage?&lt;/p&gt;
&lt;h1&gt;Making Mapnik tiles with QTiles&lt;/h1&gt;
&lt;p&gt;There are a variety of ways to make map tiles.{% sidenote “sn-id-tiles” “Don’t know what tiles are? That’s OK, everyone had to find out at some point. I really liked &lt;a href=&quot;http://lyzidiamond.com/leaflet/#0&quot;&gt;this introduction&lt;/a&gt; by &lt;a href=&quot;https://twitter.com/lyzidiamond&quot;&gt;Lyzi Diamond&lt;/a&gt;.” %} The simplest method for constructing map tiles, in my opinion, is to use a QGIS plugin called &lt;a href=&quot;https://github.com/nextgis/QTiles&quot;&gt;QTiles&lt;/a&gt;. You can control all your styling and extents with QGIS layers, and then just tell the plugin to go away and make your map tiles.&lt;/p&gt;
&lt;p&gt;To find out how to install a QGIS plugin, look &lt;a href=&quot;http://www.qgistutorials.com/en/docs/using_plugins.html&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;The process for our purposes is rather simple.&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;The GRASS script spits out a GeoTiff.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;You add that to a QGIS project via the add raster layer button.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;The GRASS script also had access to a vector line feature (as well as creating a CSV point dataset from that). You can add one or both of these via the add vector layer button.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;To add context, add a pre-existing baselayer, or make your own. For example, you could create a colour relief map (hypsometric tint). &lt;a href=&quot;https://www.mapbox.com/tilemill/docs/guides/terrain-data/&quot;&gt;Mapbox has a good tutorial using more command line GIS&lt;/a&gt;, this time GDAL. I just took the easy route (again), and went for a Web Mapping Service (&lt;a href=&quot;https://data.linz.govt.nz/p/web-services/&quot;&gt;WMS&lt;/a&gt;) from the good folk at Landcare Research. Look for the add data button in the sidebar with the tooltip “Add WMS/WMST Layer”. When it opens, create a new connection using the URL to the Landcare Research WMS: &lt;code class=&quot;language-text&quot;&gt;http://maps.scinfo.org.nz/basemaps/wms?&lt;/code&gt;. There are a variety of layers you can add (see image); the one I used is called the “Landcover Terrain Map”.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Once you’ve added this basemap, styled and ordered your layers and are happy with the appearance of your map, install QTiles and fire it up via the menu Plugins &gt; QTiles &gt; QTiles. See the second image below for example parameters. Just be cautious before going ahead with your settings: you are generating exponentially more tiles (i.e. PNG images) for each additional level of zoom (1 is the most zoomed out, 18 is the most zoomed in). I only generated tiles between zoom levels 7 and 13, because I knew I was going to restrict the user to these zoom levels in the end. Allow the tool to run, and you’re ready to make a web map.&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;&lt;figure class=&quot;blog-figure&quot;&gt;&lt;img src=&quot;./LR-example.pn&quot; title=&quot;Screenshot from QGIS 2.8, of the Landcare Research WMS.&quot; class=&quot;blog-img&quot;&gt;&lt;figcaption class=&quot;blog-figcaption&quot;&gt;Screenshot from QGIS 2.8, of the Landcare Research WMS.&lt;/figcaption&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;
  &lt;figure class=&quot;gatsby-resp-image-figure&quot; style=&quot;&quot;&gt;
  
  &lt;span
    class=&quot;gatsby-resp-image-wrapper&quot;
    style=&quot;position: relative; display: block;  max-width: 539px; margin-left: auto; margin-right: auto;&quot;
  &gt;
    &lt;span
      class=&quot;gatsby-resp-image-background-image&quot;
      style=&quot;padding-bottom: 89.23933209647497%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAASCAIAAADUsmlHAAAACXBIWXMAAAsSAAALEgHS3X78AAACPElEQVQ4y41Sy27TQBSdL0UIIVRVPLoBwYIdLFjxA4gFsKCkJQmKlB1dJIUmju0Zjz2eGb/tJE1w06B8AcdO1BYKKUfX4+vxfZw5c8nLV693Hjze3Xv67PmL3b0nt+7ev33v4f/YnZ1H5OBz683b9x8bzS+dbuOwvd9ofjpo3WSIab77sE+k9CnjwvdPT6ewosiLPCvy/Jpl6/28XstyLoRPpFJ5mlCbcu5qrTnnDr+E666ftV87juMJEejg+NtJlRxr7XLXsqnnCaVUGEVhEKCQVgqvIAiiMFQKgcr3pZI+tkDANC2CGFQyLdsYmR7YC4EO5dnZz+XyHLbBhbPxV6sVOhGQtCxbShXHcZIkWMMwTLYCMVVnyyKUMmNkMYeDEiigOf5FW4HqaZoaxojoQE/zzLbs7yfDwdAAGfzI0huAzhVtKWUcBJw5tk2hWRTHnucxxvhWOI6DRAINi6KASMxxKGPQdDAYfj066vf7x/9Gr9ejlBKb0pFpxQk0yPIsgx4V7SvA519lw+EJSOKoNqbMdR3uXpcHyfP5/MfvKMsSfHHPirueYZo4M247gJLJH61iRC8v7/x8sVhgnUwmREgF5kirkyluqx4tJauJ2gDaTibT8Xhc1JhOp7PZDFWJMEdSa7+C9KV0XQ+a4xSMOXAwBXY9CJg/zEI9CAJCoFyVHFO7XCxQaX0wkBF1lSiGclk91xF2lA6SNEMAItcSYpYILtTCjF8Bq0FrXLhCCOgKM02z0+m02u1ut/sL5bRxlgJNvyEAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
    &gt;
      &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        style=&quot;width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;&quot;
        alt=&quot;Screenshot from QGIS 2.8, QTiles plugin.&quot;
        title=&quot;Screenshot from QGIS 2.8, QTiles plugin.&quot;
        src=&quot;/static/c2b19fa095ca14fbfa6c4dd121c61969/22c5a/qtiles.png&quot;
        srcset=&quot;/static/c2b19fa095ca14fbfa6c4dd121c61969/c449c/qtiles.png 148w,
/static/c2b19fa095ca14fbfa6c4dd121c61969/881da/qtiles.png 295w,
/static/c2b19fa095ca14fbfa6c4dd121c61969/22c5a/qtiles.png 539w&quot;
        sizes=&quot;(max-width: 539px) 100vw, 539px&quot;
      /&gt;
    &lt;/span&gt;
  &lt;/span&gt;
  
  &lt;figcaption class=&quot;gatsby-resp-image-figcaption&quot;&gt;Screenshot from QGIS 2.8, QTiles plugin.&lt;/figcaption&gt;
  &lt;/figure&gt;
      &lt;/p&gt;
&lt;h1&gt;Making a web-ready map with Leaflet&lt;/h1&gt;
&lt;p&gt;There are lots of good tutorials on making webmaps, and I encourage you to explore them. I don’t consider myself very good at making them (yet). This is a very simple example, using two tile datasets and allowing the user to switch between them.&lt;/p&gt;
&lt;p&gt;First, let’s look at the HTML: the webpage that will contain our map. (The map itself is made in a JavaScript script.) The HTML is divided into the &lt;code class=&quot;language-text&quot;&gt;head&lt;/code&gt; and the &lt;code class=&quot;language-text&quot;&gt;body&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;The head:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;html&quot;&gt;&lt;pre class=&quot;language-html&quot;&gt;&lt;code class=&quot;language-html&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;head&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;
  &lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;meta&lt;/span&gt; &lt;span class=&quot;token attr-name&quot;&gt;charset&lt;/span&gt;&lt;span class=&quot;token attr-value&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;utf-8&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;
  &lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;meta&lt;/span&gt; &lt;span class=&quot;token attr-name&quot;&gt;http-equiv&lt;/span&gt;&lt;span class=&quot;token attr-value&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;X-UA-Compatible&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;token attr-name&quot;&gt;content&lt;/span&gt;&lt;span class=&quot;token attr-value&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;IE=edge&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;

  &lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;meta&lt;/span&gt; &lt;span class=&quot;token attr-name&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;token attr-value&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;viewport&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;token attr-name&quot;&gt;content&lt;/span&gt;&lt;span class=&quot;token attr-value&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;width=device-width, initial-scale=1.0&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;

  &lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;link&lt;/span&gt; &lt;span class=&quot;token attr-name&quot;&gt;rel&lt;/span&gt;&lt;span class=&quot;token attr-value&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;stylesheet&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;token attr-name&quot;&gt;href&lt;/span&gt;&lt;span class=&quot;token attr-value&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.css&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;/&gt;&lt;/span&gt;&lt;/span&gt;
  &lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;link&lt;/span&gt; &lt;span class=&quot;token attr-name&quot;&gt;rel&lt;/span&gt;&lt;span class=&quot;token attr-value&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;stylesheet&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;token attr-name&quot;&gt;href&lt;/span&gt;&lt;span class=&quot;token attr-value&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;./source/style.css&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;/&gt;&lt;/span&gt;&lt;/span&gt;

  &lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;meta&lt;/span&gt; &lt;span class=&quot;token attr-name&quot;&gt;http-equiv&lt;/span&gt;&lt;span class=&quot;token attr-value&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;Content-type&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;token attr-name&quot;&gt;content&lt;/span&gt;&lt;span class=&quot;token attr-value&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;text/html; charset=utf-8&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;/&gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;/&lt;/span&gt;head&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;This is all pretty standard, if you’ve ever hit “View Page Source” on a webpage. Can you see where we tell the page to read the Leaflet CSS (&lt;code class=&quot;language-text&quot;&gt;leaflet.css&lt;/code&gt;)? And a custom bit of CSS (&lt;code class=&quot;language-text&quot;&gt;style.css&lt;/code&gt;)?&lt;/p&gt;
&lt;p&gt;Now for the body:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;html&quot;&gt;&lt;pre class=&quot;language-html&quot;&gt;&lt;code class=&quot;language-html&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;body&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;
    &lt;span class=&quot;token comment&quot;&gt;&amp;lt;!-- header div --&gt;&lt;/span&gt;
    &lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;div&lt;/span&gt; &lt;span class=&quot;token attr-name&quot;&gt;id&lt;/span&gt;&lt;span class=&quot;token attr-value&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;title-text&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;
      &lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;h2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;
        Travelling overland between Auckland and Wellington: what can you see?
      &lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;/&lt;/span&gt;h2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;
    &lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;/&lt;/span&gt;div&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;
    &lt;span class=&quot;token comment&quot;&gt;&amp;lt;!-- map div --&gt;&lt;/span&gt;
    &lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;div&lt;/span&gt; &lt;span class=&quot;token attr-name&quot;&gt;id&lt;/span&gt;&lt;span class=&quot;token attr-value&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;map&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;/&lt;/span&gt;div&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;
    &lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;script&lt;/span&gt; &lt;span class=&quot;token attr-name&quot;&gt;src&lt;/span&gt;&lt;span class=&quot;token attr-value&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.js&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token script language-javascript&quot;&gt;&lt;/span&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;/&lt;/span&gt;script&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;
    &lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;script&lt;/span&gt; &lt;span class=&quot;token attr-name&quot;&gt;src&lt;/span&gt;&lt;span class=&quot;token attr-value&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;./source/make_map.js&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;token attr-name&quot;&gt;type&lt;/span&gt;&lt;span class=&quot;token attr-value&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;text/javascript&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token script language-javascript&quot;&gt;&lt;/span&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;/&lt;/span&gt;script&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;/&lt;/span&gt;body&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;We have two &lt;code class=&quot;language-text&quot;&gt;div&lt;/code&gt; elements in the body, and two scripts. The first &lt;code class=&quot;language-text&quot;&gt;div&lt;/code&gt; contains the header text you see at the top of the map. The second &lt;code class=&quot;language-text&quot;&gt;div&lt;/code&gt;, with the ID of &lt;code class=&quot;language-text&quot;&gt;&amp;quot;map&amp;quot;&lt;/code&gt;, contains our map, although there is very little indication yet that it actually does anything. The clue lies in the two pieces of JavaScript that get loaded next. The first is the standard Leaflet JavaScript that brings along the functionality of every Leaflet slippy map you’ve ever seen. The second is a custom bit of code where we specify our own special map. This bit of code is in the Github respository, and is called &lt;code class=&quot;language-text&quot;&gt;make_map.js&lt;/code&gt;. Let’s take a look at that next.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;var&lt;/span&gt; carViewshed &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;https://s3-ap-southeast-2.amazonaws.com/train-landscapes/car/{z}/{x}/{y}.png&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    trainViewshed &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;https://s3-ap-southeast-2.amazonaws.com/train-landscapes/rail/Mapnik/{z}/{x}/{y}.png&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    southWest &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;41.722&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;171.748&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    northEast &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;36.441&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;179.124&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    bounds &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;southWest&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; northEast&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    attribution &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;Richard Law | \
    Pierre Roudier | \
    Basemap © &amp;lt;a href=&quot;http://maps.scinfo.org.nz/&quot;&gt;Landcare Research&amp;lt;/a&gt; 2014. Contains data sourced from LINZ. Crown Copyright Reserved. &amp;lt;a href=&quot;http://creativecommons.org/licenses/by/3.0/nz/&quot;&gt;CC BY 3.0 NZ&amp;lt;/a&gt; | \
    &amp;lt;a href=&quot;https://koordinates.com/layer/40-nz-road-centrelines-topo-150k/&quot;&gt;LINZ&amp;lt;/a&gt; &amp;lt;a href=&quot;http://creativecommons.org/licenses/by/3.0/nz/&quot;&gt;CC BY 3.0 NZ&amp;lt;/a&gt; | \
    &amp;lt;a href=&quot;http://grass.osgeo.org/&quot;&gt;GRASS GIS&amp;lt;/a&gt;&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    global_min_zoom &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;7&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    global_max_zoom &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;13&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;var&lt;/span&gt; map &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;L&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Map&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;map&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
map&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;setView&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;38.6875&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;176.0694&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;7&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;//centre and zoom of map, initially&lt;/span&gt;
map&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;setMaxBounds&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;bounds&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
map&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;options&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;minZoom &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; global_min_zoom&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
map&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;options&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;maxZoom &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; global_max_zoom&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;var&lt;/span&gt; car &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;L&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;tileLayer&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;carViewshed&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  attribution&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; attribution&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  bounds&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; bounds&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  minZoom&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; global_min_zoom&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  maxZoom&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; global_max_zoom&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  tms&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  isBaseLayer&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;addTo&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;map&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;//default layer, so add to map&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;var&lt;/span&gt; train &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;L&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;tileLayer&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;trainViewshed&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  attribution&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; attribution&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  bounds&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; bounds&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  minZoom&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; global_min_zoom&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  maxZoom&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; global_max_zoom&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  tms&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  isBaseLayer&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;//non-default layer, so don&apos;t add to map&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;var&lt;/span&gt; viewshedBasemaps &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token string&quot;&gt;&quot;Car/bus view&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; car&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token string&quot;&gt;&quot;Overlander view&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; train
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;// Add the layer control to the map&lt;/span&gt;
&lt;span class=&quot;token constant&quot;&gt;L&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;control&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;layers&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;viewshedBasemaps&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;addTo&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;map&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;The first unbroken section of code above creates a bunch of variables. While the &lt;code class=&quot;language-text&quot;&gt;var&lt;/code&gt; keyword is only used once, it could be used on each line if the commas at the end were omitted. &lt;code class=&quot;language-text&quot;&gt;carViewshed&lt;/code&gt; and &lt;code class=&quot;language-text&quot;&gt;trainViewshed&lt;/code&gt; are the relative paths to the hosted folders that contain the tiles we made earlier with QTiles. (I’ll explain the Amazon business soon.) &lt;code class=&quot;language-text&quot;&gt;southWest&lt;/code&gt; and &lt;code class=&quot;language-text&quot;&gt;northEast&lt;/code&gt; are global parameters that I use to constrain the user’s ability to move: I only want them to be able to scroll around the North Island… mostly because that’s the only place I’ve actually created any map. The variables &lt;code class=&quot;language-text&quot;&gt;attribution&lt;/code&gt;, if you’re paying attention, is the bit of text you see at the bottom of the map. Leaflet is good about using that, and so should you be.&lt;/p&gt;
&lt;p&gt;Notice that &lt;code class=&quot;language-text&quot;&gt;global_max_zoom&lt;/code&gt; and &lt;code class=&quot;language-text&quot;&gt;global_min_zoom&lt;/code&gt; correspond to the numbers I used in the tile generation step. I didn’t make tiles beyond the range 7-13, so I don’t let the user zoom beyond that range (otherwise they’d see nothing).&lt;/p&gt;
&lt;p&gt;I then make a very important variable, &lt;code class=&quot;language-text&quot;&gt;map&lt;/code&gt;, and set a few of its options:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;var&lt;/span&gt; map &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;L&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Map&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;map&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
map&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;setView&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;38.6875&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;176.0694&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;7&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;//centre and zoom of map, initially&lt;/span&gt;
map&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;setMaxBounds&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;bounds&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
map&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;options&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;minZoom &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; global_min_zoom&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
map&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;options&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;maxZoom &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; global_max_zoom&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Later, we will call on this &lt;code class=&quot;language-text&quot;&gt;map&lt;/code&gt; to actually display (you guessed it) a map.&lt;/p&gt;
&lt;p&gt;But first, I need to tell it what it’s allowed to display.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;var&lt;/span&gt; car &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;L&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;tileLayer&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;carViewshed&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  attribution&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; attribution&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  bounds&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; bounds&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  minZoom&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; global_min_zoom&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  maxZoom&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; global_max_zoom&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  tms&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  isBaseLayer&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;addTo&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;map&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;//default layer, so add to map&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;var&lt;/span&gt; train &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;L&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;tileLayer&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;trainViewshed&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  attribution&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; attribution&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  bounds&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; bounds&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  minZoom&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; global_min_zoom&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  maxZoom&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; global_max_zoom&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  tms&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  isBaseLayer&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;//non-default layer, so don&apos;t add to map&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;I made two tile datasets, for the view from the car and from the train. The syntax for accessing them is naturally quite similar. There are more settings I didn’t play with, and I even commented out two that didn’t work very well after some experimentation.&lt;/p&gt;
&lt;p&gt;Without this next block of code, the map would function, but you would never be able to get to the &lt;code class=&quot;language-text&quot;&gt;train&lt;/code&gt; tiles. So we add a controller to allow a user to switch between our two sets of map tiles:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;var&lt;/span&gt; viewshedBasemaps &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token string&quot;&gt;&quot;Car/bus view&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; car&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token string&quot;&gt;&quot;Overlander view&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; train
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;// Add the layer control to the map&lt;/span&gt;
&lt;span class=&quot;token constant&quot;&gt;L&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;control&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;layers&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;viewshedBasemaps&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;addTo&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;map&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;L&lt;/code&gt; refers to Leaflet, and I nutted out this bit of code by reading their excellent documentation. Note that &lt;code class=&quot;language-text&quot;&gt;car&lt;/code&gt; and &lt;code class=&quot;language-text&quot;&gt;train&lt;/code&gt; here are the &lt;code class=&quot;language-text&quot;&gt;L.tileLayer&lt;/code&gt; variables we just defined. We tell Leaflet that we have two tile layers that we want to add to its set of &lt;code class=&quot;language-text&quot;&gt;control.layers&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;The final bit of work is to add some CSS. Stepping through the below code, we have the style for:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;The webpage as a whole.&lt;/li&gt;
&lt;li&gt;The title text you see at the top of the webpage.&lt;/li&gt;
&lt;li&gt;The “map” &lt;code class=&quot;language-text&quot;&gt;div&lt;/code&gt;.&lt;/li&gt;
&lt;li&gt;The container of the leaflet map, which I have made transparent so that it is white like the rest of the page background.&lt;/li&gt;
&lt;li&gt;A style for the layer control so it pops more than the default. I wanted to emphasise the layer selector, as it is really the entire point of making contrasting viewsheds. This bit of CSS is a little complex; the best way to work it out is to fiddle with it.&lt;/li&gt;
&lt;/ol&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;css&quot;&gt;&lt;pre class=&quot;language-css&quot;&gt;&lt;code class=&quot;language-css&quot;&gt;&lt;span class=&quot;token selector&quot;&gt;html, body&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token property&quot;&gt;height&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; 100%&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token selector&quot;&gt;#title-text&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;height&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; 8%&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;width&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; 100%&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;font-family&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; Helvetica&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;text-align&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; center&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token selector&quot;&gt;#map&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
   &lt;span class=&quot;token property&quot;&gt;height&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; 89%&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
   &lt;span class=&quot;token property&quot;&gt;width&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; 100%&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
   &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;/* background of leaflet container: transparent \*/&lt;/span&gt;
&lt;span class=&quot;token selector&quot;&gt;.leaflet-container&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token property&quot;&gt;background-color&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;rgba&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;255,0,0,0.0&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;/* custom style for the layer control to make it a bit more obvious \*/&lt;/span&gt;
&lt;span class=&quot;token selector&quot;&gt;.leaflet-control-layers-toggle:after&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token property&quot;&gt;content&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;Toggle transport mode&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token property&quot;&gt;color&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;#000 &lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token selector&quot;&gt;.leaflet-control-layers-toggle&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token property&quot;&gt;width&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;auto&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token property&quot;&gt;background-position&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;10px 50% &lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token property&quot;&gt;padding&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;6px&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token property&quot;&gt;padding-left&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;40px&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token property&quot;&gt;padding-right&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;10px&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token property&quot;&gt;text-decoration&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;none&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token property&quot;&gt;line-height&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;36px&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h1&gt;Getting the map online&lt;/h1&gt;
&lt;p&gt;So, you have used a complex geographic routine to make a cool viewshed for the North Island of New Zealand. You have made a working web map and added some custom flair. How do you show it off? There are lots of ways to host webpages, but since we’re using Github, Github is actually a very good option for projects like these.&lt;/p&gt;
&lt;p&gt;In any Github project, if you make a branch called &lt;code class=&quot;language-text&quot;&gt;gh-pages&lt;/code&gt;, some magic happens. &lt;a href=&quot;https://pages.github.com/&quot;&gt;Github is the authority on the matter&lt;/a&gt;. Once you have your username.github.io repository ready, any &lt;em&gt;other&lt;/em&gt; repository you make can have a hosted website simply by making a &lt;code class=&quot;language-text&quot;&gt;gh-pages&lt;/code&gt; branch.&lt;/p&gt;
&lt;p&gt;If this branch has an HTML file called &lt;code class=&quot;language-text&quot;&gt;index.html&lt;/code&gt;, you can then find your special Github-hosted webpage via the URL: &lt;code class=&quot;language-text&quot;&gt;https://{username}.github.io/{repository}&lt;/code&gt;. If this page happens to contain a map… then you have a map available on the Internet for the world to see, for free. You just have to be comfortable with the code (and often data) behind it being open to anyone.&lt;/p&gt;
&lt;p&gt;You can go one step further and also get a custom domain name, if you want to be able to link to something like &lt;a href=&quot;https://www.nearimprov.com/train-landscapes&quot;&gt;https://www.nearimprov.com/train-landscapes&lt;/a&gt;.&lt;/p&gt;
&lt;h2&gt;Amazon Web Services (AWS)&lt;/h2&gt;
&lt;p&gt;There’s just one little problem left. The two sets of tiles, even though they have a constrained range of zoom levels and geographic extent, come to about three gigabytes of images. Github doesn’t like that (I tried). So you need an alternative. Some kind of system where you can put lots of images in a directory structure on the Internet, and access them with a persistent URL. Amazon Web Services (AWS) is the cloud solution for you!&lt;/p&gt;
&lt;p&gt;If you sign up for an AWS account and navigate to your console, you should be able to see where you can create a “bucket”. Once you’ve made your bucket, you can then create folders just like any other directory. Then, inside each folder, you can store your tiles.&lt;/p&gt;
&lt;p&gt;
  &lt;span
    class=&quot;gatsby-resp-image-wrapper&quot;
    style=&quot;position: relative; display: block;  max-width: 343px; margin-left: auto; margin-right: auto;&quot;
  &gt;
    &lt;span
      class=&quot;gatsby-resp-image-background-image&quot;
      style=&quot;padding-bottom: 55.10204081632652%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAAsSAAALEgHS3X78AAABvklEQVQoz6WPX0vbUBiHz82+hJvCqVrqLiZs8zo1qSUZ2OroQAf6LSYIXjg2vPBSxWsvvZU2aWOgIGwt2natf6hR12K1bZKmOY0xmtaUuGPHYIOiF3t4zsvvvBzOywsIL/VuzLsw+5oZ8xJecnLyfSgU8vv9Pp+PoqjgxERgPBAMBhmGwR2SJHFgaJrsAHp64ZuXz1c/Phv29L7og/gFTdNDHs/gwACErlGKIggCN0dG3rrdbuiCww+8cvX3QwhBXOC3+ViYxSWGDxsJR7kwDjy/LQgCx3Isy0YiEVyjHR7uLMtxHM5gY8+c26p/jaHFKPocRV94fT6MCvXWjaFrCBnGtWU12+32fTfAp80Tejkzs577sJKdXstNrWbJpbTw43w/s5tIJFOptCiKqqo6jmPbdvtfwLl6u3OMvp3p30/RXlE/KpuXqPn3906H7pM1/bZQ1cVyoyhdXdQMGZnXN5Z917Kav2n9sQuggTSsmD/ciQvp1K4iVxS5qkhVWapUK08ISpKWTO0XZCPzs5YtqgelxkFJPyw1jstXl3Xz4lGBolu5/JliOnnFFlX7SGphc5WmWLPx7pr1mOD+P/gFsdn9J5mDwUMAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
    &gt;
      &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        style=&quot;width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;&quot;
        alt=&quot;aws1&quot;
        title=&quot;&quot;
        src=&quot;/static/a244a86000d47ccb4ca81609251c9bb8/3b527/aws1.png&quot;
        srcset=&quot;/static/a244a86000d47ccb4ca81609251c9bb8/24ae4/aws1.png 148w,
/static/a244a86000d47ccb4ca81609251c9bb8/6ab07/aws1.png 295w,
/static/a244a86000d47ccb4ca81609251c9bb8/3b527/aws1.png 343w&quot;
        sizes=&quot;(max-width: 343px) 100vw, 343px&quot;
      /&gt;
    &lt;/span&gt;
  &lt;/span&gt;
  &lt;/p&gt;
&lt;p&gt;
  &lt;span
    class=&quot;gatsby-resp-image-wrapper&quot;
    style=&quot;position: relative; display: block;  max-width: 391px; margin-left: auto; margin-right: auto;&quot;
  &gt;
    &lt;span
      class=&quot;gatsby-resp-image-background-image&quot;
      style=&quot;padding-bottom: 59.33503836317136%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAIAAADtbgqsAAAACXBIWXMAAAsSAAALEgHS3X78AAABoklEQVQoz6XQ3UrjQBQA4Hmb3TuVVTNZKkm2WwpFCqmC3i37Cr6C4LWC7I0+hlBYll30Qq22aVJr+mP+mjSTn0ltku6qVGsdreKKeFH8mDnMMOcwcwZMTdO51OTK4sfJTxTLcQu5HMsyENKJRCKTyaTT6VQqNTeXgBAyDPOF42iahk/AzAz8Pj+x9u0DpKhk8uvy0hLHsp8f8HyO5/lsNssyDEVBhmU4jiU1s09Apa7/PFbzBW2/oiiqpqqq0SJMgqwVRdE0fbTVdd0wjMezB2B1x85s1BZ/1LObTVFBzdqJWBZkWS4Wi6bZiqOwIkmiKDWaZxjj4UvgVzVYz2tbv83tP6aBAhs5imFbyD8zbOQFfie0kev5PsZBHPcGg8Htf4AfXspWVGtHDedfeHGNo6uSHlXbPcGIZSs+aJ57cZ9cMsq+eQkEODjvBN1OcFw43N3dIx1hz/Vc5LuO5zokug5Ctk0megX0en+Fcrl6KlsOttrtbhiGUTwa0SjGbwKkDaFUkk5Ow6v71w3HAfr966OjgiBKnYvbsYuf/244NjB8hzsBy0vtCEZxgAAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
    &gt;
      &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        style=&quot;width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;&quot;
        alt=&quot;aws2&quot;
        title=&quot;&quot;
        src=&quot;/static/75d47aeeb9de5d12ece44ca48cef7097/9c64c/aws2.png&quot;
        srcset=&quot;/static/75d47aeeb9de5d12ece44ca48cef7097/7571f/aws2.png 148w,
/static/75d47aeeb9de5d12ece44ca48cef7097/b73df/aws2.png 295w,
/static/75d47aeeb9de5d12ece44ca48cef7097/9c64c/aws2.png 391w&quot;
        sizes=&quot;(max-width: 391px) 100vw, 391px&quot;
      /&gt;
    &lt;/span&gt;
  &lt;/span&gt;
  &lt;/p&gt;
&lt;p&gt;There are two catches:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;AWS is not free. Beyond a certain number of downloads you will be charged; I intend to monitor mine and remove the files before this happens.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;You need to programmatically upload your tiles, so you need to go back to that shell you love so well.&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;You need to install and configure &lt;code class=&quot;language-text&quot;&gt;s3cmd&lt;/code&gt;. On Ubuntu it’s in the official repositories, so it’s as easy as the command &lt;code class=&quot;language-text&quot;&gt;sudo apt-get install s3cmd&lt;/code&gt;. I have no idea how easy or difficult this is on other operating systems (I told you to use Linux!)&lt;/p&gt;
&lt;p&gt;If you’ve sorted your account through your web browser, you need to request your access keys from your management console. You’ll get given two of them, sent to you in a download that you keep to yourself. When you have these in front of you run &lt;code class=&quot;language-text&quot;&gt;s3cmd --configure&lt;/code&gt; at the command line and provide the keys when requested. I just used the default answers to all the other questions.&lt;/p&gt;
&lt;p&gt;Now if you have set up your bucket and two folders “car” and “rail”, you can sync your local tiles generated with QTiles to Amazon CloudFront. This is also a relatively easy command, just be aware how much bandwidth you’re using.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;s3cmd &lt;span class=&quot;token function&quot;&gt;sync&lt;/span&gt; /path/to/car/tiles/ s3://bucket-name/car&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Repeat the above with your other tile dataset. Refer back to the JavaScript to see how I the referred to the URLs where you can see these images. You can see an example tile &lt;a href=&quot;https://s3-ap-southeast-2.amazonaws.com/train-landscapes/car/10/1007/381.png&quot;&gt;here&lt;/a&gt;, while it lasts.&lt;/p&gt;
&lt;p&gt;
  &lt;span
    class=&quot;gatsby-resp-image-wrapper&quot;
    style=&quot;position: relative; display: block;  max-width: 256px; margin-left: auto; margin-right: auto;&quot;
  &gt;
    &lt;span
      class=&quot;gatsby-resp-image-background-image&quot;
      style=&quot;padding-bottom: 100%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAA7DAAAOwwHHb6hkAAACsUlEQVQ4y5WU2U8TURTG55/0SQlK96FCtbRMO+3M0Ha6zVJKW6wFmxBq1IiJS2KCiYr6QIhLNDHogxiNgFEUWlIQLOXz3imgDY10bnJzZstvvnvOdw4jZgYRHg1gdu4eqrWfoGt/f9/Yh9dmFjOS58BpIhJjIbxZfIH16hqBNI2XzWbTNJSRMh4oEzLq9Rp+bKwbD6ubG9jZ/dWCHsC7Bgbj/UjkvLhxdxJz87P4srqEy1dHkSurqNWqx1JwIlBQB1C4IkHQnEgVvAjI/bBcOIMe9hTeLr4+OnrXQD7tQijFQh67CEkbACe7EIyz8EUsWPr0/gC4Z+LIKTv8MStCaRaBuAN+2Qo+5QR9Xr6uo9H4baowzFC0D1zCBl/UiuGYDUMEHkjakRrnoBRDWP22bKo4zHDcStQ4iEKXAaT3MVKkbHkEpekktrbr5hRyCQdRZwGfdCKQsCOS9aJ8TYdeHEaxksIhxwTQahyZT9sRz/mgTUqkQB6ImgtTN3PmbSNqg5DzfiTHeWgTIqSMG5LuJmqtpCjZNmA3UEYnEKXIQS8JEFU3ySE5PsmpL3YOhSm5rf26Ao5kziOsugyrhNJOhBUXqbIDIlEpaSyWVz62mfskKDE2VWMx8kiBxiZQSSfmTrK48/CW8WFjr2EYnA6O/02jVqcoTkMlBQmaG4LqQKQgQH2wAOX+U6x8/dxRTSe1TJAo4skWVNaIFMonrRibqUB79gGJR++gV/KYfz6L+ZeP8X1thZJQ39rsrJCqo5BWbOUwGO+DMl1A5vYMotMlpKYyxKs98EZ7Iec8UC8FsfDqScc+Z7i4HUNkEFBT07bzyzajytGsh0Qb6e+zJB0O46dhhYVHOo18WT6al8cU0oLQTvGTGCQ9TK//KnZBJC7gSaQ/9kZ6Uaoo2N3daZvo/64/zddFiwfJPy4AAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
    &gt;
      &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        style=&quot;width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;&quot;
        alt=&quot;aws3&quot;
        title=&quot;&quot;
        src=&quot;/static/243617020760c06d7cb943e4ebd00891/bd51f/aws3.png&quot;
        srcset=&quot;/static/243617020760c06d7cb943e4ebd00891/70d05/aws3.png 148w,
/static/243617020760c06d7cb943e4ebd00891/bd51f/aws3.png 256w&quot;
        sizes=&quot;(max-width: 256px) 100vw, 256px&quot;
      /&gt;
    &lt;/span&gt;
  &lt;/span&gt;
  &lt;/p&gt;
&lt;p&gt;
  &lt;span
    class=&quot;gatsby-resp-image-wrapper&quot;
    style=&quot;position: relative; display: block;  max-width: 394px; margin-left: auto; margin-right: auto;&quot;
  &gt;
    &lt;span
      class=&quot;gatsby-resp-image-background-image&quot;
      style=&quot;padding-bottom: 88.57868020304569%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAASCAIAAADUsmlHAAAACXBIWXMAAAsSAAALEgHS3X78AAAB3ElEQVQ4y6WQPW/TUBSG/VvYAAkhtXVC1MS4+RINGdrSId1YGdjY+QNI8AvYEBMrElsgiWMHqkT+alpKMUnsa9977dgOzZeTcOMqEkVdHB4dHb2W9eicc6m797eOcrdfPLl1594Gu7NzcLCf3N6maToef1AoFB7t7mazmUQisUXTqVQqmUzGYrHNFRTDsM8O4y+fbrAPmWKxWCqVctksy7LpdPowZH9vL5NJMwyTz+fJLxJSKyhFw59a1scWEk6hBTGE0HYcOwQhBBHCGDsrfN8f/AX1/N157pX4+LVUfKO2TrXmN0HgeUkSea6m/bxAFvjaEEgpigoAWFyH4s6ct+XOe07/0AAm9kzk/NDtHnRJ71puB3rIcXXo4L4/Gg3/lWH/st11vuvumeEh91LHg6bmtnVP7rii1j++cLA3PAe+PRjPZ8F4cg3KsiyMETQB2fNLpdrt/CLZBIYFjKsOjGUw9BugyN28IEiyaiAXYzt8kd+k/LBIIITtBqjpdMrzvKycDGfkivkiCku5VqsSeRQQN7rMcTVRVofBWpN5vi6rbW8cXQ6CoFqptER5Ml9r7XqdTD5ZfkWVJ5NpoyFISjuIbi8nfy6Xj5vibA2Z3NzrdU0LRtv4Sl78B38AFPuvYlAduHIAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
    &gt;
      &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        style=&quot;width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;&quot;
        alt=&quot;aws4&quot;
        title=&quot;&quot;
        src=&quot;/static/cc81046cba97aa5604434258c2c298c2/e64ce/aws4.png&quot;
        srcset=&quot;/static/cc81046cba97aa5604434258c2c298c2/97662/aws4.png 148w,
/static/cc81046cba97aa5604434258c2c298c2/64054/aws4.png 295w,
/static/cc81046cba97aa5604434258c2c298c2/e64ce/aws4.png 394w&quot;
        sizes=&quot;(max-width: 394px) 100vw, 394px&quot;
      /&gt;
    &lt;/span&gt;
  &lt;/span&gt;
  &lt;/p&gt;
&lt;h3&gt;Local tiles&lt;/h3&gt;
&lt;p&gt;In order to put tiles on Amazon’s servers, you also need to have generated tiles locally. You can use these with Leaflet to preview your map offline. Simple substitute the URLs I used for carViewshed and trainViewshed with local paths, e.g.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;var&lt;/span&gt; carViewshed &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;/data/tiles/rail/Mapnik/{z}/{x}/{y}.png&apos;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Then you can use Python from your command line to serve up a webpage (Python 2.x):&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;python -m SimpleHTTPServer&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Check out &lt;a href=&quot;http://localhost:8000/&quot;&gt;http://localhost:8000/&lt;/a&gt; once this server is running. (Press ctrl-c to get back in control of your command line.)&lt;/p&gt;
&lt;div class=&quot;newthought&quot;&gt;
  &lt;h5&gt;Final comments&lt;/h5&gt;
  &lt;p&gt;I&apos;ve been frustrated many times in the past by the need to patch together a series of tutorials from different authors to actually get my own project off the ground, from data to a finished product. I hope this has been helpful for you to realise something from your own imagination.&lt;/p&gt;
&lt;div&gt;
&lt;p&gt;If there’s any element that you feel needs better explanation, please leave a comment and I’ll help you out.&lt;/p&gt;
&lt;p&gt;Similarly, if there’s anything that you feel is a glaring mistake in my code, point it out, I’d love to improve. I’m sure I’m fallible: Pierre’s bash script was the first piece of programmatic bash that I’d ever read; my changes were my first experience with shell scripts. I’ve since found them very useful.&lt;/p&gt;
&lt;p&gt;Have fun!&lt;/p&gt;</content:encoded></item><item><title><![CDATA[What is a headway?]]></title><description><![CDATA[A headway, as used in transit planning and modelling, is typically defined as the time between consecutive services. If you catch a bus that…]]></description><link>https://spatialparalysis.xyz//headway/</link><guid isPermaLink="false">https://spatialparalysis.xyz//headway/</guid><pubDate>Mon, 16 Jun 2014 20:38:41 GMT</pubDate><content:encoded>&lt;p&gt;A headway, as used in transit planning and modelling, is typically defined as the time between consecutive services. If you catch a bus that “comes every half hour”, then the service you catch has a headway of 30 minutes.&lt;/p&gt;
&lt;p&gt;This concept is deceptively simple, and this blog post will explain why. There are  several examples of transit analyses that I have seen that use an incorrect definition  of the headway.&lt;/p&gt;
&lt;p&gt;Defining the headway accurately is very important when modelling travel using public transport because it is used to determine how long we expect passengers will wait. Taking the example of the bus that comes every thirty minutes: if passengers all turn up to the stop without considering the schedule (that is, at random), we would expect the average passenger to be waiting there for a period of time equal to half the headway: 15 minutes.&lt;/p&gt;
&lt;p&gt;The Transit Capacity and Quality of Service Manual (&lt;a href=&quot;http://onlinepubs.trb.org/onlinepubs/tcrp/tcrp100/part%203.pdf&quot; title=&quot;TCQSM 2nd Edition, PDF&quot;&gt;TCQSM&lt;/a&gt;) has a pretty handy table on different headway classes and what they mean for waiting passengers. I’ve taken this from the second edition of the TCQSM (rather than the 3rd), because I don’t have access to the 3rd edition. I don’t know if it has changed (a heads-up if it has would be great).&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th align=&quot;center&quot;&gt;Level of Service (LOS)&lt;/th&gt;
&lt;th align=&quot;center&quot;&gt;Avg. Headway (min)&lt;/th&gt;
&lt;th align=&quot;center&quot;&gt;Vehicles/h&lt;/th&gt;
&lt;th&gt;Comments&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;A&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;&amp;#x3C;10&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;&gt;6&lt;/td&gt;
&lt;td&gt;Passengers do not need schedules&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;B&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;10-14&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;5-6&lt;/td&gt;
&lt;td&gt;Frequent service, passengers consult schedules&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;C&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;15-20&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;3-4&lt;/td&gt;
&lt;td&gt;Maximum desirable time to wait if bus/train missed&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;D&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;21-30&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;2&lt;/td&gt;
&lt;td&gt;Service unattractive to choice riders&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;E&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;31-60&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;1&lt;/td&gt;
&lt;td&gt;Service available during the hour&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;F&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;&gt;60&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;&amp;#x3C;1&lt;/td&gt;
&lt;td&gt;Service unattractive to all riders&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;Stops with LOS A mean that passengers can just up and board their service with barely any waiting. Stops with LOS F require that passengers take time to plan their arrival at the stop and probably change their schedules before or after their trip: living their life around the schedule.&lt;/p&gt;
&lt;p&gt;The “average headway” in the table is the inverse of average frequency.&lt;/p&gt;
&lt;p&gt;So far, so good. Headways are the time between vehicles, and are useful as indications of how frequent a public transport service is, and therefore how long passengers wait. Average waiting time is complicated by the fact that not all passengers arrive to their stops at random, but I will not bother you with this for the moment, as this post is concerned with defining the headway, not waiting time, even if they are related.&lt;/p&gt;
&lt;h2&gt;Problem 1: Grouped arrivals&lt;/h2&gt;
&lt;p&gt;If I told you that a particular bus route had a frequency of 3 vehicles per hour, what would be headway on that route? Well, there’s 60 minutes to an hour, and 3 services in that period. So we have 60/3=20 minute headway.&lt;/p&gt;
&lt;p&gt;However what if the schedule (or, you know, reality) had all three of these services arriving at the same time, perhaps because it is a bus interchange where three routes coincide before heading their separate ways, or because buses can get caught behind a late service (bunching). In this case, despite having a frequency of 3 vehicles per hour (LOS C), your headway could arguably be defined in two ways.&lt;/p&gt;
&lt;p&gt;The first is to assume that three services all arriving at once just count as one arrival. Your headway is then 60 minutes, and LOS E.&lt;/p&gt;
&lt;p&gt;The second is to acknowledge that O.K., the schedule says that they arrive at the same time, but it can’t be &lt;em&gt;exactly&lt;/em&gt; the same time. Let’s say for argument’s sake, last Tuesday they arrived at 7:00 am, 7:01 am, and 7:02 am, and then again at 8 am. Let’s call this Arrival Pattern A. Your headway as we have so far defined it is one minute for the first bus, one minute for the second, and 58 minutes for the third. Your average headway in this period is (1+1+58)/3=20 minutes, LOS C. So we’re back at 20 minutes! But hold on, none these buses has a 20 minute headway when considered as an individual arrival.&lt;/p&gt;
&lt;p&gt;This is tricky. What does the TCQSM recommend (p. 3-29)?&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Some judgment must be applied to bus stops located near timed transfer centers. There is a considerable difference in service from a passenger’s perspective between a bus arriving every 10 minutes and three buses arriving in a row from a nearby transfer center every 30 minutes, even though both scenarios result in six buses per hour serving the stop. In general, buses on separate routes serving the same destination that arrive at a stop within 3 minutes of each other should be counted as one bus for the purposes of determining service frequency LOS.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;As it so happens, the TCQSM therefore suggests using the first approach, where buses that arrive within three minutes of each other are considered as one bus. So the 7:00, 7:01 and 7:02 buses would collapse down to some time point in the range 7:00-7:02. I’m not sure what moment exactly should be used within this range. It may sound picky to be wondering if the representative arrival is 7:00 or 7:02, but when writing code to calculate these headways for you, you have to make rather precise decisions. I’d guess it’d be the average of these values, so 7:01 am.&lt;/p&gt;
&lt;p&gt;However, if the buses arrived at 7:00, 7:04, 7:08 and 8:00, we’d be back to an average headway of 20 minutes, and square one. We’ll call this Arrival Pattern B.&lt;/p&gt;
&lt;h3&gt;Median headway&lt;/h3&gt;
&lt;p&gt;This issue is why, when aggregating headways (rather than determining the headways of particular trips) over an interval of time, the median headway is sometimes used instead of the average headway. With a median headway, the potential to calculate a headway that is never exhibited in reality is reduced.&lt;/p&gt;
&lt;p&gt;For the two examples given in this section, Arrival Pattern A has a median headway of 1 minute. Arrival Pattern B has a median headway of 4 minutes.&lt;/p&gt;
&lt;p&gt;That’s not quite right. If you were to use this as your headway for the purposes of determining the average waiting time of a randomly-arriving passenger, they’d be waiting for 0.5 minutes (AP A) or 2 minutes (Arrival Pattern B).&lt;/p&gt;
&lt;h3&gt;Is it a problem?&lt;/h3&gt;
&lt;p&gt;I got to this point in my thinking and after a bit of time spent smashing my head into my desk, I asked myself whether it was really a problem if the average headway in Arrival Patterns A and B can be 60 and 20 minutes, respectively. This seems like a very big difference in headway (and hence waiting time) for such a small difference in vehicle arrivals. However, if passengers are arriving uniformly at random over the hour 7:00-8:00, then the average passenger &lt;em&gt;does&lt;/em&gt; indeed wait for -20 minutes in Arrival Pattern B. In Arrival Pattern A, three minutes, while arbitrary, does seem like a reasonable amount of time to consider services to be functionally arriving at the same time, given acceptable levels of variation in arrival time.&lt;/p&gt;
&lt;p&gt;That’s fine and dandy for little examples like AP A and B above. But what if you have a major stop where buses typically arrive every minute for the entire hour? What is the headway? We’ll call this Arrival Pattern C. In this case, the frequency-derived measurement of headway (60 arrivals in 60 minutes, so 1 minute headways) is spot-on.&lt;/p&gt;
&lt;p&gt;But the TCQSM just told us that arrivals less than 3 minutes apart should be considered equivalent to the arrival of only one vehicle. So the 7:00 and 7:01 arrivals are equivalent to each other. And the 7:01 and the 7:02. And the 7:02 and the 7:03. In fact, taking the TCQSM’s advice to the letter (as code written to solve this problem would naïvely), the whole pattern of arrivals would be reduced down to one single arrival and a headway of 60 minutes for the 7:00-8:00 period!&lt;/p&gt;
&lt;h3&gt;What do you do?&lt;/h3&gt;
&lt;p&gt;Thinking about these problems, the most defensible solution I have come up with is to take the TCQSM’s grouping advice, but modify it slightly so we don’t avoid that last incomprehensible travesty. I would &lt;em&gt;bin&lt;/em&gt; all arrivals into groups of four minutes. So for Arrival Pattern C (arrivals every minute for an hour), we’d see single arrival events at 7:00, 7:04, 7:08, 7:12, and so on. 60 arrivals would be reduced to 15, each with four minute headways. The average and the median headways in this case would then both be four minutes, with an average waiting time of two minutes.&lt;/p&gt;
&lt;p&gt;For AP B (7:00, 7:04, 7:08, and 8:00), no modification of the arrivals is required, and the average headway is 20 minutes.&lt;/p&gt;
&lt;p&gt;For AP A (7:00, 7:01, 7:02, and 8:00), we would modify the arrival pattern to be 7:00 and 8:00, as the three arrivals near the start of the hour are grouped into the same bin. If there was a fourth service at 7:03, the pattern would be the same, as well as the average headway (60 minutes). When we get an additional service at 7:04, our (grouped) arrival pattern becomes 7:00, 7:04, 8:00, and &lt;strong&gt;our average headway becomes 30 minutes&lt;/strong&gt; rather than 60. The median also changes from 60 to 30.&lt;/p&gt;
&lt;p&gt;This last case may not seem ideal, but let’s recap the possible alternatives.&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;A literal interpretation of the TCQSM has us grouping all of the first five arrivals into
one, leading to only one headway of &lt;strong&gt;60 minutes&lt;/strong&gt;.&lt;/li&gt;
&lt;li&gt;Without grouping, we’d have headways of 1, 1, 1, 1, and 56 minutes, for an average
of &lt;strong&gt;12 minutes&lt;/strong&gt;, and a median of 1 minute. Notice that the average headway is the same
as that determined from the frequency per hour (5 arrivals in 60 minutes).&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;Deciding which method to follow is tricky. I don’t have a clear favourite; but if forced to pick,
I like the method that uses the bins. It acknowledges the TQCSM’s recommendation that
arrivals close in time be considered functionally equivalent, and results in a headway
that falls between the other two estimates derived from alternative interpretations.&lt;/p&gt;
&lt;p&gt;From the perspective of someone who has to calculate these values programmatically, it
adds a bit of overhead, particularly over the simple arrivals per hour calculation. However that
calculation does not account for the scheduled arrivals, and I would not recommend it, ever.&lt;/p&gt;
&lt;h2&gt;Problem 2: The destination matters&lt;/h2&gt;
&lt;p&gt;I’ve been a little dishonest in my definition of what a headway is. Well, I’ve said a half-truth. The headway &lt;em&gt;is&lt;/em&gt; the time between vehicle arrivals at a stop. However, all arrivals are not equivalent. What matters is &lt;strong&gt;where they are going&lt;/strong&gt;. Let’s say we have a network with stops A-E serviced by three different routes.&lt;/p&gt;
&lt;p&gt;
  &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/539ea8f1db7b351182d7de0b388eb512/8a0db/network-headway-diagram.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
  
  &lt;span
    class=&quot;gatsby-resp-image-wrapper&quot;
    style=&quot;position: relative; display: block;  max-width: 439px; margin-left: auto; margin-right: auto;&quot;
  &gt;
    &lt;span
      class=&quot;gatsby-resp-image-background-image&quot;
      style=&quot;padding-bottom: 98.17767653758541%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAA7EAAAOxAGVKw4bAAADXElEQVQ4y60VW0hTYfg7Z7M1MxLrIQjCh6JEg7LoXoZlZFSK3fBWQmabc57ZkiF2UbNl6dbm2s7cxTksxe7UQ1cbllvTs2l5aWleUISCoJeieoj+/vNbwsiH0j74+e7X8//fAZgipJQ+hYLaDgFP55p9UoW9A0mN7g9TjQd7y1xQ6OwkARl7Z0FhfTeS6F3fYToVMjY/xdM5hs7V+bYWZ77thRqmCydvOCn4H8C3XNTQBQjxHALtA1Zcce9KyNRbLmnGrXpB05xNeM2To6KqJzkCkJra6TyLjz5mbCOl468FaaYskBoGieEhfQPIajg6D5/sai+RSUztkGqPApUFgbV7PMHZuyXiMze1wRVWMmoYxvhhTCT0RABo04r+qEwtLYNRjB8vWwR+GsBSoAmeYbaBWymvDazJ0HkXTNZa9BWXWGJ+tSrP1rM6ReebM5nNLjM3T251b5awnpUgY18gxsahAotXj+dLO1SZcxty48LrVekR7yJAdErLpsrNbiQzedAJ87NMbCOwMikRTUxCuEOZGf46FMSFhlsXj9d1IRnr/gT5Vh9S2P0on2038tlci6PFz0LDRdeXx4fyfFn5vQSFtQ3Ja9qQ0uhN5WVNsQmh2GZm44Y9xEalcxUXXg3wAb+BlPUlKxy9B44YuWW8MrIZBQ02rm50ttz6KoWp7dqXcZmbP1nLB+sGFip1LYcZgzspSGFSaCDp9HN6aykn3FLqDzm3W/GH87mcKoq/eq3ULOCxNVke/FFkZo7GT0ggYX0TinUVAYgt76U2Vb6ZkVQdEGSZXgrLnR5aafZgh6/QdNcNsP4hvxxIUB5uL9kYVr9xv4gwWY5hghvbP0Jc1ZughFu1fXSGfWhGor5fsPxsL5GtvxCA4jtjhG6lZxPspsLErVSYMMh5zfkAwbg62ICdYMX9Cd22S30hO6v7BYn4/JYddQ7Cl1/0tZj4WY5tWaJJn9UOfT9El/QQeqfhLSw9PU7jJNTa8wFhum1IKG8cIYGf5qr+fjmobo5NBMatT8jjNX2U5tF7wZk7I6Si9JquqGLNY7VS3yL/q8BrK8ZHsai4G7br+n9JJXjTfMbVPRelG14alXUdKJf1/PinDbPPPEDwHuNbSLUMgLqRo8kvwNLJHK/148vv/fATajlXoTbT40oAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
    &gt;
      &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        style=&quot;width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;&quot;
        alt=&quot;Network headway diagram&quot;
        title=&quot;&quot;
        src=&quot;/static/539ea8f1db7b351182d7de0b388eb512/8a0db/network-headway-diagram.png&quot;
        srcset=&quot;/static/539ea8f1db7b351182d7de0b388eb512/bc877/network-headway-diagram.png 148w,
/static/539ea8f1db7b351182d7de0b388eb512/1880c/network-headway-diagram.png 295w,
/static/539ea8f1db7b351182d7de0b388eb512/8a0db/network-headway-diagram.png 439w&quot;
        sizes=&quot;(max-width: 439px) 100vw, 439px&quot;
      /&gt;
    &lt;/span&gt;
  &lt;/span&gt;
  
  &lt;/a&gt;
    &lt;/p&gt;
&lt;p&gt;If you’re seeking to travel directly from A to D, you don’t at all care that there is a blue line between A and E. So even if a blue line service arrived at A every minute of every day, it would do you no good to board it (we’ll assume you can’t walk between any of the stops). That is, if travelling A-D, your headway is defined only as the headway of the green route.&lt;/p&gt;
&lt;p class=&quot;sidenote&quot;&gt;For the colourblind, red is solid, blue is dashed, and green is dotted.&lt;/p&gt;
&lt;p&gt;Now if you’re instead travelling A-C, you can choose between the red and the green routes. Unless these services arrive at A at the same time, your headway (and hence waiting time) is less than it would be if you were travelling A-D, even though you are waiting at the same stop. This path A-B-C is a public transport &lt;em&gt;corridor&lt;/em&gt; of overlapping routes.&lt;/p&gt;
&lt;p&gt;Travelling A-E, you again benefit from the corridor effect, as your line is shared between the blue and the red services. Note, however, that although these overlapping routes work together to reduce your headway, you may not necessarily choose to board the first red or blue service that arrives. For instance, if blue is an express route that travels A-E while red is a slower route that stops at A-B-C-E, you may be aware that skipping that red bus that just turned up at A in favour of waiting just a little bit longer for the next blue bus is better, because the blue bus will get you to E in better time.&lt;/p&gt;
&lt;p&gt;Given this, what’s the headway? If the headway is used as a proxy for waiting time, how can it account for the presence of express routes that may give people an incentive to wait a little bit longer for a faster route? Given that you don’t &lt;em&gt;know&lt;/em&gt; with certainty that the blue bus is going to turn up quickly enough for your gamble to pay off, what is your expected waiting time?&lt;/p&gt;
&lt;p&gt;Further, what about the possibility of taking a green bus to C and then waiting at C for a red bus to take you all the way to E? Might sound weird given transfers are annoying, but it’s certainly an advantage to have this option if C is more comfortable or well-lit as a place to wait than is A.&lt;/p&gt;
&lt;p&gt;These are very tricky questions with very tricky answers. The key thing to keep in mind, however, is the mantra: &lt;strong&gt;the destination matters&lt;/strong&gt;. To this end, the TCQSM does acknowledge that headways are defined with respect to a particular destination. By no means has this been clearly stated, however. To quote their fuller definition (p. 3-29):&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Service frequency LOS is determined by destination from a given transit stop, as several routes may serve a given stop, but not all may serve a particular destination.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;Take home point: a stop served by more than one route with multiple possible destinations doesn’t have a single headway; it has a headway for each possible direct destination from each stop.&lt;/p&gt;
&lt;h3&gt;How do you calculate headways when the destination matters?&lt;/h3&gt;
&lt;p&gt;An issue here, from the perspective of someone who wants to calculate headways from a published schedule (e.g. from your local GTFS) or from observation of real-time service arrivals, is that as soon as we define headways not as one number for each stop, but as one number for each possible board-egress stop pair, the dimensionality of the problem grows.&lt;/p&gt;
&lt;p&gt;Given this blog is ostensibly about transit visualisation, I’ll make a diagram for this. This is the exact same sample network as we had before, but now shown in terms of the direct stop edges that exist. If you’re to find the headway of travel A-C, you simply need to look at the two edges that progress uninterrupted from A to C, and ignore all others. This is convenient.&lt;/p&gt;
&lt;p&gt;
  &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/4063b9bee278a61a87c1f7e293ee1305/8a0db/network-headway-diagram-logical.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
  
  &lt;span
    class=&quot;gatsby-resp-image-wrapper&quot;
    style=&quot;position: relative; display: block;  max-width: 439px; margin-left: auto; margin-right: auto;&quot;
  &gt;
    &lt;span
      class=&quot;gatsby-resp-image-background-image&quot;
      style=&quot;padding-bottom: 98.17767653758541%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAA7EAAAOxAGVKw4bAAAEeklEQVQ4y41Ue0xbZRQ/9/YW2lvGNo2oCQn+h5o4jFMzHnMOiIDCkMeSCfIYC6+WWygw5LEB4rCzPAuFFmgZ5TFIBpERZGSCvMtj0DIolEdgjGlcIokzBjN17vPej4JO+YOT3Jzvnu/c3/l9v3PuB2A1w9pNqB/4DK+jzAGgyHlKcOvYJnWwuGoEiasNKElrDOZiTOUoj/OyeiP2Ys10YorOiBKrxrYwQMN4HhhnOvC67Z4GVq1FEABZmX45V6abQkmaCVSg+k7Mxd9X/kbe0uXARb0JA0p1xtR0/TxKUA7+CXGqSUhUT0FAySLc7MvFQE4IQXt1Fs0C8i/JupyYOqOC0c0W5eVcd0VvgehFhDD7dP04yfn4ysW3GV1Ph1Q7WAzZLSYiq3mGKGrtwUnfssnDZemHZv39adjHTO4+R/vEHwuBLcpZRkc+Bk3oBvsIBMQzyfkb5eRAYuihBXcf291YWaYW0htneVl1Bh4HYjn5gXDa9aRoSJNNIyvomxmj0DZm5lf1zvNArJ7qZGqn+yW1hljkDFRvhMz230WQSyu0dSmhNyUev897f8S3ePjZzkVEiHo6C4S7eVdvRwsUt2N4kMaKmVJvRJmqoetsPdv27ht0d2OGMPt+MuWNCon/HnlE8gmY/UNE3zudImYSY+xqDDLcmC+/kQtzO4r5HMMhiWbCmKQyxHNdHfMKPjodFEgPxoUe6cw/d6RffZHum9dTl1EteQx9gUEtbj4Ci6sP9SgshTelLBT9X2lWTVDtdG7x1TdsjK+dEHDqPHzOlZr3CxSZAs7YDSWHH+4oirRvbpeKhnsr+KbYaLud0XqZKpaGhMc3twWIVXMuGK+lrwNOy+coH/ksFn77BRFvxs2LHo0IxUXWwQG24Thpcfe1NZ0NFZmkCfZ3Yj916CursC9MBrtsubZW1jCHJOqxXyFMOc0+dzCwh8LCCy+fpfj3EcExNLt50nd9g2z2G5+50770srTy8DgBL2Vd0WpSmxeRpHrsd7ypGdyCU8VLeH2+9UeIVJn5zg2PSY7txruutubgMMEu0HKcBJqt4zIZK8b6MXLTK2nKocjkyrFAvOFZuoy9X8XKHoPAsgXqfP0aFc0O+qMTx6nVsGjayGRjCdaYdJyzfi7KZlLMCPY7AURdu4e9tG0TQqp3/ubGoR9AXLdIwS1E9koKeD9duCC0ZH5O7X6zEBlPrMclYZZfO3vYNbmffWaGIb5pA7ysbCPr1/fibLMox5pt0lu9Sf6SJBZsXvlqj9UakyZ8qNPzhgGEBsHz/H3Zpt14gP0fT55CkJVtlPIu8V7pKh86EbGhUNr8XK4UtrBaLr3uQq70jgguucXwNb5x+zZwz1yvWrD3Klnai4VrlvmgRUSLsot6XKKgucYhGugnAI5wEAtQ7TA8w3pPK3BExRzpnjdDsWAkOuZgdy2IiZJnN+ozSvtTDgQarv1Hz1D16u7lC+8MIE4zQlY2rGD0s0isNvwFBzV/luGH1rEKrloBR/mD3fuIDFObFanaKcTUTGz9DWqc3CNENs1HAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
    &gt;
      &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        style=&quot;width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;&quot;
        alt=&quot;Logical network headway diagram&quot;
        title=&quot;&quot;
        src=&quot;/static/4063b9bee278a61a87c1f7e293ee1305/8a0db/network-headway-diagram-logical.png&quot;
        srcset=&quot;/static/4063b9bee278a61a87c1f7e293ee1305/bc877/network-headway-diagram-logical.png 148w,
/static/4063b9bee278a61a87c1f7e293ee1305/1880c/network-headway-diagram-logical.png 295w,
/static/4063b9bee278a61a87c1f7e293ee1305/8a0db/network-headway-diagram-logical.png 439w&quot;
        sizes=&quot;(max-width: 439px) 100vw, 439px&quot;
      /&gt;
    &lt;/span&gt;
  &lt;/span&gt;
  
  &lt;/a&gt;
    &lt;/p&gt;
&lt;p&gt;The problem with this is that the number of edges we have in the network has grown. Where before we had 7 edges all holding information in our database (route, time, mode, etc.), we now have 11. This increase of three doesn’t sound big, but the only reason it is small is because I have drawn a very simple network. Despite being simple, this is still coming up against the limits of what I can reasonably convey in an diagram, what with its overlapping lines.&lt;/p&gt;
&lt;p&gt;If instead of 5 stops I had drawn 60 stops, the number of edges now represented would be approximately half of the number of stops squared (see below equation, &lt;span class=&quot;katex&quot;&gt;&lt;span class=&quot;katex-mathml&quot;&gt;&lt;math&gt;&lt;semantics&gt;&lt;mrow&gt;&lt;mi&gt;s&lt;/mi&gt;&lt;/mrow&gt;&lt;annotation encoding=&quot;application/x-tex&quot;&gt;s&lt;/annotation&gt;&lt;/semantics&gt;&lt;/math&gt;&lt;/span&gt;&lt;span class=&quot;katex-html&quot; aria-hidden=&quot;true&quot;&gt;&lt;span class=&quot;base&quot;&gt;&lt;span class=&quot;strut&quot; style=&quot;height:0.43056em;vertical-align:0em;&quot;&gt;&lt;/span&gt;&lt;span class=&quot;mord mathdefault&quot;&gt;s&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt; is the number of stops in the network, per route). For instance, in a 60-stop route, the first stop now has 59 edges leaving from it. The second would have 58, the third 57, and so on. Before we changed to this representation, we had &lt;strong&gt;59&lt;/strong&gt; edges. Now there’s &lt;strong&gt;1770&lt;/strong&gt;. Across an entire transport network of thousands of stops and overlapping routes, where before we had thousands of edges, we now have thousands of millions and you’re looking at moving from a database less than one GB in size to one in the tens of GBs or more, depending on how exactly you choose to structure and aggregate your data.&lt;/p&gt;
&lt;span class=&quot;katex-display&quot;&gt;&lt;span class=&quot;katex&quot;&gt;&lt;span class=&quot;katex-mathml&quot;&gt;&lt;math&gt;&lt;semantics&gt;&lt;mrow&gt;&lt;mtext&gt;number of edges&lt;/mtext&gt;&lt;mo&gt;=&lt;/mo&gt;&lt;mfrac&gt;&lt;mrow&gt;&lt;msup&gt;&lt;mi&gt;s&lt;/mi&gt;&lt;mn&gt;2&lt;/mn&gt;&lt;/msup&gt;&lt;mo&gt;−&lt;/mo&gt;&lt;mi&gt;s&lt;/mi&gt;&lt;/mrow&gt;&lt;mn&gt;2&lt;/mn&gt;&lt;/mfrac&gt;&lt;/mrow&gt;&lt;annotation encoding=&quot;application/x-tex&quot;&gt;\text{number of edges} = \frac{s^{2}-s}{2}&lt;/annotation&gt;&lt;/semantics&gt;&lt;/math&gt;&lt;/span&gt;&lt;span class=&quot;katex-html&quot; aria-hidden=&quot;true&quot;&gt;&lt;span class=&quot;base&quot;&gt;&lt;span class=&quot;strut&quot; style=&quot;height:0.8888799999999999em;vertical-align:-0.19444em;&quot;&gt;&lt;/span&gt;&lt;span class=&quot;mord text&quot;&gt;&lt;span class=&quot;mord&quot;&gt;number of edges&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;mspace&quot; style=&quot;margin-right:0.2777777777777778em;&quot;&gt;&lt;/span&gt;&lt;span class=&quot;mrel&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;mspace&quot; style=&quot;margin-right:0.2777777777777778em;&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;base&quot;&gt;&lt;span class=&quot;strut&quot; style=&quot;height:2.177108em;vertical-align:-0.686em;&quot;&gt;&lt;/span&gt;&lt;span class=&quot;mord&quot;&gt;&lt;span class=&quot;mopen nulldelimiter&quot;&gt;&lt;/span&gt;&lt;span class=&quot;mfrac&quot;&gt;&lt;span class=&quot;vlist-t vlist-t2&quot;&gt;&lt;span class=&quot;vlist-r&quot;&gt;&lt;span class=&quot;vlist&quot; style=&quot;height:1.491108em;&quot;&gt;&lt;span style=&quot;top:-2.314em;&quot;&gt;&lt;span class=&quot;pstrut&quot; style=&quot;height:3em;&quot;&gt;&lt;/span&gt;&lt;span class=&quot;mord&quot;&gt;&lt;span class=&quot;mord&quot;&gt;2&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&quot;top:-3.23em;&quot;&gt;&lt;span class=&quot;pstrut&quot; style=&quot;height:3em;&quot;&gt;&lt;/span&gt;&lt;span class=&quot;frac-line&quot; style=&quot;border-bottom-width:0.04em;&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&quot;top:-3.677em;&quot;&gt;&lt;span class=&quot;pstrut&quot; style=&quot;height:3em;&quot;&gt;&lt;/span&gt;&lt;span class=&quot;mord&quot;&gt;&lt;span class=&quot;mord&quot;&gt;&lt;span class=&quot;mord mathdefault&quot;&gt;s&lt;/span&gt;&lt;span class=&quot;msupsub&quot;&gt;&lt;span class=&quot;vlist-t&quot;&gt;&lt;span class=&quot;vlist-r&quot;&gt;&lt;span class=&quot;vlist&quot; style=&quot;height:0.8141079999999999em;&quot;&gt;&lt;span style=&quot;top:-3.063em;margin-right:0.05em;&quot;&gt;&lt;span class=&quot;pstrut&quot; style=&quot;height:2.7em;&quot;&gt;&lt;/span&gt;&lt;span class=&quot;sizing reset-size6 size3 mtight&quot;&gt;&lt;span class=&quot;mord mtight&quot;&gt;&lt;span class=&quot;mord mtight&quot;&gt;2&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;mspace&quot; style=&quot;margin-right:0.2222222222222222em;&quot;&gt;&lt;/span&gt;&lt;span class=&quot;mbin&quot;&gt;−&lt;/span&gt;&lt;span class=&quot;mspace&quot; style=&quot;margin-right:0.2222222222222222em;&quot;&gt;&lt;/span&gt;&lt;span class=&quot;mord mathdefault&quot;&gt;s&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;vlist-s&quot;&gt;​&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;vlist-r&quot;&gt;&lt;span class=&quot;vlist&quot; style=&quot;height:0.686em;&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;mclose nulldelimiter&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;
&lt;p&gt;This problem is tractable (although takes a bit of crafty SQL) for a schedule or small database of real-time observations. If you want to calculate the average travel time, or headway or some other parameter for each of the millions of edges in this reconfigured network representing several years, you’ve got your work cut out for you. Unfortunately, that’s exactly where I find myself.&lt;/p&gt;
&lt;h2&gt;Problem 3: What is the headway of the last service?&lt;/h2&gt;
&lt;p&gt;Imagine you have a commuter service that is scheduled to arrive at your stop at 7:00 and then 7:30 in the morning. What is the headway? Well, for the 7:00 service, it’s half an hour. That’s fair. But the 7:30 service? Assuming there’s a 7:00 service tomorrow, your headway is 23 hours and 30 minutes, right?&lt;/p&gt;
&lt;p&gt;Plug that in to your script for calculating headways and you now have an average headway of twelve hours. Enjoying your 6 hour wait, average passenger?&lt;/p&gt;
&lt;p&gt;If using headways to get an average waiting time, one would presumably have a ceiling on the waiting time. Especially when the headways are such that you’d be mad or critically uninformed not to check the schedule.&lt;/p&gt;
&lt;p&gt;Why have I never seen this problem mentioned? I don’t see it in the TCQSM. I don’t see it in any academic paper that has used “headway” as though it is something you can touch with your hands.&lt;/p&gt;
&lt;p&gt;Given I’m facing this issue, what do I do? I can’t be the only who has thought about it.&lt;/p&gt;
&lt;h2&gt;Conclusion&lt;/h2&gt;
&lt;p&gt;If I had a nickel for every time I’ve read a paper where someone has constructed a computer model of a public transport network and simply said:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Waiting time is calculated as half of the headway.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;I’d have very many nickels. The headway &lt;strong&gt;of what&lt;/strong&gt;? Have you considered overlapping routes? Did you calculate the headway as a mean or a median? Over what time interval? What did you do if one of the arrivals is the last one for the day?&lt;/p&gt;
&lt;p&gt;Calculating a headway is deceptively simple. If you get into the business of calculating them for whatever purpose, I implore you to clearly state exactly what you did to calculate them. Talk about corner cases. Talk about how you wrote your program to calculate them efficiently as pairs of stops.&lt;/p&gt;
&lt;p&gt;Because I’ll have your head if you tell me that you used “the headway” and leave it at that.&lt;/p&gt;
&lt;h3&gt;Care to weigh in?&lt;/h3&gt;
&lt;p&gt;Have you dealt with calculating headways from schedules or real-time observations of transit arrivals? What issues did you come across? How did you deal with them?&lt;/p&gt;</content:encoded></item><item><title><![CDATA[Commuting and dropping the kids off at school]]></title><description><![CDATA[I have recently been fortunate enough to gain access to the real-time information (RTI) for buses and trains in the Wellington region. This…]]></description><link>https://spatialparalysis.xyz//the-school-run/</link><guid isPermaLink="false">https://spatialparalysis.xyz//the-school-run/</guid><pubDate>Fri, 13 Jun 2014 05:44:17 GMT</pubDate><content:encoded>&lt;p&gt;I have recently been fortunate enough to gain access to the real-time information (RTI) for buses and trains in the Wellington region. This is the information that gets displayed in the box at your bus or train stop giving an estimate of how many minutes until your bus arrives. This information isn’t publicly available as a download or as an API, although you can try your luck looking at &lt;a href=&quot;http://m.metlink.org.nz/stop/5006&quot; title=&quot;Change the number at the end of the URL for a different stop&quot;&gt;the mobile version of the Metlink website&lt;/a&gt;. Building statistics from that is a different thing entirely. I tried to write a program to scrape the information, but you have to look at each stop individually and “Due”, “2 mins”, “3 mins”, etc. isn’t actually very useful beyond catching your service.&lt;/p&gt;
&lt;p&gt;Here is something I whipped up today. It demonstrates not only the travel time variation along a single bus route, but also how the mean travel time changes according to different conditions. In particular, I added information to the dates stored with the data to be able to distinguish trips made on “ordinary” weekdays where people are going to work and school, school holiday weekdays, and weekends.&lt;/p&gt;
&lt;p&gt;
  &lt;figure class=&quot;gatsby-resp-image-figure&quot; style=&quot;&quot;&gt;
  
  &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/ee4078f33ab093eebc4f53579944f0bb/09e95/airport91_ttcomparison.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
  
  &lt;span
    class=&quot;gatsby-resp-image-wrapper&quot;
    style=&quot;position: relative; display: block;  max-width: 590px; margin-left: auto; margin-right: auto;&quot;
  &gt;
    &lt;span
      class=&quot;gatsby-resp-image-background-image&quot;
      style=&quot;padding-bottom: 69.23990498812351%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAsSAAALEgHS3X78AAACEUlEQVQ4y21TiW6bQBDl/38maqJKkdJIldpKlVPVTrFFYmwM5jIYc5jDmGNfd5aACMlIo52dnXlzrlRVFZJzgiiK4LouLMsSchzHw9lzknR2Yz3pqrpCWzeo6xpSWZbwfQ+apsG2bXieBwrStu0HbppmOInrtzuRm0ZYeSak6/U6GPRERoyxDyyA+Qk2mKJqashHEzebOZaB2wH2AEMmk8zYJyBhkWIbeXjQl/hqKNACE+XRgNSXR07Ug3GmPVGAkveJypp7Ou53Mr5sn3Gnr/A3sFCEBuL5I9y1AulyuQgQAiSZehpeMryeHO5s4LezwTdjhTvtGbeajAdLhXyyYUUuknCPQp3Bnn3HXjWRFXwo5/NZgDVtl5kaHnCzXeDefOHOa/xwNSx4jzahDf9koTysOcgTEvknvPkvWC8qkrTuKuFVDEMRJfNzGdiwjzqyg4rSVnAx/iFb/0H2OkOsPOGgLOHtHQRByjPiUx4Nkto3AHJEJFUJY0cAC4Q7FZFlInIdxEGIOMqR5jVqNu4un74YHPsEkJMdOPAtXThR5BbvhtsBsPEGsHcbMgCSwo8D7EyNR2QdDOt4uosCdiQPod62RKzNMfDheo6YMN3pYcykoyooOMm9zVRH/lJRFOI/0iXLMqRpKu4k0wb0f5d0Yz3Z9X85z3MQDq2dNE1d/AQejRyJKYM+y2HReWaUAL1N6T9mEzUca1K5EwAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
    &gt;
      &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        style=&quot;width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;&quot;
        alt=&quot;Travel time data from the Greater Wellington Regional Council (GWRC), for the Airport Flyer (route 91).&quot;
        title=&quot;Travel time data from the Greater Wellington Regional Council, for the &quot;Airport Flyer&quot;.&quot;
        src=&quot;/static/ee4078f33ab093eebc4f53579944f0bb/b6638/airport91_ttcomparison.png&quot;
        srcset=&quot;/static/ee4078f33ab093eebc4f53579944f0bb/60f18/airport91_ttcomparison.png 148w,
/static/ee4078f33ab093eebc4f53579944f0bb/9d7cc/airport91_ttcomparison.png 295w,
/static/ee4078f33ab093eebc4f53579944f0bb/b6638/airport91_ttcomparison.png 590w,
/static/ee4078f33ab093eebc4f53579944f0bb/deb91/airport91_ttcomparison.png 885w,
/static/ee4078f33ab093eebc4f53579944f0bb/990fb/airport91_ttcomparison.png 1180w,
/static/ee4078f33ab093eebc4f53579944f0bb/09e95/airport91_ttcomparison.png 1684w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
      /&gt;
    &lt;/span&gt;
  &lt;/span&gt;
  
  &lt;/a&gt;
    
  &lt;figcaption class=&quot;gatsby-resp-image-figcaption&quot;&gt;Travel time data from the Greater Wellington Regional Council, for the &quot;Airport Flyer&quot;.&lt;/figcaption&gt;
  &lt;/figure&gt;
      &lt;/p&gt;
&lt;p&gt;This data covers all of April 2014. This year, both primary and secondary school holidays began on April 17, and lasted until May 5, so the data is split roughly evenly between weekdays where little Johhny is being ferried to school, and days when he is not. Most of us know from experience that traffic congestion is worse in the school term than in the school holidays. But how much? Well, if we take &lt;a href=&quot;http://www.metlink.org.nz/timetables/bus/091/inbound&quot; title=&quot;Click to see the route&quot;&gt;the Airport Flyer bus route&lt;/a&gt; as a unit of analysis, school-related congestion adds about 14 minutes of travel time across the length of the route. This mostly accrues between Jackson St and Murphy St. For those of you playing at home, that’s the longest stretch between stops at approximately 15 kilometres, and takes in the busiest section of State Highway 2 and the urban motorway. However, from experience as a rider on this route, a lot of this additional travel time comes from Petone (Jackson St/Hutt Rd, attempting to get onto SH2). Also from experience as a resident in Petone, &lt;strong&gt;school congestion is a total time killer&lt;/strong&gt;.&lt;/p&gt;
&lt;div class=&quot;newthought&quot;&gt;
  &lt;h5&gt;What can cause variation in travel time apart from school-related congestion?&lt;/h5&gt;
  &lt;p&gt;
  Influences include: passengers getting on and off; road maintenance; bus driver behaviour; non-school related road congestion; the weather.
  &lt;/p&gt;
&lt;/div&gt;
&lt;p&gt;Now, it is possible to separate out these different effects, although I leave that as an exercise for the reader. I picked only a single month to ensure I’d be comparing apples with apples to the greatest extent possible.&lt;/p&gt;
&lt;p class=&quot;sidenote&quot;&gt;
  Admittedly, April &lt;strong&gt;did&lt;/strong&gt; see a bit of roadworks between Petone and Wellington that would have affected this route. However, this work was being performed just as intensely during the school term and the weekend as for the rest of April—so there is no reason to attribute the difference to that.
&lt;/p&gt;
&lt;p&gt;School children don’t typically board the Airport bus, not only because it goes to the Airport, but because it carries a surcharge. Some amount of variation is perhaps due to buses on this route getting stuck behind the buses on other routes which school children are boarding in the school term, and are not boarding in the holidays.&lt;/p&gt;
&lt;p&gt;It’s been noted that New Zealand has seen a significant increase in the proportion of children and teenagers who are driven (or drive themselves) to school. Often the impact on obesity is noted, as well as the opportunity cost of missed early morning exercise which could help boost attention spans.&lt;/p&gt;
&lt;p&gt;However, I have not seen it mentioned how this effects our transport system beyond a general acceptance that congestion is worse. Although I have only shown you one chart, I have played around with displaying the same information for a variety of routes. The typical result for buses is that the mean travel time is greater during the school term than outside of it. In terms of the variation around this mean, every example I have plotted has shown a much greater standard deviation of travel time.&lt;/p&gt;
&lt;h2&gt;Buses take longer and are less dependable&lt;/h2&gt;
&lt;p&gt;What does that mean?&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;It means buses are generally getting &lt;strong&gt;stuck in school traffic&lt;/strong&gt;, causing people to be &lt;strong&gt;later than they otherwise need to be&lt;/strong&gt;, or making people feel they need to leave home earlier than otherwise (to avoid missing the bus).&lt;/li&gt;
&lt;li&gt;It means &lt;strong&gt;buses are more late more often&lt;/strong&gt;.&lt;/li&gt;
&lt;li&gt;It means public transport users have &lt;strong&gt;less certainty about their arrival time&lt;/strong&gt;.&lt;/li&gt;
&lt;li&gt;It means the &lt;strong&gt;schedule becomes less useful as a tool to reduce the amount of time you spend waiting&lt;/strong&gt;.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Notably, the effect is much more limited for rail services, which do not succumb to any of that school-gate SUV madness.&lt;/p&gt;</content:encoded></item><item><title><![CDATA[Global Isochrone Travel Time from London (1881)]]></title><description><![CDATA[Here’s an interesting historical map that turned up on  /r/MapPorn  today. Made by Francis Galton for the Proceedings of the Royal…]]></description><link>https://spatialparalysis.xyz//global-travel-isochrone-1881/</link><guid isPermaLink="false">https://spatialparalysis.xyz//global-travel-isochrone-1881/</guid><pubDate>Fri, 13 Jun 2014 10:33:38 GMT</pubDate><content:encoded>&lt;p&gt;Here’s an interesting historical map that turned up on &lt;a href=&quot;http://www.reddit.com/r/MapPorn/comments/27yfn0/isochronic_passage_chart_for_travelers_global_map/&quot; title=&quot;Link to Reddit thread&quot;&gt;/r/MapPorn&lt;/a&gt; today. Made by Francis Galton for the Proceedings of the Royal Geographic Society in 1881, I find it particularly interesting because it represents the state of international travel only a decade or so after my Scottish and Irish ancestors travelled to New Zealand.&lt;/p&gt;
&lt;p&gt;I know the most about the travelling arrangements of my Scottish ancestors. They travelled with a stop over in Cape Town, South Africa. The &lt;a href=&quot;http://www.ngaiopress.com/blundlst.htm&quot;&gt;Blundell&lt;/a&gt; is the ship my ancestors who share my surname were on, and it arrived in Dunedin apparently 40+ days since it left Scotland. Robert Law, who was three years old (!) when he made the journey, eventually married Jean Harrison, who was also on the Blundell (as a one-year-old!). It is precisely that historical fact that provides a direct link to this content you are reading right now. Never complain about a baby crying on a forty-minute flight.&lt;/p&gt;
&lt;p&gt;
  &lt;figure class=&quot;gatsby-resp-image-figure&quot; style=&quot;&quot;&gt;
  
  &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/81378ada46a2618f3fc762da34333d50/c5e35/global-isochrone-travel-time-from-london-1881.jpg&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
  
  &lt;span
    class=&quot;gatsby-resp-image-wrapper&quot;
    style=&quot;position: relative; display: block;  max-width: 590px; margin-left: auto; margin-right: auto;&quot;
  &gt;
    &lt;span
      class=&quot;gatsby-resp-image-background-image&quot;
      style=&quot;padding-bottom: 65.41484716157206%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAANABQDASIAAhEBAxEB/8QAGAAAAgMAAAAAAAAAAAAAAAAAAAMBAgT/xAAWAQEBAQAAAAAAAAAAAAAAAAABAAL/2gAMAwEAAhADEAAAAdy3TlSXC//EABkQAAIDAQAAAAAAAAAAAAAAAAABEBESIf/aAAgBAQABBQKu2xGIyf/EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8BP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8BP//EABgQAAIDAAAAAAAAAAAAAAAAAAEQACEx/9oACAEBAAY/ArMK1//EABkQAAMBAQEAAAAAAAAAAAAAAAABETFhcf/aAAgBAQABPyF+ooNvKwSrTVdLYS3pCw//2gAMAwEAAgADAAAAENf/AP/EABYRAQEBAAAAAAAAAAAAAAAAAAARIf/aAAgBAwEBPxC1r//EABYRAQEBAAAAAAAAAAAAAAAAAAEAEf/aAAgBAgEBPxDDZS//xAAcEAEAAwACAwAAAAAAAAAAAAABABEhMUFRcdH/2gAIAQEAAT8QpLYUHjfsQaAwANPcQVrfXMKigOhk1RQpFrWORIeLn//Z&apos;); background-size: cover; display: block;&quot;
    &gt;
      &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        style=&quot;width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;&quot;
        alt=&quot;Isochronic passage chart for travellers.&quot;
        title=&quot;Isochronic passage chart for travellers.&quot;
        src=&quot;/static/81378ada46a2618f3fc762da34333d50/2d84b/global-isochrone-travel-time-from-london-1881.jpg&quot;
        srcset=&quot;/static/81378ada46a2618f3fc762da34333d50/f5ba5/global-isochrone-travel-time-from-london-1881.jpg 148w,
/static/81378ada46a2618f3fc762da34333d50/987fc/global-isochrone-travel-time-from-london-1881.jpg 295w,
/static/81378ada46a2618f3fc762da34333d50/2d84b/global-isochrone-travel-time-from-london-1881.jpg 590w,
/static/81378ada46a2618f3fc762da34333d50/d52b4/global-isochrone-travel-time-from-london-1881.jpg 885w,
/static/81378ada46a2618f3fc762da34333d50/c5e35/global-isochrone-travel-time-from-london-1881.jpg 1145w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
      /&gt;
    &lt;/span&gt;
  &lt;/span&gt;
  
  &lt;/a&gt;
    
  &lt;figcaption class=&quot;gatsby-resp-image-figcaption&quot;&gt;Isochronic passage chart for travellers.&lt;/figcaption&gt;
  &lt;/figure&gt;
      &lt;/p&gt;
&lt;p&gt;The work of cartographers past is often so impressive on their own merits (although I suspect the chaff has been cut with time) yet when you also consider the technology that they &lt;em&gt;didn’t&lt;/em&gt; have to make their maps… the mind boggles and you realise that all of use currently practising the skill have it so easy. Really, if work of this calibre could be made then, there are no excuses for bad maps now.&lt;/p&gt;
&lt;p&gt;One particular technique I’d like to draw attention to is the shape of the coastlines. They’re &lt;em&gt;really wobbly&lt;/em&gt;. I suspect this is probably because nice little shapefiles didn’t exist for downloading—but the effect that this has is to express that coastlines are complex features even if that complexity isn’t well known. Rather than generalise coastlines to rather round shapes (which would be fine at this scale, really), they have been deliberately densified.&lt;/p&gt;
&lt;p&gt;Finally:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;It is supposed that local preparations have been made and that other circumstances are favourable.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;I love this. These kind of assumptions have been made for over a hundred years in transportation analysis and cartography. Always read the fine print.&lt;/p&gt;</content:encoded></item><item><title><![CDATA[One Day in Montréal]]></title><description><![CDATA[This video of Montréal’s transit system fell across my path today, made by Colin Stewart and Ahmed El-Geneidy at McGill University’s School…]]></description><link>https://spatialparalysis.xyz//montreal-transit-video-critique/</link><guid isPermaLink="false">https://spatialparalysis.xyz//montreal-transit-video-critique/</guid><pubDate>Thu, 12 Jun 2014 05:58:10 GMT</pubDate><content:encoded>&lt;p&gt;This video of Montréal’s transit system fell across my path today, made by Colin Stewart and Ahmed El-Geneidy at McGill University’s School of Urban Planning. I’ve been reading a bit of professor El-Geneidy’s work recently for my own research, and I’ve recently been entertaining the idea of visiting Montréal for an extended period of time once I print a thesis onto a reconstituted tree. Providence?&lt;/p&gt;
&lt;p&gt;&lt;div&gt;
          &lt;div
            class=&quot;gatsby-resp-iframe-wrapper&quot;
            style=&quot;padding-bottom: 50%; position: relative; height: 0; overflow: hidden;margin-bottom: 1.0725rem&quot;
          &gt;
            &lt;div&gt;&lt;iframe src=&quot;http://www.youtube.com/embed/1ztMm5xmk3M&quot; style=&quot;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
          &quot;&gt;&lt;/iframe&gt;&lt;/div&gt;
          &lt;/div&gt;
          &lt;/div&gt;&lt;/p&gt;
&lt;p&gt;The video shows 24 hours of transit for the Société de transport de Montréal (STM), from 4:30 in the morning. It drills down to the level of individual scheduled trips. It distinguishes between the green, orange, yellow and blue metro lines as well as buses operating every ten minutes
(the purple points) and “regular” buses (white).&lt;/p&gt;
&lt;p&gt;It is presented on quite a high-resolution basemap, with plenty of attendant information.&lt;/p&gt;
&lt;p&gt;While it is an interesting look at the network operation, there are a handful of problems I have with this video that anyone reading may like to think about if they are to make their own animation.&lt;/p&gt;
&lt;p&gt;Note: if you’re content with just looking at the cool flashing lights (and it is cool!) don’t bother reading on. I’m going to focus on the negatives and leave the positives as self-evident. Oh, I’m such an optimistic young fellow.&lt;/p&gt;
&lt;h2&gt;Critique&lt;/h2&gt;
&lt;p&gt;Firstly, the information given in the video margins is a little overbearing, and isn’t even what I would consider to be the most important information. We are not told what day of the week is represented (weekday schedules are typically different from Saturday and Sunday schedules), or where the data is from. Even in the video description, we have no link to further information. It almost seems as though it is a recruitment device for transit buffs to hit McGill’s website. Which worked for me, let it be known, but I’d still like some more information on how this was constructed—especially if it is made with open data.&lt;/p&gt;
&lt;p&gt;The margin of the video could be improved if the unnecessary information was removed entirely (and left to text descriptions or the embedding web page) or allowed to fade out after the first 20 or so seconds. Ideally, only time would remain after this introductory period.&lt;/p&gt;
&lt;p&gt;The base map, although nice in isolation, is too distracting. The blue ‘pops’ when it is the least important piece of information on the map. The St. Lawrence River can be used here to give context to the map, but even in this capacity the basemap works against intuition by orienting the map away from north. As a foreigner, I am only vaguely aware of the shape of Montréal, but I still would have recognised it immediately if north was up as per convention. In short, the colours and orientation of the basemap ensure the basemap fails at its primary goal of providing immediate contextual recognition.&lt;/p&gt;
&lt;p&gt;Both colour and size are used to distinguish the types of modes represented, which is appropriate. For the metro lines, the yellow and orange are hard to distinguish on moving objects that (seem?) to share a line, although the use of a track is good. I don’t know if the capacity of a vehicle on the metro is several orders of magnitude greater than a bus, but it probably is, and the relative size of the metro to the buses is appropriate. However I think the metro points are probably a little too big, as they bleed into each other and obscure the bus routes.&lt;/p&gt;
&lt;p&gt;I think the two types of bus should have points of the same size (unless one has a greater per-vehicle capacity), and allow small traces for the vehicles to distinguish the higher frequency in one, which should emerge naturally if they are indeed high-frequency.&lt;/p&gt;
&lt;p&gt;It is also worth asking whether the format is appropriate. Is a video a useful format for presenting this information? The people in the comments seem happy enough, with only one or two pointing out that this shows an idealised system where nothing comes early or late… or arrives with no seats left. Could an interactive data visualisation show the same information with additional value? I think so; particularly in that I’d like to zoom into particular neighbourhoods. I do appreciate, however, that the authors of the video probably did this in their free time, and a video has higher bang for your buck.&lt;/p&gt;
&lt;p&gt;The other in-your-face issue with video as a format is that you’re stuck with the frame rate the authors found most interesting… or bearable given the number of times they must have seen this in preparing it. I’d love to slow it down during the busiest moments, but alas.&lt;/p&gt;
&lt;p&gt;The music! Rarely do you see cartography paired with music, but here it is. Jury’s still out on whether it’s anything more than just a little irritating though.&lt;/p&gt;
&lt;h2&gt;Summary&lt;/h2&gt;
&lt;p&gt;Overall, this is an effective and interesting visualisation, but one that needs a tidy-up around the edges—literally and figuratively.&lt;/p&gt;</content:encoded></item></channel></rss>