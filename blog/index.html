
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Near Improv</title>
  <meta name="author" content="Richard Law">

  
  <meta name="description" content="Some moons ago, I met Pierre Roudier, who works at Landcare Research New Zealand, at a workshop on PostGIS being held at the National Institute for &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://alpha-beta-soup.github.io/blog">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Near Improv" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-51933616-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


  
  <!-- http://samwize.com/2012/09/24/octopress-table-stylesheet/ -->
  <link href="/stylesheets/data-table.css" media="screen, projection" rel="stylesheet" type="text/css" />

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Near Improv</a></h1>
  
    <h2>Visualising transportation in New Zealand and beyond</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:alpha-beta-soup.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/blog/about">About</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/06/01/the-things-you-see-on-a-journey-a-tutorial-on-grass/">The things you see on a journey: a tutorial on GRASS, bash and Leaflet</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-06-01T23:07:10+12:00" pubdate data-updated="true">Jun 1<span>st</span>, 2015</time>
        
           | <a href="/blog/2015/06/01/the-things-you-see-on-a-journey-a-tutorial-on-grass/#disqus_thread"
             data-disqus-identifier="http://alpha-beta-soup.github.io/blog/2015/06/01/the-things-you-see-on-a-journey-a-tutorial-on-grass/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Some moons ago, I met Pierre Roudier, who works at <a href="http://www.landcareresearch.co.nz/home">Landcare Research New Zealand</a>, at a workshop on PostGIS being held at the National Institute for Water and Atmospheric Research (<a href="https://www.niwa.co.nz/">NIWA</a>). I was just getting started on PostGIS at the time, having identified that I was probably going to need it for my masters thesis. The two-day session, led by Digital Mapping Solutions New Zealand (<a href="http://www.mapsolutions.co.nz/">DMSNZ</a>), was brilliant. It gave me just enough of an introduction to PostGIS to realise its capability, and a leg-up to explore the rest on my own. I ended up relying entirely on PostGIS for my masters thesis, and now I swear by PostGIS and PL/pgsql as the solution to most issues calling for a spatial database.</p>

<p>What has this got to do with anything? A few things:</p>

<ol>
<li><p>For the love of all things holy, attend events like these if you can. You meet interesting people, get pizza (I ate kangaroo), and get a kick up the bum to learn new things that, honestly, you wouldn&rsquo;t have bothered learning on your own. (In my case, the only reason I was able to attend was that I&rsquo;d won a small cash prize for talking about my thesis—so you if you&rsquo;re studying, try jump on small opportunities like that, too.)</p></li>
<li><p>Pierre ran a tutorial at the end of the first day on GRASS GIS. It really piqued my interest in GRASS. At the time, I was struggling with a batch viewshed calculation for work using ArcGIS. It was falling over due to the size of the computation. I described the problem to Pierre, and he said that it sounded like something GRASS could do no problem. Problem was, I&rsquo;d never used GRASS. It looked hard and scary: it barely has a GUI. Pierre gave me a headstart on the computation, and I adapted his example to my need. It wasn&rsquo;t actually that bad, once I&rsquo;d seen a complete, straightforward example.</p></li>
<li><p>I realised the value of a gentle introduction to a new technique, that actually fulfills some goal you have in mind.</p></li>
</ol>


<p>This last point is now really important to me. If I&rsquo;m trying to learn something new, it has never truly helped me to open a book or the documentation and work through silly, disconnected examples one by one. I actually have to make something useful for myself. <strong>Solve your own, tangible problem.</strong></p>

<p>Doing this gives you enough motivation to finish, to finish well, and to know when you have finished. It also means you run into a wide variety of problems that your textbooks examples never mention; like, how do you write an iterator in bash?</p>

<h2>What are you going to learn?</h2>

<p>With that said, I&rsquo;d like to gift you, dear reader, with a tutorial on using GRASS, Git, Leaflet, bash, Javascript, CSS and HTML. Yes, all of those. No, not to exhaustion. Rather, I&rsquo;ve written the tutorial that I would like to have found a few months ago. A tutorial that takes a tangible (albeit frivolous) problem to completion, and uses a realistic combination of tools to solve it. You&rsquo;ll see how these separate tools come together, and how you could then take pieces here and there and work on something completely different. That&rsquo;s an effective way to learn, if you invest into the idea of the project.</p>

<p>The end result is this <a href="http://www.nearimprov.com/train-landscapes">interactive map</a>.</p>

<h2>What I can&rsquo;t cover</h2>

<ul>
<li><a href="http://readwrite.com/2013/09/30/understanding-github-a-journey-for-beginners-part-1">Beginning with Git</a>, or fundamental Git concepts. But you&rsquo;ll learn some commands and how to host an interactive map on the Internet for free with Github pages (gh-pages).</li>
<li>Getting started with GRASS (although this won&rsquo;t be a terrible introduction, I&rsquo;m not detailing introductory concepts or using the GUI). Try [<a href="http://grass.osgeo.org/documentation/first-time-users/">1</a>], [<a href="http://grass.osgeo.org/grass70/manuals/helptext.html">2</a>], [<a href="http://grasswiki.osgeo.org/wiki/Quick_wxGUI_tutorial">3</a>].</li>
</ul>


<h2>What do you need?</h2>

<p>If you want to code along, you&rsquo;ll need to install GRASS GIS (6.4 or 7.0). Git is optional; if you&rsquo;re not familiar with it, I&rsquo;d like to just show you how can use it in a little project like this.</p>

<p>I use Ubuntu for my desktop operating system. I don&rsquo;t know how easy GRASS is to install on Windows or Mac, but I like to use the <a href="https://launchpad.net/~ubuntugis/+archive/ubuntu/ubuntugis-unstable">ubuntugis-unstable PPA</a>. This has GRASS 6.4 bundled up. GRASS 7.0 is faster due to the addition of new functions, so use that if you&rsquo;re comfortable. If you&rsquo;re not using a flavour of Linux, look into getting a virtual machine set up&mdash;-it&rsquo;s surprisingly easy and you&rsquo;ll not regret it.</p>

<p>I&rsquo;m also going to have to assume a modicum of familiarity with GIS, and some programming concepts (variables, iteration, functions, etc.). Yet you also need a willingness to learn! I&rsquo;m still learning more about programming every day, even though I now get paid to do it, so if there&rsquo;s anything that I seem to have brushed over, don&rsquo;t feel too shy to ask me to explain it further.</p>

<h1>The problem</h1>

<p>I talked to Pierre about a train trip across the North Island of New Zealand, known as the <em>Overlander</em>. He often takes the train to get to Wellington, and I&rsquo;ve taken the Overlander several times to get between Auckland and Wellington. It is a lot slower than flying (by around 11+ hours), but personally I find it more enjoyable. In addition to your ability to get some solid solo productive time, it is very scenic. Being Spatial Scientists™, Pierre and I discussed how one could go about quantifying the <em>scenic-ness</em>&hellip; <em>scenicity</em>&hellip; the <em>je ne sais quoi</em> of the trip.</p>

<p>To solve this problem, you need to think abstractly about it, and then apply that back to the real problem:</p>

<p><strong>Given a line feature, how can you determine the places that are visible are from the line?</strong></p>

<p>Translated into the vernacular: if you&rsquo;re sitting on the train, what can you see out of the window?</p>

<p>What could be taken into consideration in this case, from a spatial perspective? The most straightforward ideas are:</p>

<ul>
<li>What is the terrain like? (Hills block views of what is behind them.)</li>
<li>How far can you see out the window (<a href="http://en.wikipedia.org/wiki/Horizon#Distance_to_the_horizon">distance to the horizon</a>, coupled with personal eyesight, and atmospheric refraction).</li>
</ul>


<p>The not-so-straighforward, or unresolvable ones:</p>

<ul>
<li>Are you on the left or right side of the train?</li>
<li>Is the train going north or south?</li>
<li>What speed is the train travelling at?</li>
<li>Can you actually see out of the window? Is it dark? Are you asleep? Are there trees in the way? Are there tunnels?</li>
</ul>


<p>Like all good spatial problems, the difficult issues outnumber the tractable ones. <strong>We&rsquo;re just going to be thinking about visibility as determined by the bare terrain, using a constant distance to the horizon.</strong> This (arguably) gives us some measurement of the <em>maximum extent</em> of space that is visible, which could be refined further.</p>

<p>The two most influential decisions are the resolution of our terrain model, which determines blocking, and the distance to the horizon, which in an ideal world considers the curvature of the earth and an observer&rsquo;s elevation.</p>

<h1>Setting up with Git</h1>

<p>Launch your terminal, and navigate to somewhere where we can place a folder of interesting stuff (our project code and input data).</p>

<p><strong>WARNING: the following instruction will cause you to download a lot of information (> 3 GB). Only proceed if you&rsquo;re certain that you want this.</strong></p>

<p>Git clone my GitHub repository with the following command:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>git clone https://github.com/alpha-beta-soup/train-landscapes
</span></code></pre></td></tr></table></div></figure>


<p>This creates a folder called <code>train-landscapes</code> in your current directory, within which the project is &ldquo;cloned&#8221;—duplicated for your local consumption.</p>

<p><em>Pursuant to the above warning, if you don&rsquo;t want to <code>git clone</code>, you can just browse the files on Github, write the scripts out yourself as I go over them, or download files individually. The large download comes from the fact that you&rsquo;d be downloading the tiles that constitute the map we will produce at the end. You should be able to adapt this for your own data with a bit of elbow grease.</em></p>

<p>If you browse my Github repository in your web browser via the link in the <code>git clone</code> command, you&rsquo;ll see that I originally &ldquo;forked&rdquo; this project from Pierre. That is, he started it, and I carried it on with my own changes. Pierre wrote the initial version of the GRASS procedure, targeting GRASS version 7. I adjusted this script, to make it work a bit faster with a larger input and higher resolution raster terrain model. I also made a second version that would work with GRASS 6.4, which is what I was using at the time. That&rsquo;s what&rsquo;s great about Github and open source code generally: being able to take someone else&rsquo;s idea, and use it or run with it.</p>

<h1>After cloning</h1>

<p>There are a few files and folders, if you enter the <code>train-landscapes</code> directory. <code>.gitignore</code> is a text file with the following contents:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>data/hillshade/
</span><span class='line'>*.qgs~
</span></code></pre></td></tr></table></div></figure>


<p>This tells Git to not track files (or changes to files) with the extension <code>.qgs~</code> (which is an automatically-generated backup of a QGIS project file), or anything in the directory <code>data/hillshade/</code> (which is the terrain DEM/hillshade model that I use as input for the analysis).</p>

<p>The hillshade and digital elevation model (DEM) I used for this project are several gigabytes in size; I haven&rsquo;t included them in the project to save you the bandwidth.  The <code>.gitignore</code> file is a handy way to manage issues like this. For following along with this tutorial, you can download any DEM of New Zealand (projected to NZTM NZGD2000) that you have the rights to use. (You can of course pick a region anywhere else in the world.)</p>

<p>We also have <code>README.md</code>, which is the Markdown file that provides the documentation you can see on the front page of the GitHub repository for this project.</p>

<p><code>index.html</code> is where we have a simple webpage displaying a Leaflet map. We&rsquo;ll get to this later.</p>

<p>The directory <code>data</code> contains the input vector features I used for this project: the train and road features that we determine visibility from.</p>

<p>The directory <code>source</code> contains the real work: our project code. We can list its contents from the terminal with the <code>ls</code> command:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>ls <span class="nb">source</span>/*
</span><span class='line'>  generate_los.sh
</span><span class='line'>  generate_los_70.sh
</span><span class='line'>  make_map.js
</span><span class='line'>  obtain_corners.py
</span><span class='line'>  style.css
</span></code></pre></td></tr></table></div></figure>


<p>The <code>generate_los</code> shell scripts (<code>.sh</code>) are files that contain a series of commands that will be understood by GRASS GIS, versions 6.4 and 7. Let&rsquo;s consider them now.</p>

<h1>GRASS and shell scripts</h1>

<p>If you have installed GRASS, you can start it up at the command line by running the appropriate command for your version of GRASS:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>grass64
</span></code></pre></td></tr></table></div></figure>


<p>or</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>grass70
</span></code></pre></td></tr></table></div></figure>


<p>After a short moment, a two-window GUI will open up. GRASS uses some concepts and terminology that are pretty hard to get your head around and are different to other GIS systems, particularly the idea of a &ldquo;mapset&rdquo;. You should be able to use the default, &ldquo;PERMANENT&rdquo; mapset for this tutorial, but I encourage you to look for some other GRASS tutorials that consider making your own mapsets. For now, you can just close or ignore the GUI windows as we will not be using them.</p>

<p>Let&rsquo;s consider the GRASS 6.4 code (a shell script written in bash). Open <code>generate_los.sh</code> in a text editor. To do this with Gedit from the command line:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>gedit <span class="nb">source</span>/generate_los.sh
</span></code></pre></td></tr></table></div></figure>


<p>Browse through the file for a bit.</p>

<p>The very first line is a &ldquo;shebang&rdquo; that just tells the program loader what kind of interpreter to use. Here, we are using bash, as opposed to an alternative UNIX shell, like dash.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#!/bin/bash</span>
</span></code></pre></td></tr></table></div></figure>


<p>After that, we define a function called <code>usage</code>. Usage is called upon when checking inputs to the terminal when the code is executed. The function <code>usage</code> prints out a small bit of documentation for our code, telling a user that one of two possible arguments can be used: <code>-train</code> or <code>-road</code>. Choosing train will make sure the script uses some parameters that apply to traveling by train, and similarly for traveling by road. (<em>Disclaimer: I don&rsquo;t actually know if this is proper practice for writing what is essentially help documentation. I can&rsquo;t imagine it&rsquo;s too far from this.</em>)</p>

<p>The <code>usage</code> function and argument parsing:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>usage<span class="o">()</span> <span class="o">{</span>
</span><span class='line'>   cat <span class="s">&lt;&lt; EOF</span>
</span><span class='line'><span class="s">Usage: generate_los.sh [-train | -road]</span>
</span><span class='line'>
</span><span class='line'><span class="s">-train    perform the viewshed analysis for the train journey</span>
</span><span class='line'><span class="s">-road     perform the viewshed analysis for the road journey</span>
</span><span class='line'><span class="s">EOF</span>
</span><span class='line'>   <span class="nb">exit </span>1
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="o">[</span> <span class="nv">$# </span>-ne 1 <span class="o">]</span>; <span class="k">then</span>
</span><span class='line'>   <span class="c"># Number of arguments</span>
</span><span class='line'>   <span class="c"># If there is more or less than one, do usage()</span>
</span><span class='line'>   usage;
</span><span class='line'><span class="k">fi</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;$1&quot;</span> !<span class="o">=</span> <span class="s2">&quot;-train&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="o">[</span> <span class="s2">&quot;$1&quot;</span> !<span class="o">=</span> <span class="s2">&quot;-road&quot;</span> <span class="o">]</span>; <span class="k">then</span>
</span><span class='line'><span class="k">  </span>usage;
</span><span class='line'><span class="k">fi</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>if [ $# -ne 1 ]; then</code> considers all of the arguments that a user enters alongside the command to execute the GRASS shell script. If the number of arguments is not equal to one (<code>-ne 1</code>), then the condition is reached: run the <code>usage</code> function.</p>

<p><code>usage</code> tells our naïve user that they have to run either (and only one of) these commands at the terminal to get things going:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sh execute_los.sh -train
</span><span class='line'>sh execute_los.sh -road
</span></code></pre></td></tr></table></div></figure>


<p>Failure to do so simply prints an instruction to the terminal, and causes the script to stop with exit code 1 (<code>exit 1</code>), a catch-all for general errors.</p>

<p>If the number of provided arguments is equal to one, we then check if this argument is in the realms of expectation (argument <code>"$1"</code> is <code>-train</code> or <code>-road</code>). If the first argument is not equal to <code>train</code> (<code>"$1" != "-train"</code>) or <code>-road</code>, then <code>usage</code> is triggered again. Otherwise we go on our merry way: setting up some variables according to <code>train</code> or <code>road</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="k">if</span> <span class="o">[</span> <span class="nv">$1</span> <span class="o">=</span> <span class="s2">&quot;-road&quot;</span> <span class="o">]</span>
</span><span class='line'><span class="k">then</span>
</span><span class='line'><span class="k">    </span><span class="nv">LINE_SHP</span><span class="o">=</span><span class="s1">&#39;../data/road/roads.shp&#39;</span> <span class="c"># Roads shapefile</span>
</span><span class='line'>    <span class="nv">PTS_FILE</span><span class="o">=</span><span class="s2">&quot;../data/road/road_points_coords.csv&quot;</span>
</span><span class='line'>    <span class="c"># ^ An intermediate output of this script; coordinates of LINE_SHP</span>
</span><span class='line'>    <span class="nv">ELEV</span><span class="o">=</span>1.2 <span class="c"># Metres above the ground that the observer stands</span>
</span><span class='line'>    <span class="c"># ^ just a guess (note, try include the vehicle, too)</span>
</span><span class='line'>    <span class="nv">OUTFILE</span><span class="o">=</span><span class="s2">&quot;dist_los_car&quot;</span> <span class="c"># Name of final output raster</span>
</span><span class='line'><span class="k">elif</span> <span class="o">[</span> <span class="nv">$1</span> <span class="o">=</span> <span class="s2">&quot;-train&quot;</span> <span class="o">]</span>
</span><span class='line'><span class="k">then</span>
</span><span class='line'>    <span class="c"># We live in a post-shapefile world, baby!</span>
</span><span class='line'>    <span class="nv">LINE_SHP</span><span class="o">=</span><span class="s1">&#39;../data/train/nz-railway-centrelines-topo-150k.gpkg&#39;</span> <span class="c"># Rail geopackage</span>
</span><span class='line'>    <span class="nv">PTS_FILE</span><span class="o">=</span><span class="s2">&quot;../data/train/rail_points_coords.csv&quot;</span>
</span><span class='line'>    <span class="c"># ^ An intermediate output of this script; coordinates of LINE_SHP</span>
</span><span class='line'>    <span class="nv">ELEV</span><span class="o">=</span>2.5 <span class="c"># Metres above the ground that the observer stands</span>
</span><span class='line'>    <span class="c"># ^ just a guess (note, try include the vehicle, too)</span>
</span><span class='line'>    <span class="nv">OUTFILE</span><span class="o">=</span><span class="s2">&quot;dist_los_rail&quot;</span> <span class="c"># Name of final output raster</span>
</span><span class='line'><span class="k">else</span>
</span><span class='line'><span class="k">    </span>usage; <span class="c"># shouldn&#39;t need this</span>
</span><span class='line'><span class="k">fi</span>
</span></code></pre></td></tr></table></div></figure>


<p>We define a number of variables that have global scope for the remainder of the script:</p>

<ul>
<li><p><code>LINE_SHP</code>: A line &ldquo;shape&rdquo;, or vector feature. GRASS is happy accepting a wide variety of vector formats, and we don&rsquo;t even have to specify what they are. In my case, I downloaded both an Esri Shapefile (for the road following State Highway 1 between Auckland and Wellington) and a <a href="https://github.com/opengeospatial/geopackage">GeoPackage</a> (for the main trunk railroad of the North Island). Before running this script, I used QGIS to remove all features from my original dataset that I wasn&rsquo;t interested in. I could have also performed this filtering in GRASS, which would have had the advantage of making it easier to change my region of interest another time.</p></li>
<li><p><code>PTS_FILE</code>: &ldquo;points file&rdquo;, a dataset that will be created in the course of the script&rsquo;s execution, and represents points spaced along our original line features. These points represent all of the viewing opportunities we are going to calculate viewsheds for.</p></li>
<li><p><code>ELEV</code>: GRASS&rsquo;s viewshed tools allow us to set observer heights. That is, if you&rsquo;re trying to determine what you can see from your house, ideally you&rsquo;d account for the fact that your eyes are not at ground level. Importantly, <strong>a train is higher up than a car</strong>, and defining the value of this variable <em>conditionally</em> allows us to be slightly more germane when coming up with the answer to our problem.</p></li>
<li><p><code>OUTFILE</code>: the name of the final output raster that we&rsquo;ll collect up at the end and open to see the result. As we will see, the final output is actually just a GeoTiff (image with a spatial projection). It&rsquo;s handy to have a different name depending on whether we are calculating train or road visibility, as we wouldn&rsquo;t want one to overwrite the other.</p></li>
</ul>


<p>Following the conditional variables, there are some variables that are considered constant regardless of our mode of transport:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">R_DEM</span><span class="o">=</span><span class="s1">&#39;../data/hillshade/nidemreproj&#39;</span> <span class="c"># Elevation DEM</span>
</span><span class='line'><span class="nv">R_RES</span><span class="o">=</span>25 <span class="c"># The resolution of the DEM (metres)</span>
</span><span class='line'><span class="nv">DIST_PTS</span><span class="o">=</span>25 <span class="c"># Ideally the resolution of the DEM</span>
</span><span class='line'><span class="nv">MAX_VIS_DIST</span><span class="o">=</span>30000 <span class="c"># Maximum distance visible</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>DIST_PTS</code> is a really important parameter. It will be used to determine how far our source viewing locations may be from one another. There is no point in this value being smaller than <code>R_RES</code>, because two different points that lie within the same cell of our terrain model will have the same viewable cells.</p>

<p><code>MAX_VIS_DIST</code> is also very important. It defines the maximum distance from one of our viewing spots that can be considered visible to an observer. It is stated in the same units as the projection system uses; which in my case is metres.</p>

<p>Together, these global variables determine the precision of our output, and therefore how much of a computational challenge this can be. Taking this to the extreme, you could look at a sub-metre terrain model, and consider a near-continuous movement of a passenger who can see for miles and miles&hellip; but you&rsquo;d need a supercomputer or a very long time to get your output. And when your output is ready, it would still be subject to many of our original limitations (lack of trees is probably the biggest one). Your output would actually be subject to <a href="http://en.wikipedia.org/wiki/False_precision"><strong>false precision</strong></a>: a very important concept in GIScience.</p>

<p>While testing, I used a <code>MAX_VIS_DIST</code> of only 100 metres, and a <code>DIST_POINTS</code> of thousands of kilometres. This did not give me the actual output I was after, but tested the logic of the code and calculated very quickly even on the real datasets. The parameter values above are the ones that I used when making the real output, which took several days to calculate. This is still a very expensive calculation!</p>

<h2>Modifying <code>MAX_VIS_DIST</code> for GRASS 6.4</h2>

<p>Next up, we are preparing to actually use the command <code>r.los</code> (&ldquo;raster&rdquo;.&ldquo;line of sight&rdquo;). Here GRASS 7.0 has a strong advantage over GRASS 6.4. <a href="http://grass.osgeo.org/grass64/manuals/r.los.html">The documentation for <code>r.los</code></a> states the following:</p>

<blockquote><p>The time to complete the calculation increases dramatically with the region size. Try to keep the columns and rows under 1000.</p></blockquote>

<p>The equivalent GRASS 7.0 command, not available in GRASS 6.4 is <code>r.viewshed</code>, and it does not suffer so.</p>

<p>In order to keep the number of rows and columns in our calculation under 1000, we actually need to adjust the variable <code>MAX_VIS_DIST</code> while considering <code>R_RES</code>, as the two are actually tightly linked. The following commands create a new intermediate variable, <code>POS_VIS_DIST</code> (possible visibility distance), which determines the maximum distance we can possibly define as &ldquo;visible&rdquo; without exceeding the limit of 1000 rows or 1000 columns in our visibility calculation. If <code>POS_VIS_DIST</code> ends up exceeding <code>MAX_VIS_DIST</code>, then we opt for <code>POS_VIS_DIST</code> by setting <code>MAX_VIS_DIST</code> equal to <code>POS_VIS_DIST</code>; otherwise we keep on with our original value of <code>MAX_VIS_DIST</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># r.los takes a long time, and the manual says to keep the number of rows and columns</span>
</span><span class='line'><span class="c">#   &quot;under 1000&quot;. Here we adjust MAX_VIS_DIST by considering the resolution of</span>
</span><span class='line'><span class="c">#   the raster (R_RES), so that there is a maximum of 1000 rows and columns</span>
</span><span class='line'><span class="nv">POS_VIS_DIST</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="s2">&quot;$R_RES * 1000 / 2&quot;</span> | bc -l<span class="k">)</span> <span class="c"># The maximum possible vis dist to use and still have 1000 rows and cols</span>
</span><span class='line'><span class="k">if</span> <span class="o">[</span> 1 -eq <span class="sb">`</span><span class="nb">echo</span> <span class="s2">&quot;$POS_VIS_DIST &lt; $MAX_VIS_DIST&quot;</span> | bc<span class="sb">`</span> <span class="o">]</span>
</span><span class='line'><span class="k">then</span>
</span><span class='line'>  <span class="c"># If the maximum distance r.los can sustain exceeds the user-selected value, override it</span>
</span><span class='line'>  <span class="nb">echo</span> <span class="s2">&quot;\nThe MAX_VIS_DIST parameter has been changed from $MAX_VIS_DIST to $POS_VIS_DIST for performance reasons.\n&quot;</span>
</span><span class='line'>  <span class="nv">MAX_VIS_DIST</span><span class="o">=</span><span class="nv">$POS_VIS_DIST</span>
</span><span class='line'><span class="k">fi</span>
</span></code></pre></td></tr></table></div></figure>


<p>To understand this, we should consider what each line is actually doing.</p>

<p><code>POS_VIS_DIST=$(echo "$R_RES * 1000 / 2" | bc -l)</code> instantiates a variable that is equal to the resolution of the raster, multiplied by 500. This represents how many cells in any direction an observer can &ldquo;look&rdquo; without the number of rows or columns exceeding 1000. <code>bc</code> is a command to access &ldquo;an arbitrary precision calculator language&rdquo; (it calculates numbers). The pipe (<code>|</code>) is a way to connect the output of the left command to the input of the right command.</p>

<p>In the shell you could write:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">POS_VIS_DIST</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="s2">&quot;25 * 1000 /2&quot;</span> | bc -l<span class="k">)</span>
</span><span class='line'><span class="nb">echo</span> <span class="nv">$POS_VIS_DIST</span>
</span></code></pre></td></tr></table></div></figure>


<p>And it would spit out the value of your calculation: 12500</p>

<p>The next piece of logic is to compare this number to our <code>MAX_VIS_DIST</code> to see if it is larger:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="k">if</span> <span class="o">[</span> 1 -eq <span class="sb">`</span><span class="nb">echo</span> <span class="s2">&quot;$POS_VIS_DIST &lt; $MAX_VIS_DIST&quot;</span> | bc<span class="sb">`</span> <span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Consider the following commands:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">v1</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="s2">&quot;10 &lt; 20&quot;</span> | bc -l<span class="k">)</span>
</span><span class='line'><span class="nv">v2</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="s2">&quot;20 &lt; 10&quot;</span> | bc -l<span class="k">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Can you see that we&rsquo;re doing inequality checks? The value of <code>v1</code> is 1, true (10 is less than 20); the value of <code>v2</code> is 0, false (20 is not less than 10). <code>if [ 1 -eq result ]</code> then asks &ldquo;if 1 is equal to result&rdquo;, or more fluidly, &ldquo;if result is true&rdquo;. If it is, then you can see above that we reset <code>MAX_VIS_DIST</code> as it violates our 1000 rows and columns constraint.</p>

<h3>Distance to the horizon</h3>

<p>Now at this point it is a good idea to point out that I have actually picked arbitrary values for <code>MAX_VIS_DIST</code> in this example. There are more robust methods to determine the distance to the visible horizon that depend on the elevation of your position, and the curvature of the earth. The value can actually vary quite markedly. The GRASS documentation offers a nice approximation, but <code>r.los</code> itself does not take into account the curvature of the earth:</p>

<blockquote><p>The curvature of the Earth is not taken into account for these calculations. However, for interest&rsquo;s sake, a handy calculation for distance to the true horizon is approximated by d = sqrt(13*h) where h is the height of the observer in meters (above sea level) and d is the distance to the horizon in km. This may be useful for setting the max_dist value.</p></blockquote>

<p>You could implement this in GRASS with a bit of <code>bc</code> and considering the elevation value of each cell beneath each observer point, but I&rsquo;ll leave that as an exercise for the reader (God I hate that). Consider this a reminder that any proposed solution to a geographic problem can almost always be improved.</p>

<p>A partial solution is to switch to GRASS 7.0—<a href="http://grass.osgeo.org/grass70/manuals/r.viewshed.html"><code>r.viewshed</code></a> allows a <code>-c</code> flag that considers the curvature of the earth better than you could—with reference to the current ellipsoid:</p>

<blockquote><p>By default the elevations are not adjusted for the curvature of the earth. The user can turn this on with flag -c.</p></blockquote>

<p>However this <strong>still</strong> doesn&rsquo;t resolve the problem of determining the actual distance to the horizon. In part, this is because that also depends on atmospheric conditions. For example, on an exceptionally clear day you can just make out Mt Taranaki when standing on the Kāpiti Coast:</p>

<center><img src=../images/taranaki-from-foxton.jpg max-height:100%></center>


<center>[Source](http://www.radiolive.co.nz/View-of-Mt-Taranaki-from-Foxton-Beach/tabid/479/articleID/18197/Default.aspx). Unfortunately I don&#8217;t know whose photo this is, so I could not ask permission to use it; let me know if you have an issue.</center>


<h2>Further preparation for the line of sight calculation</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># Load shapefile into GRASS</span>
</span><span class='line'>v.in.ogr <span class="nv">dsn</span><span class="o">=</span><span class="nv">$LINE_SHP</span> <span class="nv">output</span><span class="o">=</span>line_feature --o --v
</span><span class='line'>
</span><span class='line'><span class="c"># Load elevation raster into GRASS and set it as the computational region</span>
</span><span class='line'>r.in.gdal --o <span class="nv">input</span><span class="o">=</span><span class="nv">$R_DEM</span> <span class="nv">output</span><span class="o">=</span>dem --verbose
</span><span class='line'>
</span><span class='line'><span class="c"># Sample points along line</span>
</span><span class='line'>v.to.points -ivt <span class="nv">in</span><span class="o">=</span>line_feature <span class="nv">out</span><span class="o">=</span>line_feature_points <span class="nv">dmax</span><span class="o">=</span><span class="nv">$DIST_PTS</span> --o --q
</span><span class='line'>
</span><span class='line'><span class="c"># Put point coordinates in text file</span>
</span><span class='line'>v.out.ascii -r <span class="nv">in</span><span class="o">=</span>line_feature_points <span class="nv">fs</span><span class="o">=</span>, --quiet | awk -F <span class="s2">&quot;\&quot;*,\&quot;*&quot;</span> <span class="s1">&#39;{print $1&quot;,&quot;$2}&#39;</span> &gt; <span class="nv">$PTS_FILE</span>
</span><span class='line'>
</span><span class='line'><span class="nv">NPTS</span><span class="o">=</span><span class="sb">`</span>cat <span class="nv">$PTS_FILE</span> | wc -l<span class="sb">`</span>
</span></code></pre></td></tr></table></div></figure>


<p>Try see if you can work out this section of code does. If you have GRASS running in your terminal, you can find out what any given GRASS command does with the following pattern: <code>r.command --help</code>, which is the same pattern for most commands at a UNIX terminal. You can also consult the online help.</p>

<p>To summarise the help documents for the GRASS commands used here:</p>

<ul>
<li><code>v.in.ogr</code>: Convert OGR vector layers to GRASS vector map.</li>
<li><code>r.in.gdal</code>: Import GDAL supported raster file into a binary raster map layer.</li>
<li><code>v.to.points</code>: Create points along input lines in new vector with 2 layers.</li>
<li><code>v.out.ascii</code>: Converts a GRASS binary vector map to a GRASS ASCII vector map.</li>
</ul>


<p>In conjunction with the <code>--help</code> option and my comments, try and work out what exactly these comments are doing for yourself. They represent a stage of data preparation for the next processing step. Remember that the syntax <code>$VARIABLE</code> is a way to access the value of the variable called <code>VARIABLE</code>, we defined several of these near the beginning of the script. If you have any questions, leave a comment.</p>

<h2>Computing viewsheds iteratively</h2>

<p>The general logic of the viewshed calculation is to take a series of points sampled along a line feature, find all places on the terrain model that a person standing on each point can see, and then mosaic each of these together into a final visibility surface. There are ways to make this smarter, such as using the fact that once a cell has been identified as visible from any point, to never bother querying whether it is visible again. I don&rsquo;t explore these, although I might if I ever need to re-use this code (at which point I will make an angry, cryptic tweet about why (?!?!) I didn&rsquo;t do this).</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">echo</span> -n <span class="s2">&quot;\nComputing viewsheds\n&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="nv">COUNTER</span><span class="o">=</span>0
</span><span class='line'><span class="k">while </span><span class="nb">read</span> -r line
</span><span class='line'>  <span class="k">do</span>
</span><span class='line'>
</span><span class='line'><span class="k">  </span><span class="nv">PCT_FLOAT</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="s2">&quot;100*$((COUNTER+1))/$NPTS&quot;</span> | bc -l<span class="k">)</span>
</span><span class='line'>  <span class="nv">PCT</span><span class="o">=</span><span class="sb">`</span><span class="nb">printf</span> <span class="s2">&quot;%0.1f\n&quot;</span> <span class="nv">$PCT_FLOAT</span><span class="sb">`</span>
</span><span class='line'>
</span><span class='line'>  <span class="nb">echo</span> -ne <span class="s2">&quot;Processing $NPTS viewshed instances: \t $PCT % ($COUNTER/$NPTS) \r&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="c"># Set the region to a smaller subset around the current observer point</span>
</span><span class='line'>  <span class="c">#   to speed processing</span>
</span><span class='line'>  <span class="nv">x</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="nv">$line</span> | cut -f1 -d,<span class="k">)</span>
</span><span class='line'>  <span class="nv">y</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="nv">$line</span> | cut -f2 -d,<span class="k">)</span>
</span><span class='line'>  <span class="nv">W</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="s2">&quot;$x-$MAX_VIS_DIST&quot;</span> | bc -l<span class="k">)</span>
</span><span class='line'>  <span class="nv">E</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="s2">&quot;$x+$MAX_VIS_DIST&quot;</span> | bc -l<span class="k">)</span>
</span><span class='line'>  <span class="nv">N</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="s2">&quot;$y+$MAX_VIS_DIST&quot;</span> | bc -l<span class="k">)</span>
</span><span class='line'>  <span class="nv">S</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="s2">&quot;$y-$MAX_VIS_DIST&quot;</span> | bc -l<span class="k">)</span>
</span><span class='line'>  g.region <span class="nv">n</span><span class="o">=</span><span class="nv">$N</span> <span class="nv">s</span><span class="o">=</span><span class="nv">$S</span> <span class="nv">e</span><span class="o">=</span><span class="nv">$E</span> <span class="nv">w</span><span class="o">=</span><span class="nv">$W</span>
</span><span class='line'>
</span><span class='line'>  <span class="c"># Does not overwrite, so SIGINT (Ctrl+C) can be used to interrupt a</span>
</span><span class='line'>  <span class="c">#  long-running process, to be resumed later</span>
</span><span class='line'>  <span class="c">#  (keep parameters constant between runs)</span>
</span><span class='line'>  r.los <span class="nv">input</span><span class="o">=</span>dem <span class="nv">output</span><span class="o">=</span>tmp_los_<span class="k">${</span><span class="nv">COUNTER</span><span class="k">}</span> <span class="nv">coordinate</span><span class="o">=</span><span class="nv">$line</span> <span class="nv">obs_elev</span><span class="o">=</span><span class="nv">$ELEV</span> <span class="nv">max_dist</span><span class="o">=</span><span class="nv">$MAX_VIS_DIST</span> --v
</span><span class='line'>  <span class="nv">COUNTER</span><span class="o">=</span><span class="k">$((</span>COUNTER+1<span class="k">))</span>
</span><span class='line'>
</span><span class='line'><span class="k">done</span> &lt; <span class="nv">$PTS_FILE</span>
</span></code></pre></td></tr></table></div></figure>


<p>We begin by creating a variable, <code>COUNTER</code>, to store our progress through an iteration. Then we start looping. That&rsquo;s actually a bit hard to comprehend, so I&rsquo;ll explain it closely:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="k">while </span><span class="nb">read</span> -r line
</span><span class='line'>  <span class="k">do</span>
</span><span class='line'>  <span class="c"># do something</span>
</span><span class='line'><span class="k">done</span> &lt; <span class="nv">$PTS_FILE</span>
</span></code></pre></td></tr></table></div></figure>


<p>Notice that before this point, <code>line</code> didn&rsquo;t exist. <code>line</code> is actually being defined on the last line of the loop syntax: <code>done &lt; $PTS_FILE</code> pipes the text file <code>$PTS_FILE</code>, representing a sequence of points along a line, into the for loop; each line of the file is then put into a variable called <code>$line</code> that we access during the execution of each loop.</p>

<p>The first thing that gets done in the body of the loop is to return some information to the terminal, reporting on the progress of the loop. See if you now understand enough about <code>bc</code> to see how <code>PCT_FLOAT</code> is the progress of the loop expressed as a percentage value of floating point precision. <code>PCT</code> stores the result rounded to one decimal place.</p>

<h3>GRASS regions</h3>

<p>Next up, we use a bit of black magic to speed up the processing. GRASS uses the concept of &ldquo;regions&rdquo; when running calculations. Every command will consider the current region, and nothing will be done outside of that region. So if you&rsquo;re calculating a viewshed (a very expensive proceedure), and you know the maximum distance that you consider viewable from any point, you can tell GRASS that its region can be as small as that area. Annotated code:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># Set the region to a smaller subset around the current observer point to speed processing</span>
</span><span class='line'><span class="c"># Note that this assumes the source line feature is projected in metres</span>
</span><span class='line'><span class="nv">x</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="nv">$line</span> | cut -f1 -d,<span class="k">)</span> <span class="c"># Get the x coordinate value from line, the current observer point</span>
</span><span class='line'><span class="nv">y</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="nv">$line</span> | cut -f2 -d,<span class="k">)</span> <span class="c"># The corresponding y value</span>
</span></code></pre></td></tr></table></div></figure>


<p>Try <code>cut --help</code> coupled with the clue that <code>$line</code> is comma-delimited, if you don&rsquo;t understand this.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">W</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="s2">&quot;$x-$MAX_VIS_DIST&quot;</span> | bc -l<span class="k">)</span> <span class="c"># x minus the maximum visible distance: the western reach of the region</span>
</span><span class='line'><span class="nv">E</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="s2">&quot;$x+$MAX_VIS_DIST&quot;</span> | bc -l<span class="k">)</span> <span class="c"># x + MAX_VIS_DIST: eastern reach</span>
</span><span class='line'><span class="nv">N</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="s2">&quot;$y+$MAX_VIS_DIST&quot;</span> | bc -l<span class="k">)</span> <span class="c"># y + MAX_VIS_DIST: northern reach</span>
</span><span class='line'><span class="nv">S</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="s2">&quot;$y-$MAX_VIS_DIST&quot;</span> | bc -l<span class="k">)</span> <span class="c"># y - MAX_VIS_DIST: southern reach</span>
</span></code></pre></td></tr></table></div></figure>


<p>Finally, we use this command to actually set the region in each iteration: <code>g.region n=$N s=$S e=$E w=$W</code>. I found that resetting the region each loop was remarkably faster than leaving the region equal to the union of all inputs.</p>

<p>The final section of the loop performs the following:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>r.los <span class="nv">input</span><span class="o">=</span>dem <span class="nv">output</span><span class="o">=</span>tmp_los_<span class="k">${</span><span class="nv">COUNTER</span><span class="k">}</span> <span class="nv">coordinate</span><span class="o">=</span><span class="nv">$line</span> <span class="nv">obs_elev</span><span class="o">=</span><span class="nv">$ELEV</span> <span class="nv">max_dist</span><span class="o">=</span><span class="nv">$MAX_VIS_DIST</span> --v
</span><span class='line'><span class="nv">COUNTER</span><span class="o">=</span><span class="k">$((</span>COUNTER+1<span class="k">))</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>r.los</code> is the command that we&rsquo;re really here for. It takes an input DEM, outputs a raster named <code>tmp_los_</code> plus whatever the counter is up to, a point value (our <code>$line</code> variable), and the observer elevation&hellip; and it goes away and tells us what that observer can see. Well, not really <em>what</em> they can see, more <em>where</em> they can see. The &ldquo;what&rdquo; can come later with some more Spatial Science™. For now, we close the loop and give it its input to set it in motion: <code>done &lt; $PTS_FILE</code>.</p>

<h2>One Viewshed To Rule Them All</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># Set computational region to full extent</span>
</span><span class='line'>g.region -pm <span class="nv">rast</span><span class="o">=</span>dem --verbose
</span><span class='line'>
</span><span class='line'><span class="c"># Combine results in a single map</span>
</span><span class='line'><span class="c">#   (aggregation method doesn&#39;t matter as we use</span>
</span><span class='line'><span class="c">#   this as a boolean mask)</span>
</span><span class='line'><span class="nb">echo</span> <span class="s2">&quot;\nCombining component viewsheds\n&quot;</span>
</span><span class='line'><span class="c"># Loops because otherwise can easily exceed default hard limit of number of</span>
</span><span class='line'><span class="c">#   rasters that can be open at once (1024)</span>
</span><span class='line'><span class="k">for </span>i in <span class="sb">`</span>seq 0 99<span class="sb">`</span>;
</span><span class='line'><span class="k">do</span>
</span><span class='line'>  <span class="c"># Combine a subset of all the viewsheds</span>
</span><span class='line'>  <span class="c"># * is a wildcard for zero or more characters</span>
</span><span class='line'>  <span class="k">if</span> <span class="o">[</span> <span class="nv">$i</span> -le 9 <span class="o">]</span> <span class="c"># If i &lt;= 9</span>
</span><span class='line'>  <span class="k">then</span> <span class="c"># append a 0 to the start of $i</span>
</span><span class='line'>    <span class="nv">PATT</span><span class="o">=</span>tmp_los_*0<span class="nv">$i</span>
</span><span class='line'>    <span class="nv">OUT</span><span class="o">=</span>total_los_0<span class="nv">$i</span>
</span><span class='line'>  <span class="k">else</span> <span class="c"># don&#39;t modify the pattern of $i</span>
</span><span class='line'>    <span class="nv">PATT</span><span class="o">=</span>tmp_los_*<span class="nv">$i</span>
</span><span class='line'>    <span class="nv">OUT</span><span class="o">=</span>total_los_<span class="nv">$i</span>
</span><span class='line'>  <span class="k">fi</span>
</span><span class='line'><span class="k">  </span>r.series <span class="nv">in</span><span class="o">=</span><span class="sb">`</span>g.mlist --q <span class="nb">type</span><span class="o">=</span>rast <span class="nv">pattern</span><span class="o">=</span><span class="nv">$PATT</span> <span class="nv">sep</span><span class="o">=</span>,<span class="sb">`</span> <span class="nv">out</span><span class="o">=</span><span class="nv">$OUT</span> <span class="nv">method</span><span class="o">=</span>sum --o --q
</span><span class='line'><span class="k">done</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now that we have created each of the viewsheds for each of the points we sampled along the road or train line, we want to combine these individual raster layers into a single raster layer.</p>

<p>There is considerable scope for interesting complexity here. For instance, you could combine the results additively, thereby building a surface where each cell has a value from 0 (never seen) to a potentially very large number (seen from many of the points along the route). If you assume that the train travels at a constant speed, this surface would tell you how long you spend looking at any given 25x25 metre grid cell. You could then use this to determine what type of forest you spend more time looking at: native or exotic.</p>

<p>I&rsquo;m going for an easy option: not worrying about how the layers are combined. I want a simple Boolean surface: can a cell be seen at any point in the trip, or can it never be seen? There&rsquo;s no room for ambiguity, and the result is not as useful as the rest of the code allows it to be. But, I don&rsquo;t have a &ldquo;real&rdquo; application for this to matter. If you want to fork the repository again on Github and explore this for yourself, go right ahead!</p>

<p>First, we use <code>g.region</code> to reset the region to the full extent of our input raster layer. Recall that without this command, the region would be stuck at whatever it was in the last iteration of the preceding loop!</p>

<p>Then (after some comments and printing information to stdout) we enter a loop that seems a little unnecessary. If we&rsquo;re combining a bunch of raster layers together all at once, why do we need a loop? The answer is because GRASS 6.4 does not like it if you try and open more than 1024 rasters at any one time. As we would have made thousands of new rasters by this point, we cannot actually combine them all at once; rather we have to do it gingerly, in stages.</p>

<p>Therefore the pseudo-code is to:
1. Start a loop from 0 to 99
2. Get the value of the iterator in the style of 00, 01, 02, &hellip;, 98, 99 (i.e. a leading zero for numbers less than 10).
3. Create a pattern variable (<code>PATT</code>) to store the pattern that our input point-specific viewshed rasters follow if their filename ends with 01, or 02, or whatever the iterator is at. (This will allow us to process roughly 1% of the input rasters in each step.)
4. Perform the actual combination for a subset of the layers matching <code>PATT</code>.</p>

<p><code>r.series</code> is the key command of the above codeblock. It takes as its <code>in</code> parameter a list of layers that is constructed by a second command, <code>g.mlist</code>. `.g.mlist&#8217; is a <strong>very</strong> handy GRASS command. Take a look at its description in its help:</p>

<blockquote><p>Lists available GRASS data base files of the user-specified data type optionally using the search pattern.</p></blockquote>

<p>So when we want to combine only a fraction of our intermediate viewshed rasters at one time, we tell <code>g.mlist</code> to go away and find all layers that match a particular pattern (e.g. all rasters called &ldquo;name_*00&rdquo;, where * is a wildcard—that is, all of our intermediate layers ending in &ldquo;00&rdquo;). <code>r.series</code> then takes this list of layers and combines them with the <code>method</code> we have specified. (I used <code>sum</code>, although as I said I actually ignore this.)</p>

<p>What we&rsquo;re then left with is a series of 99 raster layers, each representing a small part of what will become our finished product. (I realise now that it would be smarter to combine the intermediate layer with the pattern-match layers as part of the above loop&hellip; but at the price of one additional <code>r.series</code> it ain&rsquo;t the end of the world, you pedant.)</p>

<p>So, combine these up into our finished product with another pattern matching exercise:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>r.series <span class="nv">in</span><span class="o">=</span><span class="sb">`</span>g.mlist --q <span class="nb">type</span><span class="o">=</span>rast <span class="nv">pattern</span><span class="o">=</span>total_los_* <span class="nv">sep</span><span class="o">=</span>,<span class="sb">`</span> <span class="nv">out</span><span class="o">=</span>total_los <span class="nv">method</span><span class="o">=</span>sum --o --q
</span></code></pre></td></tr></table></div></figure>


<h2>All that remains is making it pretty and washing our hands!</h2>

<p>You could display the result now if you wanted the map to represent the number of times each cell has been determined as being &ldquo;viewable&rdquo;. I actually like the idea of a binary (viewable/not viewable) surface, where shading can be used to indicate distance from the line feature. So that&rsquo;s what I do. However it may be a little misleading, as distance from the line feature used in the exercise is not technically synonymous with the minimum distance from which it can be seen!</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># Create distance to line_feature map</span>
</span><span class='line'><span class="nb">echo</span> <span class="s2">&quot;\nDetermining distance from features\n&quot;</span>
</span><span class='line'>v.to.rast <span class="nv">in</span><span class="o">=</span>line_feature <span class="nv">out</span><span class="o">=</span>line_feature <span class="nv">use</span><span class="o">=</span>val <span class="nv">val</span><span class="o">=</span>1 --o --q
</span><span class='line'>r.grow.distance -m <span class="nv">input</span><span class="o">=</span>line_feature <span class="nv">distance</span><span class="o">=</span>dist_from_line_feature --o --q
</span></code></pre></td></tr></table></div></figure>


<p>This takes our line feature input and turns it into a raster; it then &ldquo;grows&rdquo; (raster buffers) this line&hellip; how far? To the same size as the entire GRASS region. There is no need to tell GRASS that; and it stores the output surface as a dataset specified by the rather misleading title of <code>distance</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># Use distance to line_feature instead of sum of times seen in the result map</span>
</span><span class='line'><span class="nb">echo</span> <span class="s2">&quot;\nSubstituting number of times seen for distance to cell from line\n&quot;</span>
</span><span class='line'>r.mapcalc <span class="s2">&quot;$OUTFILE = if(total_los, dist_from_line_feature, null())&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here we use a bit of raster calculation (otherwise known as image manipulation) to make a new layer. To put the if statement into human terms: &ldquo;if there is a  non-null value of <code>total_los</code> (i.e. a cell has been identified as visible), substitute its value with the value of the equivalent cell from the layer <code>dist_from_line_feature</code> (a raster surface where each cell knows its minimum distance from the line feature), otherwise make its value null.</p>

<p>The rest should be self-explanatory:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># Write output (as geotiff)</span>
</span><span class='line'>r.out.gdal <span class="nv">input</span><span class="o">=</span><span class="nv">$OUTFILE</span> <span class="nv">output</span><span class="o">=</span>../data/output/<span class="nv">$OUTFILE</span>.tif <span class="nv">format</span><span class="o">=</span>GTiff --o --v
</span><span class='line'>
</span><span class='line'><span class="c"># Clean up, removing the component visibility rasters, only after outputs have been written</span>
</span><span class='line'><span class="nb">echo</span> <span class="s2">&quot;\nDeleting temporary files\n&quot;</span>
</span><span class='line'>g.mremove -f <span class="s2">&quot;tmp_los_*&quot;</span> --q
</span><span class='line'>g.mremove -f <span class="s2">&quot;total_los_*&quot;</span> --q
</span><span class='line'>
</span><span class='line'><span class="nb">echo</span> <span class="s2">&quot;\ngenerate_los.sh complete\n&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>The final output is simply a GeoTiff. Try opening it in QGIS if you have been playing along at home. If you&rsquo;re just reading, then in the <a href="http://www.nearimprov.com/train-landscapes">interactive map</a>, the output GeoTiff is the special coloured layer you see on top of the basemap.</p>

<p>So how do we get to this next stage?</p>

<h2>Making Mapnik tiles with QTiles</h2>

<p>There are a variety of ways to make map tiles. (Don&rsquo;t know what tiles are? That&rsquo;s OK, everyone had to find out at some point. I really liked <a href="http://lyzidiamond.com/leaflet/#0">this introduction</a> by <a href="https://twitter.com/lyzidiamond">Lyzi Diamond</a>.) The simplest method for constructing map tiles, in my opinion, is to use a QGIS plugin called <a href="https://github.com/nextgis/QTiles">QTiles</a>. You can control all your styling and extents with QGIS layers, and then just tell the plugin to go away and make your map tiles.</p>

<p>To find out how to install a QGIS plugin, look <a href="http://www.qgistutorials.com/en/docs/using_plugins.html">here</a>.</p>

<p>The process for our purposes is rather simple.</p>

<ol>
<li><p>The GRASS script spits out a GeoTiff.</p></li>
<li><p>You add that to a QGIS project via the add raster layer button.</p></li>
<li><p>The GRASS script also had access to a vector line feature (as well as creating a CSV point dataset from that). You can add one or both of these via the add vector layer button.</p></li>
<li><p>To add context, add a pre-existing baselayer, or make your own. For example, you could create a colour relief map (hypsometric tint). <a href="https://www.mapbox.com/tilemill/docs/guides/terrain-data/">Mapbox has a good tutorial using more command line GIS</a>, this time GDAL. I just took the easy route (again), and went for a Web Mapping Service (<a href="https://data.linz.govt.nz/p/web-services/">WMS</a>) from the good folk at Landcare Research. Look for the add data button in the sidebar with the tooltip &ldquo;Add WMS/WMST Layer&rdquo;. When it opens, create a new connection using the URL to the Landcare Research WMS: <code>http://maps.scinfo.org.nz/basemaps/wms?</code>. There are a variety of layers you can add (see image); the one I used is called the &ldquo;Landcover Terrain Map&rdquo;.</p></li>
<li><p>Once you&rsquo;ve added this basemap, styled and ordered your layers and are happy with the appearance of your map, install QTiles and fire it up via the menu Plugins > QTiles > QTiles. See the second image below for example parameters. Just be cautious before going ahead with your settings: you are generating exponentially more tiles (i.e. PNG images) for each additional level of zoom (1 is the most zoomed out, 18 is the most zoomed in). I only generated tiles between zoom levels 7 and 13, because I knew I was going to restrict the user to these zoom levels in the end. Allow the tool to run, and you&rsquo;re ready to make a web map.</p></li>
</ol>


<center><img src=../images/LR-example.png max-height:100%></center>


<center>Screenshot from QGIS 2.8, of the Landcare Research WMS.</center>




<center><img src=../images/Qtiles.png max-height:100%></center>


<center>Screenshot from QGIS 2.8, QTiles plugin.</center>


<h2>Making a web-ready map with Leaflet</h2>

<p>There are lots of good tutorials on making webmaps, and I encourage you to explore them. I don&rsquo;t consider myself very good at making them (yet). This is a very simple example, using two tile datasets and allowing the user to switch between them.</p>

<p>First, let&rsquo;s look at the HTML: the webpage that will contain our map. (The map itself is made in a Javascript script.) The HTML is divided into the <code>head</code> and the <code>body</code>.</p>

<p>The head:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;head&gt;</span>
</span><span class='line'>  <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">&quot;utf-8&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>  <span class="nt">&lt;meta</span> <span class="na">http-equiv=</span><span class="s">&quot;X-UA-Compatible&quot;</span> <span class="na">content=</span><span class="s">&quot;IE=edge&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nt">&lt;meta</span> <span class="na">name=</span><span class="s">&quot;viewport&quot;</span> <span class="na">content=</span><span class="s">&quot;width=device-width, initial-scale=1.0&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span> <span class="na">href=</span><span class="s">&quot;http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.css&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>  <span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span> <span class="na">href=</span><span class="s">&quot;./source/style.css&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nt">&lt;meta</span> <span class="na">http-equiv=</span><span class="s">&quot;Content-type&quot;</span> <span class="na">content=</span><span class="s">&quot;text/html; charset=utf-8&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'><span class="nt">&lt;/head&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>This is all pretty standard, if you&rsquo;ve ever hit &ldquo;View Page Source&rdquo; on a webpage. Can you see where we tell the page to read the Leaflet CSS (<code>leaflet.css</code>)? And a custom bit of CSS (<code>style.css</code>)?</p>

<p>Now for the body:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;body&gt;</span>
</span><span class='line'>    <span class="c">&lt;!-- header div --&gt;</span>
</span><span class='line'>    <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;title-text&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>      <span class="nt">&lt;h2&gt;</span>
</span><span class='line'>        Travelling overland between Auckland and Wellington: what can you see?
</span><span class='line'>      <span class="nt">&lt;/h2&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/div&gt;</span>
</span><span class='line'>    <span class="c">&lt;!-- map div --&gt;</span>
</span><span class='line'>    <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;map&quot;</span><span class="nt">&gt;&lt;/div&gt;</span>
</span><span class='line'>    <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
</span><span class='line'>    <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;./source/make_map.js&quot;</span> <span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
</span><span class='line'><span class="nt">&lt;/body&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>We have two <code>div</code> elements in the body, and two scripts. The first <code>div</code> contains the header text you see at the top of the map. The second <code>div</code>, with the ID of <code>"map"</code>, contains our map, although there is very little indication yet that it actually does anything. The clue lies in the two pieces of Javascript that get loaded next. The first is the standard Leaflet Javascript that brings along the functionality of every Leaflet slippy map you&rsquo;ve ever seen. The second is a custom bit of code where we specify our own special map. This bit of code is in the Github repo, and is called <code>make_map.js</code>. Let&rsquo;s take a look at that next.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">carViewshed</span> <span class="o">=</span> <span class="s1">&#39;/data/tiles/car/Mapnik/{z}/{x}/{y}.png&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">trainViewshed</span> <span class="o">=</span> <span class="s1">&#39;/data/tiles/rail/Mapnik/{z}/{x}/{y}.png&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">southWest</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mf">41.722</span><span class="p">,</span><span class="mf">171.748</span><span class="p">],</span>
</span><span class='line'>    <span class="nx">northEast</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mf">36.441</span><span class="p">,</span><span class="mf">179.124</span><span class="p">],</span>
</span><span class='line'>    <span class="nx">bounds</span> <span class="o">=</span> <span class="p">[</span><span class="nx">southWest</span><span class="p">,</span> <span class="nx">northEast</span><span class="p">],</span>
</span><span class='line'>    <span class="nx">attribution</span> <span class="o">=</span> <span class="s1">&#39;Richard Law | \</span>
</span><span class='line'><span class="s1">    Pierre Roudier | \</span>
</span><span class='line'><span class="s1">    Basemap © &lt;a href=&quot;http://maps.scinfo.org.nz/&quot;&gt;Landcare Research&lt;/a&gt; 2014. Contains data sourced from LINZ. Crown Copyright Reserved. &lt;a href=&quot;http://creativecommons.org/licenses/by/3.0/nz/&quot;&gt;CC BY 3.0 NZ&lt;/a&gt; | \</span>
</span><span class='line'><span class="s1">    &lt;a href=&quot;https://koordinates.com/layer/40-nz-road-centrelines-topo-150k/&quot;&gt;LINZ&lt;/a&gt; &lt;a href=&quot;http://creativecommons.org/licenses/by/3.0/nz/&quot;&gt;CC BY 3.0 NZ&lt;/a&gt; | \</span>
</span><span class='line'><span class="s1">    &lt;a href=&quot;http://grass.osgeo.org/&quot;&gt;GRASS GIS&lt;/a&gt;&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">global_min_zoom</span> <span class="o">=</span> <span class="mi">7</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">global_max_zoom</span> <span class="o">=</span> <span class="mi">13</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">var</span> <span class="nx">map</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">L</span><span class="p">.</span><span class="nx">Map</span><span class="p">(</span><span class="s1">&#39;map&#39;</span><span class="p">);</span>
</span><span class='line'><span class="nx">map</span><span class="p">.</span><span class="nx">setView</span><span class="p">([</span><span class="o">-</span><span class="mf">38.6875</span><span class="p">,</span> <span class="mf">176.0694</span><span class="p">],</span> <span class="mi">7</span><span class="p">);</span> <span class="c1">//centre and zoom of map, initially</span>
</span><span class='line'><span class="nx">map</span><span class="p">.</span><span class="nx">setMaxBounds</span><span class="p">(</span><span class="nx">bounds</span><span class="p">);</span>
</span><span class='line'><span class="nx">map</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">minZoom</span> <span class="o">=</span> <span class="nx">global_min_zoom</span><span class="p">;</span>
</span><span class='line'><span class="nx">map</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">maxZoom</span> <span class="o">=</span> <span class="nx">global_max_zoom</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">var</span> <span class="nx">car</span> <span class="o">=</span> <span class="nx">L</span><span class="p">.</span><span class="nx">tileLayer</span><span class="p">(</span><span class="nx">carViewshed</span><span class="p">,</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">attribution</span><span class="o">:</span> <span class="nx">attribution</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">bounds</span><span class="o">:</span> <span class="nx">bounds</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">minZoom</span><span class="o">:</span> <span class="nx">global_min_zoom</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">maxZoom</span><span class="o">:</span> <span class="nx">global_max_zoom</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">tms</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">isBaseLayer</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span><span class='line'>  <span class="c1">//opacity: 0.7,</span>
</span><span class='line'>  <span class="c1">//transparent: true</span>
</span><span class='line'><span class="p">}).</span><span class="nx">addTo</span><span class="p">(</span><span class="nx">map</span><span class="p">);</span> <span class="c1">//default layer, so add to map</span>
</span><span class='line'>
</span><span class='line'><span class="kd">var</span> <span class="nx">train</span> <span class="o">=</span> <span class="nx">L</span><span class="p">.</span><span class="nx">tileLayer</span><span class="p">(</span><span class="nx">trainViewshed</span><span class="p">,</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">attribution</span><span class="o">:</span> <span class="nx">attribution</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">bounds</span><span class="o">:</span> <span class="nx">bounds</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">minZoom</span><span class="o">:</span> <span class="nx">global_min_zoom</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">maxZoom</span><span class="o">:</span> <span class="nx">global_max_zoom</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">tms</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">isBaseLayer</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span><span class='line'>  <span class="c1">//opacity: 0.7,</span>
</span><span class='line'>  <span class="c1">//transparent: true</span>
</span><span class='line'><span class="p">});</span> <span class="c1">//non-default layer, so don&#39;t add to map</span>
</span><span class='line'>
</span><span class='line'><span class="kd">var</span> <span class="nx">viewshedBasemaps</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>    <span class="s2">&quot;Car/bus view&quot;</span><span class="o">:</span> <span class="nx">car</span><span class="p">,</span>
</span><span class='line'>    <span class="s2">&quot;Overlander view&quot;</span><span class="o">:</span> <span class="nx">train</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="nx">L</span><span class="p">.</span><span class="nx">control</span><span class="p">.</span><span class="nx">layers</span><span class="p">(</span><span class="nx">viewshedBasemaps</span><span class="p">).</span><span class="nx">addTo</span><span class="p">(</span><span class="nx">map</span><span class="p">);</span> <span class="c1">// Add the layer control to the map</span>
</span></code></pre></td></tr></table></div></figure>


<p>The first unbroken section of code above creates a bunch of variables. While the <code>var</code> keyword is only used once, it could be used on each line if the commas at the end were omitted. <code>carViewshed</code> and <code>trainViewshed</code> are the relative paths to the folders that contain the tiles we made earlier with QTiles. <code>southWest</code> and <code>northEast</code> are global parameters that I use to constrain the user&rsquo;s ability to move: I only want them to be able to scroll around the North Island&hellip; mostly because that&rsquo;s the only place I&rsquo;ve actually created any map. The variables <code>attribution</code>, if you&rsquo;re paying attention, is the bit of text you see at the bottom of the map. Leaflet is good about using that, and so should you be.</p>

<p>Notice that <code>global_max_zoom</code> and <code>global_min_zoom</code> correspond to the numbers I used in the tile generation step. I didn&rsquo;t make tiles beyond the range 7-13, so I don&rsquo;t let the user zoom beyond that range (otherwise they&rsquo;d see nothing).</p>

<p>I then make a very important variable, <code>map</code>, and set a few of its options:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">map</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">L</span><span class="p">.</span><span class="nx">Map</span><span class="p">(</span><span class="s1">&#39;map&#39;</span><span class="p">);</span>
</span><span class='line'><span class="nx">map</span><span class="p">.</span><span class="nx">setView</span><span class="p">([</span><span class="o">-</span><span class="mf">38.6875</span><span class="p">,</span> <span class="mf">176.0694</span><span class="p">],</span> <span class="mi">7</span><span class="p">);</span> <span class="c1">//centre and zoom of map, initially</span>
</span><span class='line'><span class="nx">map</span><span class="p">.</span><span class="nx">setMaxBounds</span><span class="p">(</span><span class="nx">bounds</span><span class="p">);</span>
</span><span class='line'><span class="nx">map</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">minZoom</span> <span class="o">=</span> <span class="nx">global_min_zoom</span><span class="p">;</span>
</span><span class='line'><span class="nx">map</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">maxZoom</span> <span class="o">=</span> <span class="nx">global_max_zoom</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Later, we will call on this <code>map</code> to actually display (you guessed it) a map.</p>

<p>But first, I need to tell it what it&rsquo;s allowed to display.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">car</span> <span class="o">=</span> <span class="nx">L</span><span class="p">.</span><span class="nx">tileLayer</span><span class="p">(</span><span class="nx">carViewshed</span><span class="p">,</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">attribution</span><span class="o">:</span> <span class="nx">attribution</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">bounds</span><span class="o">:</span> <span class="nx">bounds</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">minZoom</span><span class="o">:</span> <span class="nx">global_min_zoom</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">maxZoom</span><span class="o">:</span> <span class="nx">global_max_zoom</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">tms</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">isBaseLayer</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span><span class='line'>  <span class="c1">//opacity: 0.7,</span>
</span><span class='line'>  <span class="c1">//transparent: true</span>
</span><span class='line'><span class="p">}).</span><span class="nx">addTo</span><span class="p">(</span><span class="nx">map</span><span class="p">);</span> <span class="c1">//default layer, so add to map</span>
</span><span class='line'>
</span><span class='line'><span class="kd">var</span> <span class="nx">train</span> <span class="o">=</span> <span class="nx">L</span><span class="p">.</span><span class="nx">tileLayer</span><span class="p">(</span><span class="nx">trainViewshed</span><span class="p">,</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">attribution</span><span class="o">:</span> <span class="nx">attribution</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">bounds</span><span class="o">:</span> <span class="nx">bounds</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">minZoom</span><span class="o">:</span> <span class="nx">global_min_zoom</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">maxZoom</span><span class="o">:</span> <span class="nx">global_max_zoom</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">tms</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">isBaseLayer</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span><span class='line'>  <span class="c1">//opacity: 0.7,</span>
</span><span class='line'>  <span class="c1">//transparent: true</span>
</span><span class='line'><span class="p">});</span> <span class="c1">//non-default layer, so don&#39;t add to map</span>
</span></code></pre></td></tr></table></div></figure>


<p>I made two tile datasets, for the view from the car and from the train. The syntax for accessing them is naturally quite similar. There are more settings I didn&rsquo;t play with, and I even commented out two that didn&rsquo;t work very well after some experimentation.</p>

<p>Without this next block of code, the map would function, but you would never be able to get to the <code>train</code> tiles. So we add a controller to allow a user to switch between our two sets of map tiles:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">viewshedBasemaps</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>    <span class="s2">&quot;Car/bus view&quot;</span><span class="o">:</span> <span class="nx">car</span><span class="p">,</span>
</span><span class='line'>    <span class="s2">&quot;Overlander view&quot;</span><span class="o">:</span> <span class="nx">train</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="nx">L</span><span class="p">.</span><span class="nx">control</span><span class="p">.</span><span class="nx">layers</span><span class="p">(</span><span class="nx">viewshedBasemaps</span><span class="p">).</span><span class="nx">addTo</span><span class="p">(</span><span class="nx">map</span><span class="p">);</span> <span class="c1">// Add the layer control to the map</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>L</code> refers to Leaflet, and I nutted out this bit of code by reading their excellent documentation. Note that <code>car</code> and <code>train</code> here are the <code>L.tileLayer</code> variables we just defined. We tell Leaflet that we have two tile layers that we want to add to its set of <code>control.layers</code>.</p>

<h2>Add a bit of style and class</h2>

<p>The final bit of work is to add some CSS. Stepping through the below code, we have the style for:</p>

<ol>
<li>The webpage as a whole</li>
<li>The title text you see at the top of the webpage.</li>
<li>The &ldquo;map&rdquo; <code>div</code></li>
<li>The container of the leaflet map, which I have made transparent so that it is white like the rest of the page background.</li>
<li>A style for the layer control so it pops more than the default. I wanted to emphasise the layer selector, as it is really the entire point of making contrasting viewsheds. This bit of CSS is a little complex; the best way to work it out is to fiddle with it.</li>
</ol>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class='css'><span class='line'><span class="nt">html</span><span class="o">,</span> <span class="nt">body</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">height</span><span class="o">:</span> <span class="m">100</span><span class="o">%</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="nf">#title-text</span><span class="p">{</span>
</span><span class='line'>  <span class="k">height</span><span class="o">:</span> <span class="m">8</span><span class="o">%</span><span class="p">;</span>
</span><span class='line'>  <span class="k">width</span><span class="o">:</span> <span class="m">100</span><span class="o">%</span><span class="p">;</span>
</span><span class='line'>  <span class="k">font-family</span><span class="o">:</span> <span class="n">Helvetica</span><span class="p">;</span>
</span><span class='line'>  <span class="k">text-align</span><span class="o">:</span> <span class="k">center</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="nf">#map</span><span class="p">{</span>
</span><span class='line'>   <span class="k">height</span><span class="o">:</span> <span class="m">89</span><span class="o">%</span><span class="p">;</span>
</span><span class='line'>   <span class="k">width</span><span class="o">:</span> <span class="m">100</span><span class="o">%</span><span class="p">;</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c">/* background of leaflet container: transparent */</span>
</span><span class='line'><span class="nc">.leaflet-container</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">background-color</span><span class="o">:</span><span class="n">rgba</span><span class="p">(</span><span class="m">255</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">,</span><span class="m">0</span><span class="o">.</span><span class="m">0</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c">/* custom style for the layer control to make it a bit more obvious */</span>
</span><span class='line'><span class="nc">.leaflet-control-layers-toggle</span><span class="nd">:after</span><span class="p">{</span>
</span><span class='line'>    <span class="k">content</span><span class="o">:</span><span class="s2">&quot;Toggle transport mode&quot;</span><span class="p">;</span>
</span><span class='line'>    <span class="k">color</span><span class="o">:</span><span class="m">#000</span> <span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="nc">.leaflet-control-layers-toggle</span><span class="p">{</span>
</span><span class='line'>    <span class="k">width</span><span class="o">:</span><span class="k">auto</span><span class="p">;</span>
</span><span class='line'>    <span class="k">background-position</span><span class="o">:</span><span class="m">10px</span> <span class="m">50</span><span class="o">%</span> <span class="p">;</span>
</span><span class='line'>    <span class="k">padding</span><span class="o">:</span><span class="m">6px</span><span class="p">;</span>
</span><span class='line'>    <span class="k">padding-left</span><span class="o">:</span><span class="m">40px</span><span class="p">;</span>
</span><span class='line'>    <span class="k">padding-right</span><span class="o">:</span><span class="m">10px</span><span class="p">;</span>
</span><span class='line'>    <span class="k">text-decoration</span><span class="o">:</span><span class="k">none</span><span class="p">;</span>
</span><span class='line'>    <span class="k">line-height</span><span class="o">:</span><span class="m">36px</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Getting the map online</h2>

<p>So, you have used a complex geographic routine to make a cool viewshed for the North Island of New Zealand. You have made a working web map and added some custom flair. How do you show it off? There are lots of ways to host webpages, but since we&rsquo;re using Github, Github is actually a very good option for projects like these.</p>

<p>In any Github project, if you make a branch called <code>gh-pages</code>, some magic happens. <a href="https://pages.github.com/">Github is the authority on the matter</a>. Once you have your username.github.io repository ready, any <em>other</em> repository you make can have a hosted website simply by making a <code>gh-pages</code> branch.</p>

<p>If this branch has an HTML file called <code>index.html</code>, you can then find your special Github-hosted webpage via the URL: <code>https://{username}.github.io/{repository}</code>. If this page happens to contain a map&hellip; then you have a map available on the Internet for the world to see, for free. You just have to be comfortable with the code (and often data) behind it being open to anyone.</p>

<p>You can go one step further and also get a custom domain name, if you want to be able to link to something like <a href="https://www.nearimprov.com/train-landscapes.">https://www.nearimprov.com/train-landscapes.</a></p>

<h1>Wrapping up</h1>

<p>I&rsquo;ve been frustrated many times in the past by the need to patch together a series of tutorials from different authors to actually get my own project off the ground, from data to a finished product. I hope this has been helpful for you to realise something from your own imagination.</p>

<p>If there&rsquo;s any element that you feel needs better explanation, please leave a comment and I&rsquo;ll help you out.</p>

<p>Similarly, if there&rsquo;s anything that you feel is a glaring mistake in my code, point it out, I&rsquo;d love to improve. I&rsquo;m sure I&rsquo;m fallible: Pierre&rsquo;s bash script was the first piece of bash that I&rsquo;d ever read; my changes were my first experience with shell scripts. I&rsquo;ve since found them very useful.</p>

<p>Have fun!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/06/17/what-is-a-headway/">What is a Headway?</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-06-17T08:38:41+12:00" pubdate data-updated="true">Jun 17<span>th</span>, 2014</time>
        
           | <a href="/blog/2014/06/17/what-is-a-headway/#disqus_thread"
             data-disqus-identifier="http://alpha-beta-soup.github.io/blog/2014/06/17/what-is-a-headway/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>A headway, as used in transit planning and modelling, is typically defined as the time
between consecutive services. If you catch a bus that &ldquo;comes every half hour&rdquo;, then
the service you catch has a headway of 30 minutes.</p>

<p>This concept is deceptively simple, and this blog post will explain why. There are
several examples of transit analyses that I have seen that use an incorrect definition
of the headway.</p>

<p>Defining the headway accurately is very important when modelling travel using public
transport because it is used to determine how long we expect passengers will wait.
Taking the example of the bus that comes every thirty minutes: if passengers all turn up
to the stop without considering the schedule (that is, at random), we would expect the
average passenger to be waiting there for a period of time equal to half the headway:
15 minutes.</p>

<p>The Transit Capacity and Quality of Service Manual (<a href="http://onlinepubs.trb.org/onlinepubs/tcrp/tcrp100/part%203.pdf" title="TCQSM 2nd Edition, PDF">TCQSM</a>) has a pretty handy table on
different headway classes and what they mean for waiting passengers. I&rsquo;ve taken this from
the second edition of the TCQSM (rather than the 3rd), because I don&rsquo;t have access to the
3rd edition. I don&rsquo;t know if it has changed (a heads-up if it has would be great).</p>

<table>
<thead>
<tr>
<th align="center">Level of Service (LOS) </th>
<th align="center">  Avg. Headway (min)  </th>
<th align="center">  Vehicles/h  </th>
<th> Comments</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">A </td>
<td align="center"> &lt;10 </td>
<td align="center"> >6 </td>
<td> Passengers do not need schedules</td>
</tr>
<tr>
<td align="center">B </td>
<td align="center"> 10-14 </td>
<td align="center"> 5-6 </td>
<td> Frequent service, passengers consult schedules</td>
</tr>
<tr>
<td align="center">C </td>
<td align="center"> 15-20 </td>
<td align="center"> 3-4 </td>
<td> Maximum desirable time to wait if bus/train missed</td>
</tr>
<tr>
<td align="center">D </td>
<td align="center"> 21-30 </td>
<td align="center"> 2 </td>
<td> Service unattractive to choice riders</td>
</tr>
<tr>
<td align="center">E </td>
<td align="center"> 31-60 </td>
<td align="center"> 1 </td>
<td> Service available during the hour</td>
</tr>
<tr>
<td align="center">F </td>
<td align="center"> >60 </td>
<td align="center"> &lt;1 </td>
<td> Service unattractive to all riders</td>
</tr>
</tbody>
</table>


<p>Stops with LOS A mean that passengers can just up and board their service with barely any waiting.
Stops with LOS F require that passengers take time to plan their arrival at the stop
and probably change their schedules before or after their trip: living their life around the
schedule.</p>

<p>The &ldquo;average headway&rdquo; in the table is the inverse of average frequency.</p>

<p>So far, so good. Headways are the time between vehicles, and are useful as indications
of how frequent a public transport service is, and therefore how long passengers wait.
Average waiting time is complicated by the fact that not all passengers arrive to their
stops at random, but I will not bother you with this for the moment, as this post
is concerned with defining the headway, not waiting time, even if they are related.</p>

<hr />

<h2>Problem 1: Grouped arrivals</h2>

<hr />

<p>If I told you that a particular bus route had a frequency of 3 vehicles per hour,
what would be headway on that route? Well, there&rsquo;s 60 minutes to an hour, and 3 services
in that period. So we have 60/3=20 minute headway.</p>

<p>However what if the schedule (or, you know, reality) had all three of these services arriving
at the same time, perhaps because it is a bus interchange where three routes coincide before
heading their separate ways, or because buses can get caught behind a late service (bunching).
In this case, despite having a frequency of 3 vehicles per hour
(LOS C), your headway could arguably be defined in two ways.</p>

<p>The first is to assume that three services all arriving at once just count as one
arrival. Your headway is then 60 minutes, and LOS E.</p>

<p>The second is to acknowledge that O.K., the schedule says that they arrive at the same
time, but it can&rsquo;t be <em>exactly</em> the same time. Let&rsquo;s say for argument&rsquo;s sake, last
Tuesday they arrived at 7:00 am, 7:01 am, and 7:02 am, and then again at 8 am.
Let&rsquo;s call this Arrival Pattern A.
Your headway as we have so far defined it is one minute for the first bus, one minute for the second,
and 58 minutes for the third. Your average headway in this period is (1+1+58)/3=20 minutes, LOS C.</p>

<p>So we&rsquo;re back at 20 minutes! But hold on, none these buses has a 20 minute headway when considered
as an individual arrival.</p>

<p>This is tricky. What does the TCQSM recommend (p. 3-29)?</p>

<blockquote><p>Some judgment must be applied to bus stops located near timed transfer centers.
There is a considerable difference in service from a passenger’s perspective between a
bus arriving every 10 minutes and three buses arriving in a row from a nearby
transfer center every 30 minutes, even though both scenarios result in six buses per
hour serving the stop. In general, buses on separate routes serving the same
destination that arrive at a stop within 3 minutes of each other should be counted as
one bus for the purposes of determining service frequency LOS.&#8221;</p></blockquote>

<p>As it so happens, the TCQSM therefore
suggests using the first approach, where buses that arrive within three minutes of each other
are considered as one bus. So the 7:00, 7:01 and 7:02 buses would collapse down to some time point
in the range 7:00-7:02. I&rsquo;m not sure what moment exactly should be used within this range.
It may sound picky to be wondering if the representative arrival is 7:00 or 7:02, but
when writing code to calculate these headways for you, you have to make rather precise
decisions. I&rsquo;d guess it&rsquo;d be the average of these values, so 7:01 am.</p>

<p>However, if the buses arrived at 7:00, 7:04, 7:08 and 8:00, we&rsquo;d be back to an average headway
of 20 minutes, and square one. We&rsquo;ll call this Arrival Pattern B.</p>

<h3>Median headway</h3>

<p>This issue is why, when aggregating headways (rather than determining the headways of
particular trips) over an interval of time, the median headway is sometimes used
instead of the average headway. With a median headway, the potential to calculate
a headway that is never exhibited in reality is reduced.</p>

<p>For the two examples given in this section, Arrival Pattern A has a median headway of 1 minute.
Arrival Pattern B has a median headway of 4 minutes.</p>

<p>Hmm. That&rsquo;s not quite right, either, is it? If you were to use this as your headway for
the purposes of determining the average waiting time of a randomly-arriving passenger,
they&rsquo;d be waiting for 0.5 minutes (AP A) or 2 minutes (AP B).</p>

<h3>Is it a problem?</h3>

<p>I got to this point in my thinking and after a bit of time spent smashing my head into
my desk, I asked myself whether it was really a problem if the average headway in Arrival Patterns
A and B can be 60 and 20 minutes, respectively. This seems like a very big difference in headway
(and hence waiting time) for such a small difference in vehicle arrivals.</p>

<p>However, if passengers are arriving uniformly at random over the hour 7:00-8:00,
then the average passenger <em>does</em> indeed wait for -20 minutes in Arrival Pattern B.
In Arrival Pattern A, three minutes, while arbitrary, does seem like a reasonable amount
of time to consider services to be functionally arriving at the same time, given acceptable
levels of variation in arrival time.</p>

<p>That&rsquo;s fine and dandy for little examples like AP A and B above. But what if you
have a major stop where buses typically arrive every minute for the entire hour?
What is the headway? We&rsquo;ll call this Arrival Pattern C. In this case, the frequency-derived measurement of headway
(60 arrivals in 60 minutes, so 1 minute headways) is spot-on.</p>

<p>But the TCQSM just told us that arrivals less than 3 minutes apart should be considered
equivalent to the arrival of only one vehicle. So the 7:00 and 7:01 arrivals are equivalent
to each other. And the 7:01 and the 7:02. And the 7:02 and the 7:03. In fact, taking the
TCQSM&rsquo;s advice to the letter (as code written to solve this problem would naïvely), the
whole pattern of arrivals would be reduced down to one single arrival and a headway of
60 minutes for the 7:00-8:00 period!</p>

<h3>What do you do?</h3>

<p>Thinking about these problems, the most defensible solution I have come up with is
to take the TCQSM&rsquo;s grouping advice, but modify it slightly so we don&rsquo;t avoid that
last incomprehensible travesty. I would <em>bin</em> all arrivals into groups of four minutes.
So for Arrival Pattern C (arrivals every minute for an hour), we&rsquo;d see single arrival
events at 7:00, 7:04, 7:08, 7:12, and so on. 60 arrivals would be reduced to 15,
each with four minute headways. The average and the median headways in this case would
then both be four minutes, with an average waiting time of two minutes.</p>

<p>For AP B (7:00, 7:04, 7:08, and 8:00), no modification of the arrivals is required, and
the average headway is 20 minutes.</p>

<p>For AP A (7:00, 7:01, 7:02, and 8:00), we would modify the arrival pattern to be 7:00 and 8:00, as
the three arrivals near the start of the hour are grouped into the same bin. If there was a
fourth service at 7:03, the pattern would be the same, as well as the average headway (60 minutes). When we
get an additional service at 7:04, our (grouped) arrival pattern becomes 7:00, 7:04, 8:00, and <strong>our average
headway becomes 30 minutes</strong> rather than 60. The median also changes from 60 to 30.</p>

<p>This last case may not seem ideal, but let&rsquo;s recap the possible alternatives.</p>

<ol>
<li>A literal interpretation of the TCQSM has us grouping all of the first five arrivals into
one, leading to only one headway of <strong>60 minutes</strong>.</li>
<li>Without grouping, we&rsquo;d have headways of 1, 1, 1, 1, and 56 minutes, for an average
of <strong>12 minutes</strong>, and a median of 1 minute. Notice that the average headway is the same
as that determined from the frequency per hour (5 arrivals in 60 minutes).</li>
</ol>


<p>Deciding which method to follow is tricky. I don&rsquo;t have a clear favourite; but if forced to pick,
I like the method that uses the bins. It acknowledges the TQCSM&rsquo;s recommendation that
arrivals close in time be considered functionally equivalent, and results in a headway
that falls between the other two estimates derived from alternative interpretations.</p>

<p>From the perspective of someone who has to calculate these values programmatically, it
adds a bit of overhead, particularly over the simple arrivals per hour calculation. However that
calculation does not account for the scheduled arrivals, and I would not recommend it, ever.</p>

<hr />

<h2>Intermission</h2>

<hr />

<p>I apologise that this is a long post; but it&rsquo;s not as simple a problem as it is made out to be.
Here&rsquo;s a cat. Have a bite to eat, flick over to Facebook briefly, but please keep reading, I&rsquo;d
really love to get a different perspective.</p>

<p><span class='caption-wrapper'><img class='caption' src='/images/intermission-kitty.jpg' width='' height='' title=''><span class='caption-text'></span></span></p>

<hr />

<h2>Problem 2: The destination matters</h2>

<hr />

<p>So you&rsquo;re back from your break and here&rsquo;s a surprise. I&rsquo;ve been a little dishonest in my
definition of what a headway is. Well, I&rsquo;ve said a half-truth. The headway <em>is</em> the time
between vehicle arrivals at a stop. However, all arrivals are not equivalent. What matters
is <strong>where they are going</strong>. Let&rsquo;s say we have a network with stops A-E serviced by three different
routes (distinguished by colour and pattern for the colourblind: red is solid, green is dotted, and blue is dashed).</p>

<p><span class='caption-wrapper'><img class='caption' src='/images/network-headway-diagram.png' width='' height='' title=''><span class='caption-text'></span></span></p>

<p>If you&rsquo;re seeking to travel directly from A to D, you don&rsquo;t at all care that there
is a blue line between A and E. So even if a blue line service arrived at A every minute
of every day, it would do you no good to board it (we&rsquo;ll assume you can&rsquo;t walk between any of the stops).
That is, if travelling A-D, your headway is defined only as the headway of the green route.</p>

<p>Now if you&rsquo;re instead travelling A-C, you can choose between the red and the green routes.
Unless these services arrive at A at the same time, your headway (and hence waiting time)
is less than it would be if you were travelling A-D, even though you are waiting at the same stop.
This path A-B-C is a public transport <em>corridor</em> of overlapping routes.</p>

<p>Travelling A-E, you again benefit from the corridor effect, as your line is shared between the blue and the red services.
Note, however, that although these overlapping routes work together to reduce your headway,
you may not necessarily choose to board the first red or blue service that arrives. For instance,
if blue is an express route that travels A-E while red is a slower route that stops at A-B-C-E,
you may be aware that skipping that red bus that just turned up at A in favour of waiting just a little
bit longer for the next blue bus is better, because the blue bus will get you to E in better time.</p>

<p>Given this, what&rsquo;s the headway? If the headway is used as a proxy for waiting time, how
can it account for the presence of express routes that may give people an incentive to wait a little bit
longer for a faster route? Given that you don&rsquo;t <em>know</em> with certainty that the blue bus is
going to turn up quickly enough for your gamble to pay off, what is your expected waiting time?</p>

<p>Further, what about the possibility of taking a green bus to C and then waiting at C for a red
bus to take you all the way to E? Might sound weird given transfers are annoying, but it&rsquo;s
certainly an advantage to have this option if C is more comfortable or well-lit as a place
to wait than is A.</p>

<p>These are very tricky questions with very tricky answers. The key thing to keep in mind, however, is the mantra:
<strong>the destination matters</strong>. To this end, the TCQSM does acknowledge that headways are defined
with respect to a particular destination. By no means has this been clearly stated, however.
To quote their fuller definition (p. 3-29):</p>

<blockquote><p>Service frequency LOS is determined by destination from a given transit stop, as
several routes may serve a given stop, but not all may serve a particular destination.</p></blockquote>

<p>Take home point: a stop served by more than one route with multiple possible destinations
doesn&rsquo;t have a single headway; it has a headway for each possible direct destination from each stop.</p>

<h3>How do you calculate headways when the destination matters?</h3>

<p>An issue here, from the perspective of someone who wants to calculate headways from a published
schedule (e.g. from your local GTFS) or from observation of real-time service arrivals,
is that as soon as we define headways not as one number for each stop, but as one
number for each possible board-egress stop pair, the dimensionality of the problem grows.</p>

<p>Given this blog is ostensibly about transit visualisation, I&rsquo;ll make a diagram for this. This is the exact same sample network as we had before, but now shown in terms of the direct
stop edges that exist. If you&rsquo;re to find the headway of travel A-C, you simply need to look
at the two edges that progress uninterrupted from A to C, and ignore all others. This is convenient.</p>

<p><span class='caption-wrapper'><img class='caption' src='/images/network-headway-diagram-logical.png' width='' height='' title=''><span class='caption-text'></span></span></p>

<p>The problem with this is that the number of edges we have in the network has grown.
Where before we had 7 edges all holding information in our database (route, time, mode, etc.), we
now have 11. This increase of three doesn&rsquo;t sound big, but the only reason it is small is because
I have drawn a very simple network. Despite being simple, this is still coming up against the limits
of what I can reasonably convey in an diagram, what with its overlapping lines.</p>

<p>If instead of 5 stops I had drawn 60 stops, the number of edges now represented would be approximately
half of the number of stops squared (see below equation). For instance, in a 60-stop route, the first stop now has 59 edges leaving from it.
The second would have 58, the third 57, and so on. Before we changed to this representation,
we had <strong>59</strong> edges. Now there&rsquo;s <strong>1770</strong>. Across an entire transport network of
thousands of stops and overlapping routes, where before we had thousands of edges, we now have thousands of millions and you&rsquo;re looking at moving
from a database less than one GB in size to one in the tens of GBs or more, depending on how
exactly you choose to structure and aggregate your data.</p>

<p><img src="http://www.sciweavers.org/tex2img.php?eq=%5Cfrac%7Bstops%5E%7B2%7D%7D%7B2%7D-%28stops-0.5%5Ctimes%20stops%29%7D&amp;bc=White&amp;fc=Black&amp;im=jpg&amp;fs=12&amp;ff=arev&amp;edit=0" alt="equation" /></p>

<p>This problem is tractable (although takes a bit of crafty SQL) for a schedule or small
database of real-time observations. If you want to calculate the average travel time, or headway
or some other parameter for each of the millions of edges in this reconfigured network representing several years,
you&rsquo;ve got your work cut out for you. Unfortunately, that&rsquo;s exactly where I find myself.</p>

<hr />

<h2>Problem 3: What is the headway of the last service?</h2>

<hr />

<p>Imagine you have a commuter service that is scheduled to arrive at your stop at 7:00 and then 7:30
in the morning. What is the headway? Well, for the 7:00 service, it&rsquo;s half an hour. That&rsquo;s fair.
But the 7:30 service? Assuming there&rsquo;s a 7:00 service tomorrow, your headway is 23 hours and 30 minutes,
right?</p>

<p>Plug that in to your script for calculating headways and you now have an average headway
of twelve hours. Enjoying your 6 hour wait, average passenger?</p>

<p>If using headways to get an average waiting time, one would presumably have a ceiling
on the waiting time. Especially when the headways are such that you&rsquo;d be mad or critically uninformed
not to check the schedule.</p>

<p>Why have I never seen this problem mentioned? I don&rsquo;t see it in the TCQSM. I don&rsquo;t see it
in any academic paper that has used &ldquo;headway&rdquo; as though it is something you can touch with your hands.</p>

<p>Given I&rsquo;m facing this issue, what do I do? I can&rsquo;t be the only who has thought about it.</p>

<hr />

<h2>Conclusion</h2>

<hr />

<p>If I had a nickel for every time I&rsquo;ve read a paper where someone
has constructed a computer model of a public transport network and simply said:</p>

<blockquote><p>Waiting time is calculated as half of the headway.</p></blockquote>

<p>I&rsquo;d have very many nickels. The headway <strong>of what</strong>? Have you considered overlapping routes?
Did you calculate the headway as a mean or a median? Over what time interval? What did you
do if one of the arrivals is the last one for the day?</p>

<p>Calculating a headway is deceptively simple. If you get into the business of calculating
them for whatever purpose, I implore you to clearly state exactly what you did to calculate them.
Talk about corner cases. Talk about how you wrote your program to calculate them efficiently
as pairs of stops.</p>

<p>Because I&rsquo;ll have your head if you tell me that you used &ldquo;the headway&rdquo; and leave it at that.</p>

<h3>Care to weigh in?</h3>

<p>Have you dealt with calculating headways from schedules or real-time observations of transit arrivals? What issues did you come across? How did you deal with them?</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/06/13/travel-time-variation/">What does dropping little Johnny off at school mean for commuters?</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-06-13T17:44:17+12:00" pubdate data-updated="true">Jun 13<span>th</span>, 2014</time>
        
           | <a href="/blog/2014/06/13/travel-time-variation/#disqus_thread"
             data-disqus-identifier="http://alpha-beta-soup.github.io/blog/2014/06/13/travel-time-variation/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I have recently been fortunate enough to gain access to the real-time information (RTI)
for buses and trains in the Wellington region. This is the information that gets displayed in the
box at your bus or train stop giving an estimate of how many minutes until your bus arrives.
This information isn&rsquo;t publicly available as a download or as an API, although
you can try your luck looking at <a href="http://m.metlink.org.nz/stop/5006" title="Change the number at the end of the URL for a different stop">the mobile version of the Metlink website</a>.
Building statistics from that is a different thing entirely. I tried to write a
program to scrape the information, but you have to look at each stop individually
and &lsquo;Due&rsquo;, &lsquo;2 mins&rsquo;, &lsquo;3 mins&rsquo;, etc. isn&rsquo;t actually very useful beyond catching your service.</p>

<p>So. Without further ado, here is something I whipped up today. It demonstrates not
only the travel time variation along a single bus route, but also how the mean travel
time changes according to different conditions. In particular, I added information
to the dates stored with the data to be able to distinguish trips made on &lsquo;ordinary&rsquo;
weekdays where people are going to work and school, school holiday weekdays, and weekends.</p>

<p><span class='caption-wrapper'><img class='caption' src='/images/airport91_ttcomparison.png' width='' height='' title='Travel time data from the Greater Wellington Regional Council. Open in new tab for larger.'><span class='caption-text'>Travel time data from the Greater Wellington Regional Council. Open in new tab for larger.</span></span></p>

<p>This data covers all of April 2014. This year, both primary and secondary school holidays
began on April 17, and lasted until May 5, so the data is split roughly evenly between weekdays
where little Johhny is being ferried to school, and days when he is not. Most of us know from
experience that traffic congestion is worse in the school term than in the school holidays.
But how much? Well, if we take <a href="http://www.metlink.org.nz/timetables/bus/091/inbound" title="Click to see the route">the Airport Flyer bus route</a> as a unit of analysis, school-related
congestion adds about 14 minutes of travel time across the length of the route. This mostly accrues between
Jackson St and Murphy St. For those of you playing at home, that&rsquo;s the longest stretch between stops at
approximately 15 kilometres, and takes in the busiest section of State Highway 2 and the
urban motorway. However, from experience as a rider on this route, a lot of this
additional travel time comes from Petone (Jackson St/Hutt Rd, attempting to get
onto SH2). Also from experience as a resident in Petone, <strong>school congestion is a total
time killer</strong>.</p>

<hr />

<h2>What varies?</h2>

<hr />

<p>Now, let&rsquo;s back up a bit, because I can hear a few voices at the back. What can cause
variation in travel time apart from school-related congestion? Here&rsquo;s a list:</p>

<ul>
<li>Passengers getting on and off</li>
<li>Road maintenance</li>
<li>Bus driver behaviour</li>
<li>Non-school related road congestion</li>
<li>Weather</li>
<li>Possibly some other things</li>
</ul>


<p>Now, it is possible to separate out these different effects, although I leave that
as an exercise for the reader. I picked only a single month to ensure I&rsquo;d be comparing
apples with apples to the greatest extent possible. Admittedly, April <strong>did</strong> see a bit of roadworks
between Petone and Wellington that would have affected this route. However, this work
was being performed just as intensely during the school term and the weekend as for the
rest of April&mdash;so there is no reason to attribute the difference to that.</p>

<p>School children don&rsquo;t typically board the Airport bus, not only because it goes to the
Airport, but because it carries a surcharge. Some amount of variation is perhaps due to buses
on this route getting stuck behind the buses on other routes which school children are
boarding in the school term, and are not boarding in the holidays.</p>

<p>It&rsquo;s been noted that New Zealand has seen a significant increase in the proportion
of children and teenagers who are driven (or drive themselves) to school. Often the
impact on obesity is noted, as well as the opportunity cost of missed early morning
exercise which could help boost attention spans.</p>

<p>However, I have not seen it mentioned how this effects our transport system beyond
a general acceptance that congestion is worse. Although
I have only shown you one chart, I have played around with displaying the same information
for a variety of routes. The typical result for buses is that the mean travel time is greater
during the school term than outside of it. In terms of the variation around this mean, every example
I have plotted has shown a much greater standard deviation of travel time.</p>

<p>What does that mean? It means buses are generally getting stuck in school traffic,
causing people to be <strong>later than they otherwise need to be</strong>, or making them leave home earlier than otherwise.
It means <strong>buses are more late more often</strong>; people have <strong>less certainty about their arrival time</strong>, and the <strong>schedule becomes
less and less useful as a tool to reduce the amount of time you spend waiting</strong>.</p>

<p>Notably, the effect is much more limited for rail services, which do not want to put up
with any of that school-gate SUV madness.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/06/13/global-isochrone-travel-time-from-london-1881/">Global Isochrone Travel Time from London (1881)</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-06-13T10:33:38+12:00" pubdate data-updated="true">Jun 13<span>th</span>, 2014</time>
        
           | <a href="/blog/2014/06/13/global-isochrone-travel-time-from-london-1881/#disqus_thread"
             data-disqus-identifier="http://alpha-beta-soup.github.io/blog/2014/06/13/global-isochrone-travel-time-from-london-1881/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Here&rsquo;s an interesting historical map that turned up on <a href="http://www.reddit.com/r/MapPorn/comments/27yfn0/isochronic_passage_chart_for_travelers_global_map/" title="Link to Reddit thread">/r/MapPorn</a> today. Made by
Francis Galton for the Proceedings of the Royal Geographic Society in 1881, I find
it particularly interesting because it represents the state of international travel
only a decade or so after my Scottish and Irish ancestors travelled to New Zealand
(via way of Cape Town, where one of my great-great aunts was born <em>en route</em>).</p>

<p><span class='caption-wrapper'><img class='caption' src='/images/global-isochrone-travel-time-from-london-1881.jpg' width='' height='' title='**Isochronic passage chart for travellers**, showing the shortest number of days journey from London by the quickest through routes and using such further conveyances as are available without unreasonable cost. It is supposed that local preparations have been made and that other circumstances are favourable.'><span class='caption-text'><strong>Isochronic passage chart for travellers</strong>, showing the shortest number of days journey from London by the quickest through routes and using such further conveyances as are available without unreasonable cost. It is supposed that local preparations have been made and that other circumstances are favourable.</span></span></p>

<p>The work of cartographers past is often so impressive on their own merits (although
I suspect the chaff has been cut with time) yet when you also consider the technology
that they <em>didn&rsquo;t</em> have to make their maps&hellip; the mind boggles and you realise that all of use
currently practising the skill have it so easy. Really, if work of this calibre could be made then,
there are no excuses for bad maps now.</p>

<p>One particular technique I&rsquo;d like to draw attention to is the shape of the coastlines.
They&rsquo;re <em>really wobbly</em>. I suspect this is probably because nice little shapefiles didn&rsquo;t
exist for downloading&mdash;-but the effect that this has is to express that coastlines are
complex features even if that complexity isn&rsquo;t well known. Rather than generalise
coastlines to rather round shapes (which would be fine at this scale, really), they
have been deliberately given additional complexity: it&rsquo;s anti-generalisation.</p>

<p>As far as I am aware, this would be quite hard to achieve with modern software. You would have
to first add vertices to existing shapes at not-quite-regular intervals, and then shift
the vertices about to get that head-beach in-out effect.</p>

<p>I also really think the colour distinction between land and water with the same
category value is really nifty, and of course is crucial when the main form of
intercontinental travel is by sea (steam ship). It wouldn&rsquo;t really make sense for
travel <em>par avion</em>, or any other mode.</p>

<p>Finally:</p>

<blockquote><p>It is supposed that local preparations have been made and that other circumstances are favourable.</p></blockquote>

<p>I love this. These kind of assumptions have been made for over a hundred years in
transportation analysis and cartography. I wonder if it will ever be possible to completely
overcome them.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/06/12/montreal-transit/">One day in Montréal</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-06-12T17:58:10+12:00" pubdate data-updated="true">Jun 12<span>th</span>, 2014</time>
        
           | <a href="/blog/2014/06/12/montreal-transit/#disqus_thread"
             data-disqus-identifier="http://alpha-beta-soup.github.io/blog/2014/06/12/montreal-transit/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>This video of Montréal&rsquo;s transit system fell across my path today, made by Colin
Stewart and Ahmed El-Geneidy at McGill University&rsquo;s School of Urban Planning. I&rsquo;ve
been reading a bit of professor El-Geneidy&rsquo;s work recently for my own research, and
I&rsquo;ve recently been entertaining the idea of visiting Montréal for an extended period
of time once I print a thesis onto a reconstituted tree. Providence?</p>

<div class="embed-video-container"><iframe src="http://www.youtube.com/embed/1ztMm5xmk3M" allowfullscreen></iframe></div>


<p>The video shows 24 hours of transit, from 4:30 in the morning for the Société de
transport de Montréal (STM), drilling down to individual scheduled trips. It distinguishes
between the green, orange, yellow and blue metro lines as well as buses operating every ten minutes
(the purple points) and &ldquo;regular&rdquo; buses (white).</p>

<p>It is presented on quite a high-resolution basemap, with plenty of attendant information.</p>

<p>While it is an interesting look at the network operation, there are a handful of
problems I have with this video that anyone reading may like to think about if
they are to make their own animation.</p>

<p>Note: if you&rsquo;re content with just looking at the cool flashing lights (and it is cool!)
don&rsquo;t bother reading on. I&rsquo;m going to focus on the negatives and leave the positives
as self-evident. Oh, I&rsquo;m such an optimistic young fellow.</p>

<hr />

<h2>Critique</h2>

<hr />

<p>Firstly, the information given in the video margins is a little overbearing, and
isn&rsquo;t even what I would consider to be the most important information. We are not
told what day of the week is represented (weekday schedules are typically different
from Saturday and Sunday schedules), or where the data is from. Even in the video
description, we have no link to further information. It almost seems as though
it is a recruitment device for transit buffs to hit McGill&rsquo;s website. Which worked
for me, let it be known, but I&rsquo;d still like some more information on how this was
constructed&mdash;especially if it is made with open data.</p>

<p>The margin of the video could be improved if the unnecessary information was removed
entirely (and left to text descriptions or the embedding web page) or allowed to fade
out after the first 20 or so seconds. Ideally, only time would remain after this
introductory period.</p>

<p>The base map, although nice in isolation, is too distracting. The blue
&lsquo;pops&rsquo; when it is the least important piece of information on the map. The St. Lawrence
River can be used here to give context to the map, but even in this capacity the basemap
works against intuition by orienting the map away from north. As a foreigner, I am
only vaguely aware of the shape of Montréal, but I still would have recognised it
immediately if north was up as per convention. In short, the colours and orientation
of the basemap ensure the basemap fails at its primary goal of providing immediate
contextual recognition.</p>

<p>Both colour and size are used to distinguish the types of modes represented, which
is appropriate. For the metro lines, the yellow and orange are hard to distinguish
on moving objects that (seem?) to share a line, although the use of a track is good.
I don&rsquo;t know if the capacity of a vehicle on the metro is several orders of magnitude
greater than a bus, but it probably is, and the relative size of the metro to the buses
is appropriate. However I think the metro points are probably a little too big, as they
bleed into each other and obscure the bus routes.</p>

<p>I think the two types of bus should have points of the same size (unless one has
a greater per-vehicle capacity), and allow small traces for the vehicles to distinguish
the higher frequency in one, which should emerge naturally if they are indeed high-frequency.</p>

<p>It is also worth asking whether the format is appropriate. Is a video a useful format
for presenting this information? The people in the comments seem happy enough, with
only one or two pointing out that this shows an idealised system where nothing comes
early or late&hellip; or arrives with no seats left. Could an interactive data visualisation
show the same information with additional value? I think so; particularly in that
I&rsquo;d like to zoom into particular neighbourhoods. I do appreciate, however, that
the authors of the video probably did this in their free time, and a video has higher
bang for your buck.</p>

<p>The other in-your-face issue with video as a format is that you&rsquo;re stuck with the
frame rate the authors found most interesting&hellip; or bearable given the number of times
they must have seen this in preparing it. I&rsquo;d love to slow it down during the busiest
moments, but alas.</p>

<p>The music. No comment. Mute it. Yuck.</p>

<hr />

<h2>Summary</h2>

<hr />

<p>Overall, this is an effective and interesting visualisation, but one that needs
a tidy-up around the edges&mdash;literally and figuratively.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/06/08/hello-world/">Hello world</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-06-08T18:24:31+12:00" pubdate data-updated="true">Jun 8<span>th</span>, 2014</time>
        
           | <a href="/blog/2014/06/08/hello-world/#disqus_thread"
             data-disqus-identifier="http://alpha-beta-soup.github.io/blog/2014/06/08/hello-world/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>This is my <em>first post</em> using Octopress and Markdown. Hopefully everything goes to plan!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/07/22/the-problem-with-pingdom/">The problem with Pingdom</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-07-22T19:13:00+12:00" pubdate data-updated="true">Jul 22<span>nd</span>, 2012</time>
        
           | <a href="/blog/2012/07/22/the-problem-with-pingdom/#disqus_thread"
             data-disqus-identifier="http://alpha-beta-soup.github.io/blog/2012/07/22/the-problem-with-pingdom/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content">

<figure class='code'><figcaption><span>Time to be Awesome - awesome.rb </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='rb'><span class='line'><span class="nb">puts</span> <span class="s2">&quot;Awesome!&quot;</span> <span class="k">unless</span> <span class="n">lame</span>
</span></code></pre></td></tr></table></div></figure>


<p><a href="http://www.pingdom.com%20Pingdom">The problem with pingdom.</a></p>

<p>My money&rsquo;s in that office, right? If she start giving me some bullshit about it ain&rsquo;t there, and we got to go someplace else and get it, I&rsquo;m gonna shoot you in the head then and there. Then I&rsquo;m gonna shoot that bitch in the kneecaps, find out where my goddamn money is. She gonna tell me too. Hey, look at me when I&rsquo;m talking to you, motherfucker. You listen: we go in there, and that nigga Winston or anybody else is in there, you the first motherfucker to get shot. You understand?</p>

<blockquote><p>Blockquote is what goes
inside this block here
would you believe that
bullshit?</p></blockquote>

<p>Well, the way they make shows is, they make one show. That show&rsquo;s called a pilot. Then they show that show to the people who make shows, and on the strength of that one show they decide if they&rsquo;re going to make more shows. Some pilots get picked and become television programs. Some don&rsquo;t, become nothing. She starred in one of the ones that became nothing.</p>

<p>The path of the righteous man is beset on all sides by the iniquities of the selfish and the tyranny of evil men. Blessed is he who, in the name of charity and good will, shepherds the weak through the valley of darkness, for he is truly his brother&rsquo;s keeper and the finder of lost children. And I will strike down upon thee with great vengeance and furious anger those who would attempt to poison and destroy My brothers. And you will know My name is the Lord when I lay My vengeance upon thee.</p>

<p>Your bones don&rsquo;t break, mine do. That&rsquo;s clear. Your cells react to bacteria and viruses differently than mine. You don&rsquo;t get sick, I do. That&rsquo;s also clear. But for some reason, you and I react the exact same way to water. We swallow it too fast, we choke. We get some in our lungs, we drown. However unreal it may seem, we are connected, you and I. We&rsquo;re on the same curve, just on opposite ends.</p>

<p>Do you see any Teletubbies in here? Do you see a slender plastic tag clipped to my shirt with my name printed on it? Do you see a little Asian child with a blank expression on his face sitting outside on a mechanical helicopter that shakes when you put quarters in it? No? Well, that&rsquo;s what you see at a toy store. And you must think you&rsquo;re in a toy store, because you&rsquo;re here shopping for an infant named Jeb.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/07/22/intro/">Intro</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-07-22T08:23:00+12:00" pubdate data-updated="true">Jul 22<span>nd</span>, 2012</time>
        
           | <a href="/blog/2012/07/22/intro/#disqus_thread"
             data-disqus-identifier="http://alpha-beta-soup.github.io/blog/2012/07/22/intro/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Testing!</p>

<p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Duis sollicitudin, massa eu vestibulum laoreet, nibh ante vulputate lorem, ac lobortis ante tellus eu mi. Duis sem nisi, luctus at feugiat eget, fringilla ut tellus. Nam a molestie justo. Sed pulvinar est vitae tellus semper tincidunt. Fusce euismod luctus lacus nec placerat. Mauris rutrum scelerisque nulla ut tempor. Nunc porttitor posuere mi, aliquet vehicula lorem feugiat in. Ut ut fermentum risus. Aliquam tincidunt ultricies ante sit amet bibendum. Cras nec sapien odio. Duis posuere congue sem, at congue massa faucibus at.</p>

<p>Integer ut sapien eget nisl auctor faucibus ut fermentum arcu. Nunc rutrum urna non risus congue et tristique felis eleifend. Maecenas blandit est eu mauris aliquam aliquet. Quisque porttitor enim eget risus blandit in mollis orci eleifend. Nam malesuada nulla sed lacus elementum placerat accumsan arcu rhoncus. Phasellus feugiat cursus turpis nec facilisis. Duis eget metus arcu, eget commodo velit. Cum sociis natoque penatibus et magnis dis parturient montes, nascetur ridiculus mus. Integer cursus vulputate enim, vel gravida velit faucibus et. Ut a urna vitae tellus cursus rhoncus. Maecenas at odio eget quam cursus elementum. Aliquam vitae eros quis tellus laoreet accumsan sed id lorem. Suspendisse et rutrum leo. Integer scelerisque vestibulum adipiscing. In posuere, libero ac accumsan suscipit, nulla ligula gravida erat, ut tempor odio erat nec sem. Quisque justo ipsum, adipiscing volutpat varius vitae, blandit eget nisi.</p>

<p>Nullam adipiscing neque ac lacus commodo vitae imperdiet dui sollicitudin. Ut ac nunc augue. Nam at sem ut quam commodo aliquet vitae vitae dui. Vivamus scelerisque felis eget dolor cursus feugiat. Phasellus at dui sed lectus scelerisque pretium. Etiam nec massa ut justo vestibulum fringilla ac vitae urna. Morbi tortor erat, tempus sed consectetur at, elementum nec eros. Vivamus mattis arcu a sapien semper non lacinia eros pretium.</p>

<p>Proin ut hendrerit arcu. Maecenas ullamcorper tristique magna vel mattis. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. Nullam tincidunt euismod viverra. In sit amet neque turpis. Suspendisse ac sapien mi, id blandit purus. Ut tortor turpis, rutrum ac tempor at, accumsan sit amet erat. Etiam ultricies eleifend dolor, eget tempus justo tristique vitae. In hac habitasse platea dictumst. Aliquam eu enim neque.</p>

<p>Morbi massa lorem, viverra non dictum at, malesuada vel nibh. Nam fermentum lobortis varius. Sed a nulla lacus, quis posuere risus. Nunc id urna libero, quis rutrum mi. In gravida felis urna. Praesent nec dolor ac urna tempor fermentum. Curabitur rutrum arcu et lorem volutpat viverra.</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2015/06/01/the-things-you-see-on-a-journey-a-tutorial-on-grass/">The things you see on a journey: a tutorial on GRASS, bash and Leaflet</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/06/17/what-is-a-headway/">What is a Headway?</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/06/13/travel-time-variation/">What does dropping little Johnny off at school mean for commuters?</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/06/13/global-isochrone-travel-time-from-london-1881/">Global Isochrone Travel Time from London (1881)</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/06/12/montreal-transit/">One day in Montréal</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/alpha-beta-soup">@alpha-beta-soup</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'alpha-beta-soup',
            count: 0,
            skip_forks: false,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>



<section class="googleplus googleplus-hidden">
  <h1>
    <a href="https://plus.google.com/+RichardLawNZ?rel=author">
      <img src="http://www.google.com/images/icons/ui/gprofile_button-32.png" width="32" height="32">
      Google+
    </a>
  </h1>
</section>



  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - Richard Law -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'nearimprov';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
